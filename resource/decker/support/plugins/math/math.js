/**
 * A plugin which enables rendering of math equations inside
 * of reveal.js slides. Essentially a thin wrapper for MathJax.
 *
 * @author Hakim El Hattab
 * @author Mario Botsch
 *
 * Initial version by Hakim El Hattab.
 * Modifications by Mario Botsch:
 * - upgrade to MathJax v3
 * - disable math typesetting on each slide change
 * - disable AssistiveMML, since it duplicates math in speaker notes
 * - disable SVG font caches, since it doesn't work in speaker notes
 * - reset menu settings in localStorage
 * - use promise mechanism to ensure that math is typset before PDF print
 * - fix links generated by referencing equations to jump to the slide
 *   containing the referenced equation
 * - inject class=fragment to incrementally show multi-line equations
 *   (if MathJax element in enclosed in div.math-incremental)
 * - define Latex macro \fragment{...} to show equations part-by-part
 * - inject CSS rules to fit equations to their container and to make
 *   Reveal's zoom plugin work on equations.
 */

// reference to Reveal object
let Reveal;

function loadScript(url, callback) {
  const head = document.querySelector("head");
  let script = document.createElement("script");
  script.type = "text/javascript";
  script.id = "MathJax-script";
  script.src = url;

  // Wrapper for callback to make sure it only fires once
  function finish() {
    if (typeof callback === "function") {
      callback.call();
      callback = null;
    }
  }

  script.onload = finish;

  // IE @mbotsch Do we want to keep supporting IE?
  script.onreadystatechange = function () {
    if (this.readyState === "loaded") {
      finish();
    }
  };

  // Normal browsers
  head.appendChild(script);
}

/*
 * Modify links generated by \ref or \eqref, such that they point to the slide
 * containing the referenced equation.
 */
function adjustLinksDocument(doc) {
  for (const item of doc.math) {
    adjustLinksItem(item, doc);
  }
}

function adjustLinksItem(item, doc) {
  const root = item.typesetRoot;
  if (root) {
    const anchors = root.querySelectorAll("a");
    for (const anchor of anchors) {
      const href = anchor.href;
      if (href.baseVal) {
        let label = href.baseVal;
        if (label.includes("#mjx-eqn")) {
          label = decodeURIComponent(label.substring(1));
          const eqn = document.getElementById(label);
          if (eqn) {
            const s = eqn.closest("section");
            if (s) {
              anchor.href.baseVal =
                location.origin + location.pathname + "#" + s.id;
            }
          }
        }
      }
    }
  }
}

/*
 * Render actions to add fragment class to individual rows of a math equation
 * that is enclosed by a math-incremental div, making the rows appear one after
 * the other.
 */
function incrementalDocument(doc) {
  for (const item of doc.math) {
    incrementalItem(item, doc);
  }
}

function incrementalItem(item, doc) {
  const root = item.typesetRoot;
  if (root && root.closest(".math-incremental")) {
    for (let mrow of root.querySelectorAll(
      'g[data-mml-node="mtable"]:first-of-type > g[data-mml-node="mtr"]'
    )) {
      mrow.classList.add("fragment");
    }
    for (let mrow of document.querySelectorAll(
      'g[data-mml-node="mtable"]:first-of-type g[data-mml-node="mlabeledtr"]'
    )) {
      mrow.classList.add("fragment");
    }
  }
}

/*
 * Inject CSS rules that (i) make SVG equations automatically shrink down to
 * fit the enclosing container and (ii) remove pointer events from the
 * equation parts, such that Reveal's zoom plugin work nicely on equations, too.
 */
function injectStyle() {
  const style = document.createElement("style");
  style.textContent = String.raw`
            /* fit equation into container (disable for tables) */
            mjx-container > svg:not(table mjx-container > svg) {
                object-fit: contain;
                max-width: 100%;
            }

            /* don't (dbl)click/zoom SVG interiors */
            mjx-container > svg * {
                pointer-events: none;
            }

            /* eqn refs have to be clickable */
            mjx-container > svg a, 
            mjx-container > svg a * {
                pointer-events: all;
            }
            
            /* always display in print-pdf */
            .print-pdf g.fragment {
              opacity: 1;
            }

            /* always display in handout */
            .handout g.fragment {
              opacity: 1;
            }
        `;
  document.head.append(style);
}

// Is initial a11y mode requested?
const a11y = /a11y/gi.test(window.location.search);

const Plugin = {
  id: "math",

  init: (deck) => {
    Reveal = deck;

    // get configuration, built MathJax URL
    const options = Reveal.getConfig().math || {};
    if (!options.mathjax) {
      console.error(
        "No MathJax source URI has been configured. This should not happen!",
        "The config.math.mathjax value is usually configured in your resource pack's 'deck.html'",
        "Please contact the developers: https://github.com/decker-edu/decker"
      );
      return;
    }
    const url = options.mathjax + "tex-svg.js";
    // const url = "https://cdn.jsdelivr.net/npm/mathjax@4.0.0-beta.4/tex-svg.js";

    // define \fragment{...} funtion
    let macros = { fragment: ["\\class{fragment}{#1}", 1] };
    // add user-defined Latex macros
    if (options.macros) {
      macros = Object.assign(macros, options.macros);
    }

    // configure through global MathJax object
    window.MathJax = {
      startup: {
        // These startup and pageReady callbacks are part of workarounds to know issues with MathJax 4.0.0-beta4
        // and should be removed once confirmed resolved in the next beta release
        ready: () => {
          const { CommonWrapper } = MathJax._.output.common.Wrapper;
          const getBreakNode = CommonWrapper.prototype.getBreakNode;
          CommonWrapper.prototype.getBreakNode = function (bbox) {
            if (!bbox.start) return [this, null];
            return getBreakNode.call(this, bbox);
          };
          window.MathJax.startup.defaultReady();
        },
        pageReady() {
          const CONFIG = MathJax.config.startup;
          const output = MathJax.config.output;
          return (
            CONFIG.loadAllFontFiles && output.font
              ? output.font.loadDynamicFiles()
              : Promise.resolve()
          ).then(
            CONFIG.typeset && MathJax.typesetPromise
              ? () => MathJax.startup.typesetPromise(CONFIG.elements)
              : Promise.resolve()
          );
        },
      },
      svg: {
        scale: window.Decker.meta.math.scale || 1.0, // global scaling factor for all expressions
        minScale: 0.5, // smallest scaling factor to use
        mtextInheritFont: true, // true to make mtext elements use surrounding font
        merrorInheritFont: true, // true to make merror text use surrounding font
        mathmlSpacing: false, // true for MathML spacing rules, false for TeX rules
        skipAttributes: {}, // RFDa and other attributes NOT to copy to the output
        exFactor: 0.5, // default size of ex in em units
        displayAlign: "center", // default for indentalign when set to 'auto'
        displayIndent: "0", // default for indentshift when set to 'auto'
        fontCache: "none", // or 'global' or 'none'
        localID: null, // ID to use for local font cache (for single equation processing)
        internalSpeechTitles: true, // insert <title> tags with speech content
        titleID: 0, // initial id number to use for aria-labeledby titles
      },
      tex: {
        tags: "ams",
        inlineMath: [
          // start/end delimiter pairs for in-line math
          ["$", "$"],
          ["\\(", "\\)"],
        ],
        displayMath: [
          // start/end delimiter pairs for display math
          ["$$", "$$"],
          ["\\[", "\\]"],
        ],
        macros: macros,
      },
      options: {
        renderActions: {
          incremental: [1000, incrementalDocument, incrementalItem, false],
          adjustLinks: [1001, adjustLinksDocument, adjustLinksItem, false],
        },
        enableExplorer: a11y,
        menuOptions: {
          settings: {
            explorer: a11y,
          },
        },
        a11y: {
          // If we do not set any initial values on this the menu was bugged in 3.2.2
          backgroundColor: "Green",
          backgroundOpacity: 50,
          foregroundColor: "Black",
          foregroundOpacity: 100,
        },
      },
    };

    injectStyle();

    // use promise mechanism to make sure that math typesetting
    // is performend before Reveal fires ready-event or
    // generates a PDF
    return new Promise((resolve) => {
      // load mathjax script
      loadScript(url, () => {
        window.MathJax.startup.promise.then(() => {
          Reveal.layout();
          resolve();
        });
      });
    });
  },
};

export default Plugin;
