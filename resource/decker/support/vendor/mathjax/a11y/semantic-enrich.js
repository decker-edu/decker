(()=>{"use strict";var t={d:(e,i)=>{for(var a in i)t.o(i,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:i[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{InPlace:()=>w,buildLabel:()=>O,buildSpeech:()=>x,honk:()=>v,ssmlParsing:()=>S});var i={};t.r(i),t.d(i,{GeneratorPool:()=>D});var a={};t.r(a),t.d(a,{EnrichHandler:()=>C,EnrichedMathDocumentMixin:()=>L,EnrichedMathItemMixin:()=>G,enrichVisitor:()=>P});const s=("undefined"!=typeof window?window:global).MathJax._.components.global,r=(s.GLOBAL,s.isObject,s.combineConfig,s.combineDefaults),n=s.combineWithMathJax,o=(s.MathJax,MathJax._.core.MathItem),h=(o.protoItem,o.AbstractMathItem,o.STATE),c=o.newState,l=MathJax._.core.MmlTree.SerializedMmlVisitor,p=(l.toEntity,l.SerializedMmlVisitor),u=MathJax._.util.Options,m=(u.isObject,u.APPEND,u.REMOVE,u.OPTIONS,u.Expandable,u.expandable),d=(u.makeArray,u.keys,u.copy,u.insert,u.defaultOptions,u.userOptions,u.selectOptions,u.selectOptionsFromKeys,u.separateOptions,u.lookup,MathJax._.a11y.sre),b=d.Sre,g=(d.sreReady,d.default),y=["pitch","rate","volume"];function S(t){let e=g.parseDOM(t),i=[],a=[];return f(Array.from(e.childNodes),i,a),[a.join(" "),i]}function f(t,e,i,a={}){for(let s of t)if(3!==s.nodeType){if(1===s.nodeType){let t=s,r=t.tagName;if("speak"===r)continue;if("prosody"===r){f(Array.from(s.childNodes),e,i,E(t,a));continue}switch(r){case"break":e.push({pause:t.getAttribute("time")});break;case"mark":e.push({mark:t.getAttribute("name")});break;case"say-as":let s=t.textContent;e.push(Object.assign({text:s,character:!0},a)),i.push(s)}}}else{let t=s.textContent.trim();t&&(i.push(t),e.push(Object.assign({text:t},a)))}}const M={pitch:(t,e)=>t/100*1,volume:(t,e)=>t/100*.5,rate:(t,e)=>t/100*1};function E(t,e){let i={};for(let a of y)if(t.hasAttribute(a)){let[s,r]=T(t.getAttribute(a));if(!s){i[a]="volume"===a?.5:1;continue}let n=e[a];n=n||("volume"===a?.5:1);let o=M[a](parseInt(r,10),s);i[a]="-"===s?n-o:n+o}return i}const A=/([\+-]?)([0-9]+)%/;function T(t){let e=t.match(A);return e?[e[1],e[2]]:(console.warn("Something went wrong with the prosody matching."),["","100"])}function O(t,e,i,a=" "){if(!t)return"";const s=[t];return e&&s.unshift(e),i&&s.push(i),s.join(a)}function x(t,e="en",i="100"){return S(`<?xml version="1.0"?><speak version="1.1" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="${e}"><prosody rate="${i}%">${t}</prosody></speak>`)}function v(){let t=new AudioContext,e=t.createOscillator();e.frequency.value=300,e.connect(t.destination),e.start(t.currentTime),e.stop(t.currentTime+.05)}var w;!function(t){t[t.NONE=0]="NONE",t[t.DEPTH=1]="DEPTH",t[t.SUMMARY=2]="SUMMARY"}(w||(w={}));const N=MathJax._.mathjax.mathjax;class D{constructor(){this.adaptor=null,this.speechGenerator=b.getSpeechGenerator("Tree"),this.brailleGenerator=b.getSpeechGenerator("Tree"),this.summaryGenerator=b.getSpeechGenerator("Summary"),this._options={},this._init=!1,this.lastSpeech="",this.lastMove_=w.NONE,this.attrList=["data-semantic-prefix","data-semantic-postfix","data-semantic-speech","data-semantic-braille"],this.dummyList=["data-semantic-id","data-semantic-parent","data-semantic-type","data-semantic-role","role"]}set element(t){this._element=t;const e=this.speechGenerator.computeRebuilt(t,!0);this.brailleGenerator.setRebuilt(e),this.summaryGenerator.setRebuilt(e)}get element(){return this._element}set options(t){var e;this._options=t,b.setupEngine(t.sre),this.speechGenerator.setOptions(Object.assign({},(null==t?void 0:t.sre)||{},{modality:"speech",markup:"ssml",automark:!0})),this.summaryGenerator.setOptions(Object.assign({},(null==t?void 0:t.sre)||{},{modality:"summary",markup:"ssml",automark:!0})),this.brailleGenerator.setOptions({locale:null===(e=null==t?void 0:t.sre)||void 0===e?void 0:e.braille,domain:"default",style:"default",modality:"braille",markup:"none"})}get options(){return this._options}init(t,e){this._init||(this.adaptor=e,this.options=t,this._init=!0,this._update(t)&&N.retryAfter(b.sreReady()))}update(t){return this.options=t,this._update(t)}_update(t){if(!t||!t.sre)return!1;let e=!1;return t.sre.braille!==D.currentBraille&&(D.currentBraille=t.sre.braille,e=!0,b.setupEngine({locale:t.sre.braille})),t.sre.locale!==D.currentLocale&&(D.currentLocale=t.sre.locale,e=!0,b.setupEngine({locale:t.sre.locale})),e}computeSpeech(t,e){this.element=b.parseDOM(e);const i=this.prepareXml(t),a=this.options.enableSpeech?this.speechGenerator.getSpeech(i,this.element):"",s=this.options.enableBraille?this.brailleGenerator.getSpeech(i,this.element):"";return(a||s)&&this.setAria(t,i,this.options.sre.locale),[a,s]}summary(t){if(this.lastMove===w.SUMMARY)return this.CleanUp(t),this.lastSpeech;const e=this.prepareXml(t);return this.lastSpeech=this.summaryGenerator.getSpeech(e,this.element),this.lastSpeech}CleanUp(t){this.lastMove&&this.adaptor.setAttribute(t,"aria-label",x(this.getLabel(t))[0]),this.lastMove=w.NONE}get lastMove(){return this.lastMove_}set lastMove(t){this.lastMove_=this.lastSpeech?t:w.NONE}updateRegions(t,e,i){let a=this.getLabel(t,this.lastSpeech);e.Update(a),this.adaptor.setAttribute(t,"aria-label",x(a)[0]),this.lastSpeech="",i.Update(this.adaptor.getAttribute(t,"aria-braillelabel"))}updateSpeech(t){const e=this.prepareXml(t),i=this.speechGenerator.getSpeech(e,this.element);this.setAria(t,e,this.options.sre.locale);const a=x(i)[0];return this.adaptor.setAttribute(t,"aria-label",a),a}nextRules(t){this.speechGenerator.nextRules(),this.updateSummaryGenerator()}nextStyle(t){this.speechGenerator.nextStyle(this.adaptor.getAttribute(t,"data-semantic-id")),this.updateSummaryGenerator()}updateSummaryGenerator(){const t=this.speechGenerator.getOptions();this.summaryGenerator.setOption("domain",t.domain),this.summaryGenerator.setOption("style",t.style)}prepareXml(t){return b.parseDOM(this.adaptor.serializeXML(t))}getLabel(t,e="",i=" "){return O(e||this.adaptor.getAttribute(t,"data-semantic-speech"),this.adaptor.getAttribute(t,"data-semantic-prefix"),this.adaptor.getAttribute(t,"data-semantic-postfix"),i)}copyAttributes(t,e,i){const a=t.getAttribute(i);null!=a&&this.adaptor.setAttribute(e,i,a)}setAria(t,e,i){const a=e.getAttribute("data-semantic-type");if(a&&(this.attrList.forEach((i=>this.copyAttributes(e,t,i))),"dummy"===a&&this.dummyList.forEach((i=>this.copyAttributes(e,t,i)))),this.options.a11y.speech){const e=this.getLabel(t);e&&this.adaptor.setAttribute(t,"aria-label",x(e,i)[0])}if(this.options.a11y.braille){const e=this.adaptor.getAttribute(t,"data-semantic-braille");e&&this.adaptor.setAttribute(t,"aria-braillelabel",e)}const s=Array.from(e.childNodes);Array.from(this.adaptor.childNodes(t)).forEach(((t,e)=>{"#text"!==this.adaptor.kind(t)&&"#comment"!==this.adaptor.kind(t)&&this.setAria(t,s[e],i)}))}depth(t,e){if(this.lastMove===w.DEPTH)return this.CleanUp(t),this.lastSpeech;let i=this.summaryGenerator.getActionable(e?0===this.adaptor.childNodes(t).length?-1:1:0);const a=this.summaryGenerator.getLevel(this.adaptor.getAttribute(t,"aria-level"));return this.lastSpeech=`${a} ${i}`,this.lastSpeech}}D.currentLocale="none",D.currentBraille="none",c("ENRICHED",h.COMPILED+10),c("ATTACHSPEECH",h.INSERTED+10);class P extends p{visitTree(t,e){this.mactionId=1;const i=super.visitTree(t);return this.mactionId&&(e.inputData.hasMaction=!0),i}visitHtmlNode(t,e){return t.getSerializedXML()}visitMactionNode(t,e){let[i,a]=0===t.childNodes.length?["",""]:["\n",e];const s=this.childNodeMml(t,e+"  ",i);let r=this.getAttributes(t);if("toggle"===t.attributes.get("actiontype")){const e=this.mactionId++;t.setProperty("mactionId",e),r=` data-maction-id="${e}" selection="${t.attributes.get("selection")}"`+r.replace(/ selection="\d+"/,"").replace(/ data-maction-id="\d+"/,"")}return e+"<maction"+r+">"+(s.match(/\S/)?i+s+a:"")+"</maction>"}}function G(t,e,i){return class extends t{constructor(){super(...arguments),this.generatorPool=new D,this.toMathML=i}serializeMml(t){if("outerHTML"in t)return t.outerHTML;if("undefined"!=typeof Element&&"undefined"!=typeof window&&t instanceof Element){const e=window.document.createElement("div");return e.appendChild(t),e.innerHTML}return t.toString()}enrich(t,a=!1){if(!(this.state()>=h.ENRICHED)){if(!this.isEscaped&&(t.options.enableEnrichment||a)){this.generatorPool.init(t.options,t.adaptor);const a=new t.options.MathItem("",e);try{let e;e=this.inputData.originalMml?this.adjustSelections():this.inputData.originalMml=i(this.root,this);const s=b.toEnriched(e);this.inputData.enrichedMml=a.math=this.serializeMml(s),a.display=this.display,a.compile(t),this.root=a.root}catch(e){t.options.enrichError(t,this,e)}}this.state(h.ENRICHED)}}unEnrich(t){const i=this.inputData.originalMml;if(!i)return;const a=new t.options.MathItem("",e);a.math=i,a.display=this.display,a.compile(t),this.root=a.root}adjustSelections(){let t=this.inputData.originalMml;if(!this.inputData.hasMaction)return t;const e=[];return this.root.walkTree((t=>{t.isKind("maction")&&(e[t.attributes.get("data-maction-id")]=t)})),t.replace(/(data-maction-id="(\d+)" selection=)"\d+"/g,((t,i,a)=>`${i}"${e[a].attributes.get("selection")}"`))}existingSpeech(){const t=this.root.attributes;let e=t.get("aria-label");return e||(e=x(t.get("data-semantic-speech")||"")[0]),[e,t.get("aria-braillelabel")||t.get("data-semantic-braille")||""]}attachSpeech(t){if(this.state()>=h.ATTACHSPEECH)return;if(this.state(h.ATTACHSPEECH),this.isEscaped||!t.options.enableEnrichment)return;let[e,i]=this.existingSpeech(),[a,s]=["",""];const r=t.options;if(!e&&r.enableSpeech||!i&&r.enableBraille)try{[a,s]=this.generatorPool.computeSpeech(this.typesetRoot,this.toMathML(this.root,this)),a&&(a=x(a)[0])}catch(e){t.options.speechError(t,this,e)}if(e=e||a,i=i||s,!e&&!i)return;const n=t.adaptor,o=this.typesetRoot;e&&r.enableSpeech&&(n.setAttribute(o,"aria-label",e),this.root.attributes.set("aria-label",e)),i&&r.enableBraille&&(n.setAttribute(o,"aria-braillelabel",i),this.root.attributes.set("aria-braillelabel",i));for(const t of n.childNodes(o))n.setAttribute(t,"aria-hidden","true");this.outputData.speech=e,this.outputData.braille=i}}}function L(t,e){var i;return(i=class extends t{constructor(...t){super(...t),this.speechTimeout=0,e.setMmlFactory(this.mmlFactory);const i=this.constructor.ProcessBits;i.has("enriched")||(i.allocate("enriched"),i.allocate("attach-speech"));const a=new P(this.mmlFactory);this.options.MathItem=G(this.options.MathItem,e,((t,e)=>a.visitTree(t,e)))}attachSpeech(){return this.processed.isSet("attach-speech")||((this.options.enableSpeech||this.options.enableBraille)&&(this.options.speechTiming.asynchronous?this.attachSpeechAsync():this.attachSpeechSync()),this.processed.set("attach-speech")),this}attachSpeechSync(){for(const t of this.math)t.attachSpeech(this)}attachSpeechAsync(){this.speechTimeout&&(clearTimeout(this.speechTimeout),this.speechTimeout=0,this.attachSpeechDone()),this.awaitingSpeech=Array.from(this.math),0!==this.awaitingSpeech.length?(this.renderPromises.push(new Promise(((t,e)=>{this.attachSpeechDone=t}))),this.speechTimeout=setTimeout((()=>this.attachSpeechLoop()),this.options.speechTiming.initial)):this.awaitingSpeech=null}attachSpeechLoop(){const t=this.options.speechTiming,e=this.awaitingSpeech,i=(new Date).getTime()+t.threshold;do{e.shift().attachSpeech(this)}while(e.length&&(new Date).getTime()<i);e.length?this.speechTimeout=setTimeout((()=>this.attachSpeechLoop()),t.intermediate):(this.speechTimeout=0,this.attachSpeechDone())}enrich(){if(!this.processed.isSet("enriched")){if(this.options.enableEnrichment)for(const t of this.math)t.enrich(this);this.processed.set("enriched")}return this}enrichError(t,e,i){console.warn("Enrichment error:",i)}speechError(t,e,i){console.warn("Speech generation error:",i)}state(t,e=!1){if(super.state(t,e),t<h.ENRICHED&&(this.processed.clear("enriched"),t>=h.COMPILED))for(const t of this.math)t.unEnrich(this);return t<h.ATTACHSPEECH&&this.processed.clear("attach-speech"),this}}).OPTIONS=Object.assign(Object.assign({},t.OPTIONS),{enableEnrichment:!0,enableSpeech:!0,enableBraille:!0,enrichError:(t,e,i)=>t.enrichError(t,e,i),speechError:(t,e,i)=>t.speechError(t,e,i),renderActions:m(Object.assign(Object.assign({},t.OPTIONS.renderActions),{enrich:[h.ENRICHED],attachSpeech:[h.ATTACHSPEECH]})),speechTiming:{asynchronous:!0,initial:100,threshold:250,intermediate:10},sre:m({speech:"none",locale:"en",domain:"clearspeak",style:"default",braille:"nemeth"}),a11y:m({speech:!0,braille:!0})}),i}function C(t,e){return e.setAdaptor(t.adaptor),t.documentClass=L(t.documentClass,e),t}MathJax.loader&&MathJax.loader.checkVersion("a11y/semantic-enrich","4.0.0-beta.7","a11y"),n({_:{a11y:{"semantic-enrich":a,speech:{GeneratorPool:i,SpeechUtil:e}}}});const I=MathJax._.input.mathml_ts.MathML;MathJax.loader&&r(MathJax.config.loader,"a11y/semantic-enrich",{checkReady:()=>b.sreReady()}),MathJax.startup&&MathJax.startup.extendHandler((t=>C(t,new I({allowHtmlInTokenNodes:!0}))))})();