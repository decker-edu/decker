(()=>{"use strict";var t={d:(e,i)=>{for(var a in i)t.o(i,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:i[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{EnrichHandler:()=>y,EnrichedMathDocumentMixin:()=>b,EnrichedMathItemMixin:()=>E,enrichVisitor:()=>f});const i=("undefined"!=typeof window?window:global).MathJax._.components.global,a=(i.GLOBAL,i.isObject,i.combineConfig,i.combineDefaults),s=i.combineWithMathJax,n=(i.MathJax,MathJax._.mathjax.mathjax),r=MathJax._.core.MathItem,o=(r.protoItem,r.AbstractMathItem,r.STATE),c=r.newState,h=MathJax._.core.MmlTree.SerializedMmlVisitor,l=(h.toEntity,h.SerializedMmlVisitor),d=MathJax._.util.Options,p=(d.isObject,d.APPEND,d.REMOVE,d.OPTIONS,d.Expandable,d.expandable),u=(d.makeArray,d.keys,d.copy,d.insert,d.defaultOptions,d.userOptions,d.selectOptions,d.selectOptionsFromKeys,d.separateOptions,d.lookup,MathJax._.a11y.sre),m=u.Sre;u.sreReady,u.default;let M="none";c("ENRICHED",30),c("ATTACHSPEECH",155);class f extends l{visitTree(t,e){this.mactionId=1;const i=super.visitTree(t);return this.mactionId&&(e.inputData.hasMaction=!0),i}visitMactionNode(t,e){let[i,a]=0===t.childNodes.length?["",""]:["\n",e];const s=this.childNodeMml(t,e+"  ",i);let n=this.getAttributes(t);if("toggle"===t.attributes.get("actiontype")){const e=this.mactionId++;t.setProperty("mactionId",e),n=` data-maction-id="${e}" selection="${t.attributes.get("selection")}"`+n.replace(/ selection="\d+"/,"")}return e+"<maction"+n+">"+(s.match(/\S/)?i+s+a:"")+"</maction>"}}function E(t,e,i){return class extends t{serializeMml(t){if("outerHTML"in t)return t.outerHTML;if("undefined"!=typeof Element&&"undefined"!=typeof window&&t instanceof Element){const e=window.document.createElement("div");return e.appendChild(t),e.innerHTML}return t.toString()}enrich(t,a=!1){if(!(this.state()>=o.ENRICHED)){if(!this.isEscaped&&(t.options.enableEnrichment||a)){t.options.sre.speech!==M&&(M=t.options.sre.speech,n.retryAfter(m.setupEngine(t.options.sre).then((()=>m.sreReady()))));const a=new t.options.MathItem("",e);try{let e;e=this.inputData.originalMml?this.adjustSelections():this.inputData.originalMml=i(this.root,this),this.inputData.enrichedMml=a.math=this.serializeMml(m.toEnriched(e)),a.display=this.display,a.compile(t),this.root=a.root}catch(e){t.options.enrichError(t,this,e)}}this.state(o.ENRICHED)}}adjustSelections(){let t=this.inputData.originalMml;if(!this.inputData.hasMaction)return t;const e=[];return this.root.walkTree((t=>{t.isKind("maction")&&(e[t.attributes.get("data-maction-id")]=t)})),t.replace(/(data-maction-id="(\d+)" selection=)"\d+"/g,((t,i,a)=>`${i}"${e[a].attributes.get("selection")}"`))}attachSpeech(t){if(this.state()>=o.ATTACHSPEECH)return;const e=this.root.attributes.get("aria-label")||this.getSpeech(this.root);if(e){const i=t.adaptor,a=this.typesetRoot;i.setAttribute(a,"aria-label",e);for(const t of i.childNodes(a))i.setAttribute(t,"aria-hidden","true");this.outputData.speech=e}this.state(o.ATTACHSPEECH)}getSpeech(t){const e=t.attributes;if(!e)return"";const i=e.getExplicit("data-semantic-speech");if(!e.hasExplicit("data-semantic-parent")&&i)return i;for(let e of t.childNodes){let t=this.getSpeech(e);if(t)return t}return""}}}function b(t,e){var i;return(i=class extends t{constructor(...t){super(...t),e.setMmlFactory(this.mmlFactory);const i=this.constructor.ProcessBits;i.has("enriched")||(i.allocate("enriched"),i.allocate("attach-speech"));const a=new f(this.mmlFactory);this.options.MathItem=E(this.options.MathItem,e,((t,e)=>a.visitTree(t,e)))}attachSpeech(){if(!this.processed.isSet("attach-speech")){for(const t of this.math)t.attachSpeech(this);this.processed.set("attach-speech")}return this}enrich(){if(!this.processed.isSet("enriched")){if(this.options.enableEnrichment)for(const t of this.math)t.enrich(this);this.processed.set("enriched")}return this}enrichError(t,e,i){console.warn("Enrichment error:",i)}state(t,e=!1){return super.state(t,e),t<o.ENRICHED&&this.processed.clear("enriched"),this}}).OPTIONS=Object.assign(Object.assign({},t.OPTIONS),{enableEnrichment:!0,enrichError:(t,e,i)=>t.enrichError(t,e,i),renderActions:p(Object.assign(Object.assign({},t.OPTIONS.renderActions),{enrich:[o.ENRICHED],attachSpeech:[o.ATTACHSPEECH]})),sre:p({structure:!0,speech:"none",domain:"mathspeak",style:"default",locale:"en"})}),i}function y(t,e){return e.setAdaptor(t.adaptor),t.documentClass=b(t.documentClass,e),t}MathJax.loader&&MathJax.loader.checkVersion("a11y/semantic-enrich","4.0.0-beta.4","a11y"),s({_:{a11y:{"semantic-enrich":e}}});const g=MathJax._.input.mathml_ts.MathML;MathJax.loader&&a(MathJax.config.loader,"a11y/semantic-enrich",{checkReady:()=>m.sreReady()}),MathJax.startup&&MathJax.startup.extendHandler((t=>y(t,new g({allowHtmlInTokenNodes:!0}))))})();