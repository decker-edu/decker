(()=>{"use strict";var __webpack_modules__={691:(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{Z:()=>__WEBPACK_DEFAULT_EXPORT__});var _variables_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(58);class SystemExternal{static extRequire(library){if("undefined"!=typeof process&&"undefined"!=typeof require){const nodeRequire=eval("require");return nodeRequire(library)}return null}}SystemExternal.windowSupported=!("undefined"==typeof window),SystemExternal.documentSupported=SystemExternal.windowSupported&&!(void 0===window.document),SystemExternal.xmldom=SystemExternal.documentSupported?window:SystemExternal.extRequire("@xmldom/xmldom"),SystemExternal.document=SystemExternal.documentSupported?window.document:(new SystemExternal.xmldom.DOMImplementation).createDocument("","",0),SystemExternal.xpath=SystemExternal.documentSupported?document:function(){const t={document:{},XPathResult:{}};return SystemExternal.extRequire("wicked-good-xpath").install(t),t.document.XPathResult=t.XPathResult,t.document}(),SystemExternal.mathmapsIePath="https://cdn.jsdelivr.net/npm/sre-mathmaps-ie@"+_variables_js__WEBPACK_IMPORTED_MODULE_0__.L.VERSION+"mathmaps_ie.js",SystemExternal.commander=SystemExternal.documentSupported?null:SystemExternal.extRequire("commander"),SystemExternal.fs=SystemExternal.documentSupported?null:SystemExternal.extRequire("fs"),SystemExternal.url=_variables_js__WEBPACK_IMPORTED_MODULE_0__.L.url,SystemExternal.jsonPath=(SystemExternal.documentSupported?SystemExternal.url:process.env.SRE_JSON_PATH||global.SRE_JSON_PATH||("undefined"!=typeof __dirname?__dirname+"/mathmaps":process.cwd()))+"/",SystemExternal.WGXpath=_variables_js__WEBPACK_IMPORTED_MODULE_0__.L.WGXpath,SystemExternal.wgxpath=null;const __WEBPACK_DEFAULT_EXPORT__=SystemExternal},58:(t,e,n)=>{n.d(e,{L:()=>r});class r{static ensureLocale(t,e){return r.LOCALES.get(t)?t:(console.error(`Locale ${t} does not exist! Using ${r.LOCALES.get(e)} instead.`),e)}}r.VERSION="4.1.0-beta.7",r.LOCALES=new Map([["ca","Catalan"],["da","Danish"],["de","German"],["en","English"],["es","Spanish"],["euro","Euro"],["fr","French"],["hi","Hindi"],["it","Italian"],["ko","Korean"],["nb","Bokm\xe5l"],["nn","Nynorsk"],["sv","Swedish"],["nemeth","Nemeth"]]),r.mathjaxVersion="4.0.0-beta.1",r.url="https://cdn.jsdelivr.net/npm/speech-rule-engine@"+r.VERSION+"/lib/mathmaps",r.WGXpath="https://cdn.jsdelivr.net/npm/wicked-good-xpath@1.3.0/dist/wgxpath.install.js"}},__webpack_module_cache__={};function __webpack_require__(t){var e=__webpack_module_cache__[t];if(void 0!==e)return e.exports;var n=__webpack_module_cache__[t]={exports:{}};return __webpack_modules__[t](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(t,e)=>{for(var n in e)__webpack_require__.o(e,n)&&!__webpack_require__.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),__webpack_require__.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{var t={};__webpack_require__.r(t),__webpack_require__.d(t,{Sre:()=>vu,default:()=>Du,sreReady:()=>wu});const e=("undefined"!=typeof window?window:global).MathJax._.components.global,n=(e.GLOBAL,e.isObject,e.combineConfig,e.combineDefaults,e.combineWithMathJax);e.MathJax;var r,s,o;!function(t){t.DOMAIN="domain",t.STYLE="style",t.LOCALE="locale",t.TOPIC="topic",t.MODALITY="modality"}(r||(r={}));class i{static createProp(...t){const e=c.DEFAULT_ORDER,n={};for(let r=0,s=t.length,o=e.length;r<s&&r<o;r++)n[e[r]]=t[r];return new i(n)}constructor(t,e=Object.keys(t)){this.properties=t,this.order=e}getProperties(){return this.properties}getOrder(){return this.order}getAxes(){return this.order}getProperty(t){return this.properties[t]}updateProperties(t){this.properties=t}allProperties(){const t=[];return this.order.forEach((e=>t.push(this.getProperty(e).slice()))),t}toString(){const t=[];return this.order.forEach((e=>t.push(e+": "+this.getProperty(e).toString()))),t.join("\n")}}class c extends i{static createCstr(...t){const e=c.DEFAULT_ORDER,n={};for(let r=0,s=t.length,o=e.length;r<s&&r<o;r++)n[e[r]]=t[r];return new c(n)}static defaultCstr(){return c.createCstr.apply(null,c.DEFAULT_ORDER.map((function(t){return c.DEFAULT_VALUES[t]})))}static validOrder(t){const e=c.DEFAULT_ORDER.slice();return t.every((t=>{const n=e.indexOf(t);return-1!==n&&e.splice(n,1)}))}constructor(t,e){const n={};for(const[e,r]of Object.entries(t))n[e]=[r];super(n,e),this.components=t}getComponents(){return this.components}getValue(t){return this.components[t]}getValues(){return this.order.map((t=>this.getValue(t)))}allProperties(){const t=super.allProperties();for(let e,n,r=0;e=t[r],n=this.order[r];r++){const t=this.getValue(n);-1===e.indexOf(t)&&e.unshift(t)}return t}toString(){return this.getValues().join(".")}equal(t){const e=t.getAxes();if(this.order.length!==e.length)return!1;for(let n,r=0;n=e[r];r++){const e=this.getValue(n);if(!e||t.getValue(n)!==e)return!1}return!0}}c.DEFAULT_ORDER=[r.LOCALE,r.MODALITY,r.DOMAIN,r.STYLE,r.TOPIC],c.BASE_LOCALE="base",c.DEFAULT_VALUE="default",c.DEFAULT_VALUES={[r.LOCALE]:"en",[r.DOMAIN]:c.DEFAULT_VALUE,[r.STYLE]:c.DEFAULT_VALUE,[r.TOPIC]:c.DEFAULT_VALUE,[r.MODALITY]:"speech"};class a{constructor(t){this.order=t}parse(t){const e=t.split("."),n={};if(e.length>this.order.length)throw new Error("Invalid dynamic constraint: "+n);let r=0;for(let t,s=0;t=this.order[s],e.length;s++,r++){const r=e.shift();n[t]=r}return new c(n,this.order.slice(0,r))}}class l{constructor(t,e=new i(t.getProperties(),t.getOrder())){this.reference=t,this.fallback=e,this.order=this.reference.getOrder()}getReference(){return this.reference}setReference(t,e){this.reference=t,this.fallback=e||new i(t.getProperties(),t.getOrder()),this.order=this.reference.getOrder()}match(t){const e=t.getAxes();return e.length===this.reference.getAxes().length&&e.every((e=>{const n=t.getValue(e);return n===this.reference.getValue(e)||-1!==this.fallback.getProperty(e).indexOf(n)}))}compare(t,e){let n=!1;for(let r,s=0;r=this.order[s];s++){const s=t.getValue(r),o=e.getValue(r);if(!n){const t=this.reference.getValue(r);if(t===s&&t!==o)return-1;if(t===o&&t!==s)return 1;if(t===s&&t===o)continue;t!==s&&t!==o&&(n=!0)}const i=this.fallback.getProperty(r),c=i.indexOf(s),a=i.indexOf(o);if(c<a)return-1;if(a<c)return 1}return 0}toString(){return this.reference.toString()+"\n"+this.fallback.toString()}}!function(t){t.SYNC="sync",t.ASYNC="async",t.HTTP="http"}(s||(s={})),function(t){t.PITCH="pitch",t.RATE="rate",t.VOLUME="volume",t.PAUSE="pause",t.JOIN="join",t.LAYOUT="layout"}(o||(o={}));const u=[o.PITCH,o.RATE,o.VOLUME,o.PAUSE,o.JOIN];var h,d;!function(t){t.NONE="none",t.SHALLOW="shallow",t.DEEP="deep"}(h||(h={})),function(t){t.NONE="none",t.LAYOUT="layout",t.PUNCTUATION="punctuation",t.SSML="ssml",t.ACSS="acss",t.SABLE="sable",t.VOICEXML="voicexml"}(d||(d={}));const f={mathspeak:"default",clearspeak:"default"};var p=__webpack_require__(691);class m{static getInstance(){return m.instance=m.instance||new m,m.instance}init(t){return t&&this.startDebugFile_(t),this.isActive_=!0,this.fileHandle}output(...t){this.isActive_&&this.output_(t)}generateOutput(t){this.isActive_&&this.output_(t.apply(t,[]))}exit(t=(()=>{})){this.fileHandle.then((()=>{this.isActive_&&this.stream_&&this.stream_.end("","",t)}))}constructor(){this.isActive_=!1,this.outputFunction_=console.info,this.fileHandle=Promise.resolve(),this.stream_=null}startDebugFile_(t){this.fileHandle=p.Z.fs.promises.open(t,"w"),this.fileHandle=this.fileHandle.then((e=>{this.stream_=e.createWriteStream(t),this.outputFunction_=function(...t){this.stream_.write(t.join(" ")),this.stream_.write("\n")}.bind(this),this.stream_.on("error",function(t){console.info("Invalid log file. Debug information sent to console."),this.outputFunction_=console.info}.bind(this)),this.stream_.on("finish",(function(){console.info("Finalizing debug file.")}))}))}output_(t){console.info!==this.outputFunction_?this.fileHandle.then((()=>this.outputFunction_.apply(this.outputFunction_,["Speech Rule Engine Debugger:"].concat(t)))):this.outputFunction_.apply(console,["Speech Rule Engine Debugger:"].concat(t))}}var g=__webpack_require__(58);class S extends Error{constructor(t=""){super(),this.message=t,this.name="SRE Error"}}class N{set defaultLocale(t){this._defaultLocale=g.L.ensureLocale(t,this._defaultLocale)}get defaultLocale(){return this._defaultLocale}static getInstance(){return N.instance=N.instance||new N,N.instance}static defaultEvaluator(t,e){return t}static evaluateNode(t){return N.nodeEvaluator(t)}getRate(){const t=parseInt(this.rate,10);return isNaN(t)?100:t}setDynamicCstr(t){if(this.defaultLocale&&(c.DEFAULT_VALUES[r.LOCALE]=this.defaultLocale),t){const e=Object.keys(t);for(let n=0;n<e.length;n++){const r=e[n];if(-1!==c.DEFAULT_ORDER.indexOf(r)){const e=t[r];this[r]=e}}}f[this.domain]=this.style;const e=[this.locale,this.modality,this.domain,this.style].join("."),n=i.createProp([c.DEFAULT_VALUES[r.LOCALE]],[c.DEFAULT_VALUES[r.MODALITY]],[c.DEFAULT_VALUES[r.DOMAIN]],[c.DEFAULT_VALUES[r.STYLE]]),s=this.comparators[this.domain],o=this.parsers[this.domain];this.parser=o||this.defaultParser,this.dynamicCstr=this.parser.parse(e),this.dynamicCstr.updateProperties(n.getProperties()),this.comparator=s?s():new l(this.dynamicCstr)}constructor(){this.customLoader=null,this.parsers={},this.comparator=null,this.mode=s.SYNC,this.init=!0,this.delay=!1,this.comparators={},this.domain="mathspeak",this.style=c.DEFAULT_VALUES[r.STYLE],this._defaultLocale=c.DEFAULT_VALUES[r.LOCALE],this.locale=this.defaultLocale,this.subiso="",this.modality=c.DEFAULT_VALUES[r.MODALITY],this.speech=h.NONE,this.markup=d.NONE,this.mark=!0,this.automark=!1,this.character=!0,this.cleanpause=!0,this.rate="100",this.walker="Table",this.structure=!1,this.aria=!1,this.ruleSets=[],this.strict=!1,this.isIE=!1,this.isEdge=!1,this.pprint=!1,this.config=!1,this.rules="",this.prune="",this.evaluator=N.defaultEvaluator,this.defaultParser=new a(c.DEFAULT_ORDER),this.parser=this.defaultParser,this.dynamicCstr=c.defaultCstr()}configurate(t){this.mode!==s.HTTP||this.config||(!function(t){const e=document.documentElement.querySelectorAll('script[type="text/x-sre-config"]');for(let n=0,r=e.length;n<r;n++){let r;try{r=e[n].innerHTML;const s=JSON.parse(r);for(const[e,n]of Object.entries(s))t[e]=n}catch(t){m.getInstance().output("Illegal configuration ",r)}}}(t),this.config=!0),function(t){if("undefined"!=typeof SREfeature)for(const[e,n]of Object.entries(SREfeature))t[e]=n}(t)}setCustomLoader(t){t&&(this.customLoader=t)}}N.BINARY_FEATURES=["automark","mark","character","cleanpause","strict","structure","aria","pprint"],N.STRING_FEATURES=["markup","style","domain","speech","walker","defaultLocale","locale","delay","modality","rate","rules","subiso","prune"],N.nodeEvaluator=function(t){return[]};const E=N;class b{static get(t=N.getInstance().locale){return b.promises[t]||Promise.resolve("")}static getall(){return Promise.all(Object.values(b.promises))}}function A(){return"undefined"!=typeof XPathResult}b.loaded={},b.promises={};const y={currentDocument:null,evaluate:A()?document.evaluate:p.Z.xpath.evaluate,result:A()?XPathResult:p.Z.xpath.XPathResult,createNSResolver:A()?document.createNSResolver:p.Z.xpath.createNSResolver},T={xhtml:"http://www.w3.org/1999/xhtml",mathml:"http://www.w3.org/1998/Math/MathML",mml:"http://www.w3.org/1998/Math/MathML",svg:"http://www.w3.org/2000/svg"};function C(t){return T[t]||null}class _{constructor(){this.lookupNamespaceURI=C}}function I(t,e,n){return E.getInstance().mode!==s.HTTP||E.getInstance().isIE||E.getInstance().isEdge?y.evaluate(t,e,new _,n,null):y.currentDocument.evaluate(t,e,C,n,null)}function O(t,e){let n;try{n=I(t,e,y.result.ORDERED_NODE_ITERATOR_TYPE)}catch(t){return[]}const r=[];for(let t=n.iterateNext();t;t=n.iterateNext())r.push(t);return r}function M(t){if(E.getInstance().mode!==s.HTTP)return;let e=t;for(;e&&!e.evaluate;)e=e.parentNode;e&&e.evaluate?y.currentDocument=e:t.ownerDocument&&(y.currentDocument=t.ownerDocument)}function R(t){const e=[];for(let n=0,r=t.length;n<r;n++)e.push(t[n]);return e}function x(t){const e=new p.Z.xmldom.DOMParser,n=function(t){return(t=t.replace(/&nbsp;/g,"\xa0")).replace(/>[ \f\n\r\t\v\u200b]+</g,"><").trim()}(t),r=!!n.match(/&(?!lt|gt|amp|quot|apos)\w+;/g);if(!n)throw new Error("Empty input!");try{const t=e.parseFromString(n,r?"text/html":"text/xml");return E.getInstance().mode===s.HTTP?(y.currentDocument=t,r?t.body.childNodes[0]:t.documentElement):t.documentElement}catch(t){throw new S("Illegal input: "+t.message)}}var L;function v(t,e){t.parentNode&&(t.parentNode.insertBefore(e,t),t.parentNode.removeChild(t))}function F(t){return p.Z.document.createElement(t)}function w(t,e){return p.Z.document.createElementNS(t,e)}function D(t){let e="",n=/(>)(<)(\/*)/g,r=0,s=(t=t.replace(n,"$1\r\n$2$3")).split("\r\n");for(n=/(\.)*(<)(\/*)/g,s=s.map((t=>t.replace(n,"$1\r\n$2$3").split("\r\n"))).reduce(((t,e)=>t.concat(e)),[]);s.length;){let t=s.shift();if(!t)continue;let n=0;if(t.match(/^<\w[^>/]*>[^>]+$/)){const e=P(t,s[0]);e[0]?e[1]?(t+=s.shift().slice(0,-e[1].length),e[1].trim()&&s.unshift(e[1])):t+=s.shift():n=1}else if(t.match(/^<\/\w/))0!==r&&(r-=1);else if(t.match(/^<\w[^>]*[^/]>.*$/))n=1;else if(t.match(/^<\w[^>]*\/>.+$/)){const e=t.indexOf(">")+1,n=t.slice(e);n.trim()&&s.unshift(),t=t.slice(0,e)+n}else n=0;e+=new Array(r+1).join("  ")+t+"\r\n",r+=n}return e}function P(t,e){if(!e)return[!1,""];const n=t.match(/^<([^> ]+).*>/),r=e.match(/^<\/([^>]+)>(.*)/);return n&&r&&n[1]===r[1]?[!0,r[2]]:[!1,""]}function k(t,e,n){return t.querySelectorAll?R(t.querySelectorAll(`[${e}="${n}"]`)):O(`.//*[@${e}="${n}"]`,t)}function U(t,e){return t.querySelectorAll?R(t.querySelectorAll(e)):O(`.//${e}`,t)}function B(t){return t.tagName.toUpperCase()}function G(t){return t.cloneNode(!0)}function $(t){return(new p.Z.xmldom.XMLSerializer).serializeToString(t)}function j(t,e){return t.toString()}function V(t){return t.toString()}function H(t,e){return t+e.toLowerCase()}!function(t){t[t.ELEMENT_NODE=1]="ELEMENT_NODE",t[t.ATTRIBUTE_NODE=2]="ATTRIBUTE_NODE",t[t.TEXT_NODE=3]="TEXT_NODE",t[t.CDATA_SECTION_NODE=4]="CDATA_SECTION_NODE",t[t.ENTITY_REFERENCE_NODE=5]="ENTITY_REFERENCE_NODE",t[t.ENTITY_NODE=6]="ENTITY_NODE",t[t.PROCESSING_INSTRUCTION_NODE=7]="PROCESSING_INSTRUCTION_NODE",t[t.COMMENT_NODE=8]="COMMENT_NODE",t[t.DOCUMENT_NODE=9]="DOCUMENT_NODE",t[t.DOCUMENT_TYPE_NODE=10]="DOCUMENT_TYPE_NODE",t[t.DOCUMENT_FRAGMENT_NODE=11]="DOCUMENT_FRAGMENT_NODE",t[t.NOTATION_NODE=12]="NOTATION_NODE"}(L||(L={}));const W={};function q(t,e=""){if(!t.childNodes||!t.childNodes[0]||!t.childNodes[0].childNodes||t.childNodes[0].childNodes.length<2||"number"!==t.childNodes[0].childNodes[0].tagName||"integer"!==t.childNodes[0].childNodes[0].getAttribute("role")||"number"!==t.childNodes[0].childNodes[1].tagName||"integer"!==t.childNodes[0].childNodes[1].getAttribute("role"))return{convertible:!1,content:t.textContent};const n=t.childNodes[0].childNodes[1].textContent,r=t.childNodes[0].childNodes[0].textContent,s=Number(n),o=Number(r);return isNaN(s)||isNaN(o)?{convertible:!1,content:`${r} ${e} ${n}`}:{convertible:!0,enumerator:o,denominator:s}}function Y(t,e,n){const r=q(t);if(r.convertible){const t=r.enumerator,s=r.denominator;return t>0&&t<e&&s>0&&s<n}return!1}function X(){return{zero:"zero",ones:[],tens:[],large:[],special:{},wordOrdinal:V,numericOrdinal:V,numberToWords:V,numberToOrdinal:j,vulgarSep:" ",numSep:" "}}W.identityCombiner=function(t,e,n){return t+e+n},W.prefixCombiner=function(t,e,n){return t=n?n+" "+t:t,e?e+" "+t:t},W.postfixCombiner=function(t,e,n){return t=n?n+" "+t:t,e?t+" "+e:t},W.romanceCombiner=function(t,e,n){return t=n?t+" "+n:t,e?t+" "+e:t};const K=z();function z(){return{FUNCTIONS:{fracNestDepth:t=>Y(t,10,100),radicalNestDepth:t=>"",combineRootIndex:function(t,e){return t},combineNestedFraction:W.identityCombiner,combineNestedRadical:W.identityCombiner,fontRegexp:function(t){return new RegExp("^"+t.split(/ |-/).join("( |-)")+"( |-)")},si:H,plural:V},MESSAGES:{MS:{},MSroots:{},font:{},embellish:{},role:{},enclose:{},navigate:{},regexp:{},unitTimes:""},ALPHABETS:{latinSmall:[],latinCap:[],greekSmall:[],greekCap:[],capPrefix:{default:""},smallPrefix:{default:""},digitPrefix:{default:""},languagePrefix:{},digitTrans:{default:V,mathspeak:V,clearspeak:V},letterTrans:{default:V},combiner:(t,e,n)=>t},NUMBERS:X(),COMBINERS:{},CORRECTIONS:{},SUBISO:{default:"",current:"",all:[]}}}function J(t){switch(t){case 1:return K.MESSAGES.MS.ONCE||"";case 2:return K.MESSAGES.MS.TWICE;default:return t.toString()}}function Z(t,e){return t===K.MESSAGES.MS.ROOTINDEX||t===K.MESSAGES.MS.INDEX?t:t+" "+e}function Q(t){return tt(K.MESSAGES.font[t],t)}function tt(t,e){return void 0===t?e:"string"==typeof t?t:t[0]}const et="grammar";class nt{static getInstance(){return nt.instance=nt.instance||new nt,nt.instance}static parseInput(t){const e={},n=t.split(":");for(const t of n){const n=t.split("="),r=n[0].trim();n[1]?e[r]=n[1].trim():r.match(/^!/)?e[r.slice(1)]=!1:e[r]=!0}return e}static parseState(t){const e={},n=t.split(" ");for(const t of n){const n=t.split(":"),r=n[0],s=n[1];e[r]=s||!0}return e}static translateString(t){if(t.match(/:unit$/))return nt.translateUnit(t);const e=E.getInstance();let n=e.evaluator(t,e.dynamicCstr);return n=null===n?t:n,nt.getInstance().getParameter("plural")&&(n=K.FUNCTIONS.plural(n)),n}static translateUnit(t){t=nt.prepareUnit(t);const e=E.getInstance(),n=nt.getInstance().getParameter("plural"),r=e.strict,s=`${e.locale}.${e.modality}.default`;let o,i;return e.strict=!0,n&&(o=e.defaultParser.parse(s+".plural"),i=e.evaluator(t,o)),i?(e.strict=r,i):(o=e.defaultParser.parse(s+".default"),i=e.evaluator(t,o),e.strict=r,i?(n&&(i=K.FUNCTIONS.plural(i)),i):nt.cleanUnit(t))}static prepareUnit(t){const e=t.match(/:unit$/);return e?t.slice(0,e.index).replace(/\s+/g," ")+t.slice(e.index):t}static cleanUnit(t){return t.match(/:unit$/)?t.replace(/:unit$/,""):t}clear(){this.parameters_={},this.stateStack_=[]}setParameter(t,e){const n=this.parameters_[t];return e?this.parameters_[t]=e:delete this.parameters_[t],n}getParameter(t){return this.parameters_[t]}setCorrection(t,e){this.corrections_[t]=e}setPreprocessor(t,e){this.preprocessors_[t]=e}getCorrection(t){return this.corrections_[t]}getState(){const t=[];for(const[e,n]of Object.entries(this.parameters_))t.push("string"==typeof n?e+":"+n:e);return t.join(" ")}processSingles(){const t={};for(const e of this.singles)t[e]=!1;this.singles=[],this.pushState(t)}pushState(t){for(let[e,n]of Object.entries(t))e.match(/^\?/)&&(delete t[e],e=e.slice(1),this.singles.push(e)),t[e]=this.setParameter(e,n);this.stateStack_.push(t)}popState(){const t=this.stateStack_.pop();for(const[e,n]of Object.entries(t))this.setParameter(e,n)}setAttribute(t){if(t&&t.nodeType===L.ELEMENT_NODE){const e=this.getState();e&&t.setAttribute(et,e)}}preprocess(t){return this.runProcessors(t,this.preprocessors_)}correct(t){return this.runProcessors(t,this.corrections_)}apply(t,e){return this.currentFlags=e||{},t=this.currentFlags.adjust||this.currentFlags.preprocess?nt.getInstance().preprocess(t):t,(this.parameters_.translate||this.currentFlags.translate)&&(t=nt.translateString(t)),t=this.currentFlags.adjust||this.currentFlags.correct?nt.getInstance().correct(t):t,this.currentFlags={},t}runProcessors(t,e){for(const[n,r]of Object.entries(this.parameters_)){const s=e[n];s&&(t=!0===r?s(t):s(t,r))}return t}constructor(){this.currentFlags={},this.parameters_={},this.corrections_={},this.preprocessors_={},this.stateStack_=[],this.singles=[]}}function rt(t,e){if(!e||!t)return t;const n=K.FUNCTIONS.fontRegexp(Q(e));return t.replace(n,"")}function st(t){const e=t%1e3,n=Math.floor(e/100),r=n?1===n?"cent":ct.ones[n]+"-cents":"",s=function(t){const e=t%100;if(e<20)return ct.ones[e];const n=Math.floor(e/10),r=ct.tens[n],s=ct.ones[e%10];return r&&s?r+(2===n?"-i-":"-")+s:r||s}(e%100);return r&&s?r+ct.numSep+s:r||s}function ot(t){if(0===t)return ct.zero;if(t>=Math.pow(10,36))return t.toString();let e=0,n="";for(;t>0;){const r=t%(e>1?1e6:1e3);if(r){let t=ct.large[e];if(e)if(1===e)n=(1===r?"":st(r)+ct.numSep)+t+(n?ct.numSep+n:"");else{const e=ot(r);t=1===r?t:t.replace(/\u00f3$/,"ons"),n=e+ct.numSep+t+(n?ct.numSep+n:"")}else n=st(r)}t=Math.floor(t/(e>1?1e6:1e3)),e++}return n}function it(t){const e=nt.getInstance().getParameter("gender");return t.toString()+("f"===e?"a":"n")}nt.getInstance().setCorrection("localFont",Q),nt.getInstance().setCorrection("localRole",(function(t){return tt(K.MESSAGES.role[t],t)})),nt.getInstance().setCorrection("localEnclose",(function(t){return tt(K.MESSAGES.enclose[t],t)})),nt.getInstance().setCorrection("ignoreFont",rt),nt.getInstance().setPreprocessor("annotation",(function(t,e){return t+":"+e})),nt.getInstance().setPreprocessor("noTranslateText",(function(t){return t.match(new RegExp("^["+K.MESSAGES.regexp.TEXT+"]+$"))&&(nt.getInstance().currentFlags.translate=!1),t})),nt.getInstance().setCorrection("ignoreCaps",(function(t){let e=K.ALPHABETS.capPrefix[E.getInstance().domain];return void 0===e&&(e=K.ALPHABETS.capPrefix.default),rt(t,e)})),nt.getInstance().setPreprocessor("numbers2alpha",(function(t){return t.match(/\d+/)?K.NUMBERS.numberToWords(parseInt(t,10)):t}));const ct=X();ct.numericOrdinal=it,ct.numberToWords=ot,ct.numberToOrdinal=function(t,e){if(t>1999)return it(t);if(t<=10)return ct.special.onesOrdinals[t-1];const n=ot(t);return n.match(/mil$/)?n.replace(/mil$/,"mil\xb7l\xe8sima"):n.match(/u$/)?n.replace(/u$/,"vena"):n.match(/a$/)?n.replace(/a$/,"ena"):n+(n.match(/e$/)?"na":"ena")};const at=ct,lt=function(t,e,n){return t="sans serif "+(n?n+" "+t:t),e?t+" "+e:t};let ut=null;function ht(t,e=!1){return t===mt.ones[1]?e?"et":"en":t}function dt(t,e=!1){let n=t%1e3,r="",s=mt.ones[Math.floor(n/100)];if(r+=s?ht(s,!0)+" hundrede":"",n%=100,n)if(r+=r?" og ":"",s=e?mt.special.smallOrdinals[n]:mt.ones[n],s)r+=s;else{const t=e?mt.special.tensOrdinals[Math.floor(n/10)]:mt.tens[Math.floor(n/10)];s=mt.ones[n%10],r+=s?ht(s)+"og"+t:t}return r}function ft(t,e=!1){if(0===t)return mt.zero;if(t>=Math.pow(10,36))return t.toString();let n=0,r="";for(;t>0;){const s=t%1e3;if(s){const t=dt(s,e&&!n);if(n){const e=mt.large[n],o=s>1?"er":"";r=ht(t,n<=1)+" "+e+o+(r?" og ":"")+r}else r=ht(t)+r}t=Math.floor(t/1e3),n++}return r}function pt(t){if(t%100)return ft(t,!0);const e=ft(t);return e.match(/e$/)?e:e+"e"}const mt=X();mt.wordOrdinal=pt,mt.numericOrdinal=function(t){return t.toString()+"."},mt.numberToWords=ft,mt.numberToOrdinal=function(t,e){return 1===t?e?"hel":"hele":2===t?e?"halv":"halve":pt(t)+(e?"dele":"del")};const gt=mt;let St=null;function Nt(t,e=!1){return t===yt.ones[1]?e?"eine":"ein":t}function Et(t){let e=t%1e3,n="",r=yt.ones[Math.floor(e/100)];if(n+=r?Nt(r)+"hundert":"",e%=100,e)if(n+=n?yt.numSep:"",r=yt.ones[e],r)n+=r;else{const t=yt.tens[Math.floor(e/10)];r=yt.ones[e%10],n+=r?Nt(r)+"und"+t:t}return n}function bt(t){if(0===t)return yt.zero;if(t>=Math.pow(10,36))return t.toString();let e=0,n="";for(;t>0;){const r=t%1e3;if(r){const s=Et(t%1e3);if(e){const t=yt.large[e],o=e>1&&r>1?t.match(/e$/)?"n":"en":"";n=Nt(s,e>1)+t+o+n}else n=Nt(s,e>1)+n}t=Math.floor(t/1e3),e++}return n.replace(/ein$/,"eins")}function At(t){if(1===t)return"erste";if(3===t)return"dritte";if(7===t)return"siebte";if(8===t)return"achte";return bt(t)+(t<19?"te":"ste")}const yt=X();yt.wordOrdinal=At,yt.numericOrdinal=function(t){return t.toString()+"."},yt.numberToWords=bt,yt.numberToOrdinal=function(t,e){return 1===t?"eintel":2===t?e?"halbe":"halb":At(t)+"l"};const Tt=yt,Ct=function(t,e,n){return"s"===n&&(e=e.split(" ").map((function(t){return t.replace(/s$/,"")})).join(" "),n=""),t=n?n+" "+t:t,e?e+" "+t:t},_t=function(t,e,n){return t=n&&"s"!==n?n+" "+t:t,e?t+" "+e:t};let It=null;function Ot(t){let e=t%1e3,n="";return n+=xt.ones[Math.floor(e/100)]?xt.ones[Math.floor(e/100)]+xt.numSep+"hundred":"",e%=100,e&&(n+=n?xt.numSep:"",n+=xt.ones[e]||xt.tens[Math.floor(e/10)]+(e%10?xt.numSep+xt.ones[e%10]:"")),n}function Mt(t){if(0===t)return xt.zero;if(t>=Math.pow(10,36))return t.toString();let e=0,n="";for(;t>0;){t%1e3&&(n=Ot(t%1e3)+(e?"-"+xt.large[e]+"-":"")+n),t=Math.floor(t/1e3),e++}return n.replace(/-$/,"")}function Rt(t){let e=Mt(t);return e.match(/one$/)?e=e.slice(0,-3)+"first":e.match(/two$/)?e=e.slice(0,-3)+"second":e.match(/three$/)?e=e.slice(0,-5)+"third":e.match(/five$/)?e=e.slice(0,-4)+"fifth":e.match(/eight$/)?e=e.slice(0,-5)+"eighth":e.match(/nine$/)?e=e.slice(0,-4)+"ninth":e.match(/twelve$/)?e=e.slice(0,-6)+"twelfth":e.match(/ty$/)?e=e.slice(0,-2)+"tieth":e+="th",e}const xt=X();xt.wordOrdinal=Rt,xt.numericOrdinal=function(t){const e=t%100,n=t.toString();if(e>10&&e<20)return n+"th";switch(t%10){case 1:return n+"st";case 2:return n+"nd";case 3:return n+"rd";default:return n+"th"}},xt.numberToWords=Mt,xt.numberToOrdinal=function(t,e){if(1===t)return e?"oneths":"oneth";if(2===t)return e?"halves":"half";const n=Rt(t);return e?n+"s":n};const Lt=xt;let vt=null;function Ft(t){const e=t%1e3,n=Math.floor(e/100),r=wt.special.hundreds[n],s=function(t){const e=t%100;if(e<30)return wt.ones[e];const n=wt.tens[Math.floor(e/10)],r=wt.ones[e%10];return n&&r?n+" y "+r:n||r}(e%100);return 1===n?s?r+"to "+s:r:r&&s?r+" "+s:r||s}const wt=X();wt.numericOrdinal=function(t){const e=nt.getInstance().getParameter("gender");return t.toString()+("f"===e?"a":"o")},wt.numberToWords=function(t){if(0===t)return wt.zero;if(t>=Math.pow(10,36))return t.toString();let e=0,n="";for(;t>0;){const r=t%1e3;if(r){let t=wt.large[e];const s=Ft(r);e?1===r?(t=t.match("/^mil( |$)/")?t:"un "+t,n=t+(n?" "+n:"")):(t=t.replace(/\u00f3n$/,"ones"),n=Ft(r)+" "+t+(n?" "+n:"")):n=s}t=Math.floor(t/1e3),e++}return n},wt.numberToOrdinal=function(t,e){if(t>1999)return t.toString()+"a";if(t<=12)return wt.special.onesOrdinals[t-1];const n=[];if(t>=1e3&&(t-=1e3,n.push("mil\xe9sima")),!t)return n.join(" ");let r=0;return r=Math.floor(t/100),r>0&&(n.push(wt.special.hundredsOrdinals[r-1]),t%=100),t<=12?n.push(wt.special.onesOrdinals[t-1]):(r=Math.floor(t/10),r>0&&(n.push(wt.special.tensOrdinals[r-1]),t%=10),t>0&&n.push(wt.special.onesOrdinals[t-1])),n.join(" ")};const Dt=wt,Pt=function(t,e,n){return t="sans serif "+(n?n+" "+t:t),e?t+" "+e:t};let kt=null;let Ut=null;function Bt(t){let e=t%1e3,n="";if(n+=Vt.ones[Math.floor(e/100)]?Vt.ones[Math.floor(e/100)]+"-cent":"",e%=100,e){n+=n?"-":"";let t=Vt.ones[e];if(t)n+=t;else{const r=Vt.tens[Math.floor(e/10)];r.match(/-dix$/)?(t=Vt.ones[e%10+10],n+=r.replace(/-dix$/,"")+"-"+t):n+=r+(e%10?"-"+Vt.ones[e%10]:"")}}const r=n.match(/s-\w+$/);return r?n.replace(/s-\w+$/,r[0].slice(1)):n.replace(/-un$/,"-et-un")}function Gt(t){if(0===t)return Vt.zero;if(t>=Math.pow(10,36))return t.toString();Vt.special["tens-"+E.getInstance().subiso]&&(Vt.tens=Vt.special["tens-"+E.getInstance().subiso]);let e=0,n="";for(;t>0;){const r=t%1e3;if(r){let t=Vt.large[e];const s=Bt(r);if(t&&t.match(/^mille /)){const r=t.replace(/^mille /,"");n=n.match(RegExp(r))?s+(e?"-mille-":"")+n:n.match(RegExp(r.replace(/s$/,"")))?s+(e?"-mille-":"")+n.replace(r.replace(/s$/,""),r):s+(e?"-"+t+"-":"")+n}else t=1===r&&t?t.replace(/s$/,""):t,n=s+(e?"-"+t+"-":"")+n}t=Math.floor(t/1e3),e++}return n.replace(/-$/,"")}const $t={1:"uni\xe8me",2:"demi",3:"tiers",4:"quart"};function jt(t){if(1===t)return"premi\xe8re";let e=Gt(t);return e.match(/^neuf$/)?e=e.slice(0,-1)+"v":e.match(/cinq$/)?e+="u":e.match(/trois$/)?e+="":(e.match(/e$/)||e.match(/s$/))&&(e=e.slice(0,-1)),e+="i\xe8me",e}const Vt=X();Vt.wordOrdinal=jt,Vt.numericOrdinal=function(t){const e=nt.getInstance().getParameter("gender");return 1===t?t.toString()+("m"===e?"er":"re"):t.toString()+"e"},Vt.numberToWords=Gt,Vt.numberToOrdinal=function(t,e){const n=$t[t]||jt(t);return 3===t?n:e?n+"s":n};const Ht=Vt;let Wt=null;function qt(t){if(0===t)return Xt.zero;if(t>=Math.pow(10,32))return t.toString();let e=0,n="";const r=function(t){let e=t%1e3,n="";return n+=Xt.ones[Math.floor(e/100)]?Xt.ones[Math.floor(e/100)]+Xt.numSep+Xt.special.hundred:"",e%=100,e&&(n+=n?Xt.numSep:"",n+=Xt.ones[e]),n}(t%1e3);if(!(t=Math.floor(t/1e3)))return r;for(;t>0;){const r=t%100;r&&(n=Xt.ones[r]+Xt.numSep+Xt.large[e]+(n?Xt.numSep+n:"")),t=Math.floor(t/100),e++}return r?n+Xt.numSep+r:n}function Yt(t){const e=nt.getInstance().getParameter("gender");if(t<=0)return t.toString();if(t<10)return"f"===e?Xt.special.ordinalsFeminine[t]:Xt.special.ordinalsMasculine[t];return qt(t)+("f"===e?"\u0935\u0940\u0902":"\u0935\u093e\u0901")}const Xt=X();Xt.wordOrdinal=Yt,Xt.numericOrdinal=function(t){const e=nt.getInstance().getParameter("gender");return t>0&&t<10?"f"===e?Xt.special.simpleSmallOrdinalsFeminine[t]:Xt.special.simpleSmallOrdinalsMasculine[t]:t.toString().split("").map((function(t){const e=parseInt(t,10);return isNaN(e)?"":Xt.special.simpleNumbers[e]})).join("")+("f"===e?"\u0935\u0940\u0902":"\u0935\u093e\u0901")},Xt.numberToWords=qt,Xt.numberToOrdinal=function(t,e){return t<=10?Xt.special.smallDenominators[t]:Yt(t)+" \u0905\u0902\u0936"};const Kt=Xt;let zt=null;function Jt(t){let e=t%1e4,n="";return n+=ee.ones[Math.floor(e/1e3)]?1===Math.floor(e/1e3)?"\ucc9c":ee.ones[Math.floor(e/1e3)]+"\ucc9c":"",e%=1e3,e&&(n+=ee.ones[Math.floor(e/100)]?1===Math.floor(e/100)?"\ubc31":ee.ones[Math.floor(e/100)]+"\ubc31":"",e%=100,n+=ee.tens[Math.floor(e/10)]+(e%10?ee.ones[e%10]:"")),n}function Zt(t){if(0===t)return ee.zero;if(t>=Math.pow(10,36))return t.toString();let e=0,n="";for(;t>0;){t%1e4&&(n=Jt(t%1e4)+(e?ee.large[e]+ee.numSep:"")+n),t=Math.floor(t/1e4),e++}return n.replace(/ $/,"")}function Qt(t,e){return 1===t?"\uccab\ubc88\uc9f8":te(t)+"\ubc88\uc9f8"}function te(t){const e=Zt(t),n=Zt(t%=100);if(!n||!t)return e;const r=20===t?"\uc2a4\ubb34":ee.tens[10+Math.floor(t/10)],s=ee.ones[10+Math.floor(t%10)];return e.slice(0,-n.length)+r+s}const ee=X();ee.wordOrdinal=te,ee.numericOrdinal=function(t){return Qt(t)},ee.numberToWords=Zt,ee.numberToOrdinal=Qt;const ne=ee;let re=null;function se(t){let e=t%1e3,n="";if(n+=ce.ones[Math.floor(e/100)]?ce.ones[Math.floor(e/100)]+ce.numSep+"cento":"",e%=100,e){n+=n?ce.numSep:"";const t=ce.ones[e];if(t)n+=t;else{let t=ce.tens[Math.floor(e/10)];const r=e%10;1!==r&&8!==r||(t=t.slice(0,-1)),n+=t,n+=r?ce.numSep+ce.ones[e%10]:""}}return n}function oe(t){if(0===t)return ce.zero;if(t>=Math.pow(10,36))return t.toString();if(1===t&&nt.getInstance().getParameter("fraction"))return"un";let e=0,n="";for(;t>0;){t%1e3&&(n=se(t%1e3)+(e?"-"+ce.large[e]+"-":"")+n),t=Math.floor(t/1e3),e++}return n.replace(/-$/,"")}function ie(t){const e="m"===nt.getInstance().getParameter("gender")?"o":"a";let n=ce.special.onesOrdinals[t];return n?n.slice(0,-1)+e:(n=oe(t),n.slice(0,-1)+"esim"+e)}const ce=X();ce.wordOrdinal=ie,ce.numericOrdinal=function(t){const e=nt.getInstance().getParameter("gender");return t.toString()+("m"===e?"o":"a")},ce.numberToWords=oe,ce.numberToOrdinal=function(t,e){if(2===t)return e?"mezzi":"mezzo";const n=ie(t);if(!e)return n;const r=n.match(/o$/)?"i":"e";return n.slice(0,-1)+r};const ae=ce,le=function(t,e,n){return t.match(/^[a-zA-Z]$/)&&(e=e.replace("cerchiato","cerchiata")),t=n?t+" "+n:t,e?t+" "+e:t};let ue=null;function he(t,e=!1){let n=t%1e3,r="";const s=Math.floor(n/100),o=pe.ones[s];if(r+=o?(1===s?"":o)+"hundre":"",n%=100,n){if(r+=r?"og":"",e){const t=pe.special.smallOrdinals[n];if(t)return r+t;if(n%10)return r+pe.tens[Math.floor(n/10)]+pe.special.smallOrdinals[n%10]}r+=pe.ones[n]||pe.tens[Math.floor(n/10)]+(n%10?pe.ones[n%10]:"")}return e?de(r):r}function de(t){const e=pe.special.endOrdinal[0];return"a"===e&&t.match(/en$/)?t.slice(0,-2)+pe.special.endOrdinal:t.match(/(d|n)$/)||t.match(/hundre$/)?t+"de":t.match(/i$/)?t+pe.special.endOrdinal:"a"===e&&t.match(/e$/)?t.slice(0,-1)+pe.special.endOrdinal:(t.match(/e$/),t+"nde")}function fe(t){return Ne(t,!0)}const pe=X();pe.wordOrdinal=fe,pe.numericOrdinal=function(t){return t.toString()+"."},pe.numberToWords=Ne,pe.numberToOrdinal=function(t,e){return fe(t)};const me=pe;function ge(t,e=!1){return t===pe.ones[1]?"ein"===t?"eitt ":e?"et":"ett":t}function Se(t,e=!1){let n=t%1e3,r="",s=pe.ones[Math.floor(n/100)];if(r+=s?ge(s)+"hundre":"",n%=100,n){if(r+=r?"og":"",e){const t=pe.special.smallOrdinals[n];if(t)return r+t}if(s=pe.ones[n],s)r+=s;else{const t=pe.tens[Math.floor(n/10)];s=pe.ones[n%10],r+=s?s+"og"+t:t}}return e?de(r):r}function Ne(t,e=!1){const n="alt"===E.getInstance().subiso?function(t,e=!1){if(0===t)return e?pe.special.smallOrdinals[0]:pe.zero;if(t>=Math.pow(10,36))return t.toString();let n=0,r="";for(;t>0;){const s=t%1e3;if(s){const o=Se(t%1e3,!n&&e);!n&&e&&(e=!e),r=(1===n?ge(o,!0):o)+(n>1?pe.numSep:"")+(n?pe.large[n]+(n>1&&s>1?"er":""):"")+(n>1&&r?pe.numSep:"")+r}t=Math.floor(t/1e3),n++}return e?r+(r.match(/tusen$/)?"de":"te"):r}(t,e):function(t,e=!1){if(0===t)return e?pe.special.smallOrdinals[0]:pe.zero;if(t>=Math.pow(10,36))return t.toString();let n=0,r="";for(;t>0;){const s=t%1e3;if(s){const o=he(t%1e3,!n&&e);!n&&e&&(e=!e),r=o+(n?" "+pe.large[n]+(n>1&&s>1?"er":"")+(r?" ":""):"")+r}t=Math.floor(t/1e3),n++}return e?r+(r.match(/tusen$/)?"de":"te"):r}(t,e);return n}let Ee=null;function be(t){return t.toString().split("").map((function(t){return Ae.ones[parseInt(t,10)]})).join("")}const Ae=X();Ae.numberToWords=be,Ae.numberToOrdinal=be;const ye=Ae,Te=function(t){return t.match(RegExp("^"+Re.ALPHABETS.languagePrefix.english))?t.slice(1):t},Ce=function(t,e,n){return t=Te(t),e?t+e:t},_e=function(t,e,n){return e+Te(t)},Ie=function(t,e,n){return e+(n||"")+(t=Te(t))+"\u283b"},Oe=function(t,e,n){return e+(n||"")+(t=Te(t))+"\u283b\u283b"},Me=function(t,e,n){return e+(t=Te(t))+"\u283e"};let Re=null;let xe=null;function Le(t){let e=t%1e3,n="";const r=Math.floor(e/100);return n+=we.ones[r]?(1===r?"":we.ones[r]+we.numSep)+"hundra":"",e%=100,e&&(n+=n?we.numSep:"",n+=we.ones[e]||we.tens[Math.floor(e/10)]+(e%10?we.numSep+we.ones[e%10]:"")),n}function ve(t,e=!1){if(0===t)return we.zero;if(t>=Math.pow(10,36))return t.toString();let n=0,r="";for(;t>0;){const s=t%1e3;if(s){const o=we.large[n],i=s>1&&n>1&&!e?"er":"";r=(1===n&&1===s?"":(n>1&&1===s?"en":Le(t%1e3))+(n>1?" ":""))+(n?o+i+(n>1?" ":""):"")+r}t=Math.floor(t/1e3),n++}return r.replace(/ $/,"")}function Fe(t){let e=ve(t,!0);return e.match(/^noll$/)?e="nollte":e.match(/ett$/)?e=e.replace(/ett$/,"f\xf6rsta"):e.match(/tv\xe5$/)?e=e.replace(/tv\xe5$/,"andra"):e.match(/tre$/)?e=e.replace(/tre$/,"tredje"):e.match(/fyra$/)?e=e.replace(/fyra$/,"fj\xe4rde"):e.match(/fem$/)?e=e.replace(/fem$/,"femte"):e.match(/sex$/)?e=e.replace(/sex$/,"sj\xe4tte"):e.match(/sju$/)?e=e.replace(/sju$/,"sjunde"):e.match(/\xe5tta$/)?e=e.replace(/\xe5tta$/,"\xe5ttonde"):e.match(/nio$/)?e=e.replace(/nio$/,"nionde"):e.match(/tio$/)?e=e.replace(/tio$/,"tionde"):e.match(/elva$/)?e=e.replace(/elva$/,"elfte"):e.match(/tolv$/)?e=e.replace(/tolv$/,"tolfte"):e.match(/tusen$/)?e=e.replace(/tusen$/,"tusonde"):e.match(/jard$/)||e.match(/jon$/)?e+="te":e+="de",e}const we=X();we.wordOrdinal=Fe,we.numericOrdinal=function(t){const e=t.toString();return e.match(/11$|12$/)?e+":e":e+(e.match(/1$|2$/)?":a":":e")},we.numberToWords=ve,we.numberToOrdinal=function(t,e){if(1===t)return"hel";if(2===t)return e?"halva":"halv";let n=Fe(t);return n=n.match(/de$/)?n.replace(/de$/,""):n,n+(e?"delar":"del")};const De=we;let Pe=null;const ke={ca:function(){return ut||(ut=function(){const t=z();return t.NUMBERS=at,t.COMBINERS.sansserif=lt,t.FUNCTIONS.fracNestDepth=t=>!1,t.FUNCTIONS.combineRootIndex=Z,t.FUNCTIONS.combineNestedRadical=(t,e,n)=>t+n,t.FUNCTIONS.fontRegexp=t=>RegExp("^"+t+" "),t.FUNCTIONS.plural=t=>/.*os$/.test(t)?t+"sos":/.*s$/.test(t)?t+"os":/.*ga$/.test(t)?t.slice(0,-2)+"gues":/.*\xe7a$/.test(t)?t.slice(0,-2)+"ces":/.*ca$/.test(t)?t.slice(0,-2)+"ques":/.*ja$/.test(t)?t.slice(0,-2)+"ges":/.*qua$/.test(t)?t.slice(0,-3)+"q\xfces":/.*a$/.test(t)?t.slice(0,-1)+"es":/.*(e|i)$/.test(t)?t+"ns":/.*\xed$/.test(t)?t.slice(0,-1)+"ins":t+"s",t.FUNCTIONS.si=(t,e)=>(e.match(/^metre/)&&(t=t.replace(/a$/,"\xe0").replace(/o$/,"\xf2").replace(/i$/,"\xed")),t+e),t.ALPHABETS.combiner=W.prefixCombiner,t}()),ut},da:function(){return St||(St=function(){const t=z();return t.NUMBERS=gt,t.FUNCTIONS.radicalNestDepth=J,t.FUNCTIONS.fontRegexp=e=>e===t.ALPHABETS.capPrefix.default?RegExp("^"+e+" "):RegExp(" "+e+"$"),t.ALPHABETS.combiner=W.postfixCombiner,t.ALPHABETS.digitTrans.default=gt.numberToWords,t}()),St},de:function(){return It||(It=function(){const t=z();return t.NUMBERS=Tt,t.COMBINERS.germanPostfix=_t,t.ALPHABETS.combiner=Ct,t.FUNCTIONS.radicalNestDepth=e=>e>1?t.NUMBERS.numberToWords(e)+"fach":"",t.FUNCTIONS.combineRootIndex=(t,e)=>{const n=e?e+"wurzel":"";return t.replace("Wurzel",n)},t.FUNCTIONS.combineNestedRadical=(t,e,n)=>{const r=(e?e+" ":"")+(t=n.match(/exponent$/)?t+"r":t);return n.match(/ /)?n.replace(/ /," "+r+" "):r+" "+n},t.FUNCTIONS.fontRegexp=function(t){return t=t.split(" ").map((function(t){return t.replace(/s$/,"(|s)")})).join(" "),new RegExp("((^"+t+" )|( "+t+"$))")},t.CORRECTIONS.correctOne=t=>t.replace(/^eins$/,"ein"),t.CORRECTIONS.localFontNumber=t=>Q(t).split(" ").map((function(t){return t.replace(/s$/,"")})).join(" "),t.CORRECTIONS.lowercase=t=>t.toLowerCase(),t.CORRECTIONS.article=t=>{const e=nt.getInstance().getParameter("case"),n=nt.getInstance().getParameter("plural");return"dative"===e?{der:"dem",die:n?"den":"der",das:"dem"}[t]:t},t.CORRECTIONS.masculine=t=>"dative"===nt.getInstance().getParameter("case")?t+"n":t,t}()),It},en:function(){return vt||(vt=function(){const t=z();return t.NUMBERS=Lt,t.FUNCTIONS.radicalNestDepth=J,t.FUNCTIONS.plural=t=>/.*s$/.test(t)?t:t+"s",t.ALPHABETS.combiner=W.prefixCombiner,t.ALPHABETS.digitTrans.default=Lt.numberToWords,t.CORRECTIONS.article=t=>nt.getInstance().getParameter("noArticle")?"":t,t}()),vt},es:function(){return kt||(kt=function(){const t=z();return t.NUMBERS=Dt,t.COMBINERS.sansserif=Pt,t.FUNCTIONS.fracNestDepth=t=>!1,t.FUNCTIONS.combineRootIndex=Z,t.FUNCTIONS.combineNestedRadical=(t,e,n)=>t+n,t.FUNCTIONS.fontRegexp=t=>RegExp("^"+t+" "),t.FUNCTIONS.plural=t=>/.*(a|e|i|o|u)$/.test(t)?t+"s":/.*z$/.test(t)?t.slice(0,-1)+"ces":/.*c$/.test(t)?t.slice(0,-1)+"ques":/.*g$/.test(t)?t+"ues":/.*\u00f3n$/.test(t)?t.slice(0,-2)+"ones":t+"es",t.FUNCTIONS.si=(t,e)=>(e.match(/^metro/)&&(t=t.replace(/a$/,"\xe1").replace(/o$/,"\xf3").replace(/i$/,"\xed")),t+e),t.ALPHABETS.combiner=W.prefixCombiner,t}()),kt},euro:function(){return Ut||(Ut=z()),Ut},fr:function(){return Wt||(Wt=function(){const t=z();return t.NUMBERS=Ht,t.FUNCTIONS.radicalNestDepth=J,t.FUNCTIONS.combineRootIndex=Z,t.FUNCTIONS.combineNestedFraction=(t,e,n)=>n.replace(/ $/g,"")+e+t,t.FUNCTIONS.combineNestedRadical=(t,e,n)=>n+" "+t,t.FUNCTIONS.fontRegexp=t=>RegExp(" (en |)"+t+"$"),t.FUNCTIONS.plural=t=>/.*s$/.test(t)?t:t+"s",t.CORRECTIONS.article=t=>nt.getInstance().getParameter("noArticle")?"":t,t.ALPHABETS.combiner=W.romanceCombiner,t.SUBISO={default:"fr",current:"fr",all:["fr","be","ch"]},t}()),Wt},hi:function(){return zt||(zt=function(){const t=z();return t.NUMBERS=Kt,t.ALPHABETS.combiner=W.prefixCombiner,t.FUNCTIONS.radicalNestDepth=J,t}()),zt},it:function(){return ue||(ue=function(){const t=z();return t.NUMBERS=ae,t.COMBINERS.italianPostfix=le,t.FUNCTIONS.radicalNestDepth=J,t.FUNCTIONS.combineRootIndex=Z,t.FUNCTIONS.combineNestedFraction=(t,e,n)=>n.replace(/ $/g,"")+e+t,t.FUNCTIONS.combineNestedRadical=(t,e,n)=>n+" "+t,t.FUNCTIONS.fontRegexp=t=>RegExp(" (en |)"+t+"$"),t.ALPHABETS.combiner=W.romanceCombiner,t}()),ue},ko:function(){return re||(re=function(){const t=z();return t.NUMBERS=ne,t.FUNCTIONS.radicalNestDepth=J,t.FUNCTIONS.plural=function(t){return t},t.FUNCTIONS.si=(t,e)=>t+e,t.FUNCTIONS.combineRootIndex=function(t,e){return t+e},t.ALPHABETS.combiner=W.prefixCombiner,t.ALPHABETS.digitTrans.default=ne.numberToWords,t.CORRECTIONS.postposition=t=>{if(["\uac19\ub2e4","\ub294","\uc640","\ub97c","\ub85c"].includes(t))return t;const e=t.slice(-1);let n=(e.charCodeAt(0)-44032)%28>0;return e.match(/[r,l,n,m,1,3,6,7,8,0]/i)&&(n=!0),nt.getInstance().setParameter("final",n),t},t.CORRECTIONS.article=t=>{const e=nt.getInstance().getParameter("final");e&&nt.getInstance().setParameter("final",!1),"\uac19\ub2e4"===t&&(t="\ub294");const n={\ub294:"\uc740",\uc640:"\uacfc",\ub97c:"\uc744",\ub85c:"\uc73c\ub85c"}[t];return void 0!==n&&e?n:t},t}()),re},nb:function(){return Ee||(Ee=function(){const t=z();return t.NUMBERS=me,t.ALPHABETS.combiner=W.prefixCombiner,t.ALPHABETS.digitTrans.default=me.numberToWords,t.FUNCTIONS.radicalNestDepth=J,t}()),Ee},nn:function(){return xe||(xe=function(){const t=z();return t.NUMBERS=me,t.ALPHABETS.combiner=W.prefixCombiner,t.ALPHABETS.digitTrans.default=me.numberToWords,t.FUNCTIONS.radicalNestDepth=J,t.SUBISO={default:"",current:"",all:["","alt"]},t}()),xe},sv:function(){return Pe||(Pe=function(){const t=z();return t.NUMBERS=De,t.FUNCTIONS.radicalNestDepth=J,t.FUNCTIONS.fontRegexp=function(t){return new RegExp("((^"+t+" )|( "+t+"$))")},t.ALPHABETS.combiner=W.prefixCombiner,t.ALPHABETS.digitTrans.default=De.numberToWords,t.CORRECTIONS.correctOne=t=>t.replace(/^ett$/,"en"),t}()),Pe},nemeth:function(){return Re||(Re=function(){const t=z();return t.NUMBERS=ye,t.COMBINERS={postfixCombiner:Ce,germanCombiner:_e,embellishCombiner:Ie,doubleEmbellishCombiner:Oe,parensCombiner:Me},t.FUNCTIONS.fracNestDepth=t=>!1,t.FUNCTIONS.fontRegexp=t=>RegExp("^"+t),t.FUNCTIONS.si=V,t.ALPHABETS.combiner=(t,e,n)=>e?e+n+t:Te(t),t.ALPHABETS.digitTrans={default:ye.numberToWords},t}()),Re}};function Ue(){const t=function(){const t=g.L.ensureLocale(E.getInstance().locale,E.getInstance().defaultLocale);return E.getInstance().locale=t,ke[t]()}();if(function(t){const e=E.getInstance().subiso;-1===t.SUBISO.all.indexOf(e)&&(E.getInstance().subiso=t.SUBISO.default);t.SUBISO.current=E.getInstance().subiso}(t),t){for(const e of Object.getOwnPropertyNames(t))K[e]=t[e];for(const[e,n]of Object.entries(t.CORRECTIONS))nt.getInstance().setCorrection(e,n)}}function Be(){return"undefined"!=typeof window&&"ActiveXObject"in window&&"clipboardData"in window&&(Ve(p.Z.mathmapsIePath),$e(),!0)}const Ge=null;function $e(t){Ve(p.Z.WGXpath),je(t)}function je(t,e){let n=e||1;"undefined"==typeof wgxpath&&n<10?setTimeout((function(){je(t,n++)}),200):n>=10||(p.Z.wgxpath=wgxpath,t?p.Z.wgxpath.install({document}):p.Z.wgxpath.install(),y.evaluate=document.evaluate,y.result=XPathResult,y.createNSResolver=document.createNSResolver)}function Ve(t){const e=p.Z.document.createElement("script");e.type="text/javascript",e.src=t,p.Z.document.head?p.Z.document.head.appendChild(e):p.Z.document.body.appendChild(e)}function He(t){return t.match("/$")?t:t+"/"}function We(t,e="json"){return He(p.Z.jsonPath)+t+(e.match(/^\./)?e:"."+e)}var qe,Ye,Xe;function Ke(t){const e=t.toString(16).toUpperCase();return e.length>3?e:("000"+e).slice(-4)}function ze([t,e],n){const r=parseInt(t,16),s=parseInt(e,16),o=[];for(let t=r;t<=s;t++){let e=Ke(t);!1!==n[e]&&(e=n[e]||e,o.push(e))}return o}function Je(t,e={}){return ze(t,e).map((t=>String.fromCodePoint(parseInt(t,16))))}!function(t){t.BOLD="bold",t.BOLDFRAKTUR="bold-fraktur",t.BOLDITALIC="bold-italic",t.BOLDSCRIPT="bold-script",t.DOUBLESTRUCK="double-struck",t.DOUBLESTRUCKITALIC="double-struck-italic",t.FULLWIDTH="fullwidth",t.FRAKTUR="fraktur",t.ITALIC="italic",t.MONOSPACE="monospace",t.NORMAL="normal",t.SCRIPT="script",t.SANSSERIF="sans-serif",t.SANSSERIFITALIC="sans-serif-italic",t.SANSSERIFBOLD="sans-serif-bold",t.SANSSERIFBOLDITALIC="sans-serif-bold-italic"}(qe||(qe={})),function(t){t.SUPER="super",t.SUB="sub",t.CIRCLED="circled",t.PARENTHESIZED="parenthesized",t.PERIOD="period",t.NEGATIVECIRCLED="negative-circled",t.DOUBLECIRCLED="double-circled",t.CIRCLEDSANSSERIF="circled-sans-serif",t.NEGATIVECIRCLEDSANSSERIF="negative-circled-sans-serif",t.COMMA="comma",t.SQUARED="squared",t.NEGATIVESQUARED="negative-squared"}(Ye||(Ye={})),function(t){t.LATINCAP="latinCap",t.LATINSMALL="latinSmall",t.GREEKCAP="greekCap",t.GREEKSMALL="greekSmall",t.DIGIT="digit"}(Xe||(Xe={}));const Ze=[{interval:["1D400","1D419"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.BOLD},{interval:["1D41A","1D433"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.BOLD},{interval:["1D56C","1D585"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.BOLDFRAKTUR},{interval:["1D586","1D59F"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.BOLDFRAKTUR},{interval:["1D468","1D481"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.BOLDITALIC},{interval:["1D482","1D49B"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.BOLDITALIC},{interval:["1D4D0","1D4E9"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.BOLDSCRIPT},{interval:["1D4EA","1D503"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.BOLDSCRIPT},{interval:["1D538","1D551"],base:Xe.LATINCAP,subst:{"1D53A":"2102","1D53F":"210D","1D545":"2115","1D547":"2119","1D548":"211A","1D549":"211D","1D551":"2124"},capital:!0,category:"Lu",font:qe.DOUBLESTRUCK},{interval:["1D552","1D56B"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.DOUBLESTRUCK},{interval:["1D504","1D51D"],base:Xe.LATINCAP,subst:{"1D506":"212D","1D50B":"210C","1D50C":"2111","1D515":"211C","1D51D":"2128"},capital:!0,category:"Lu",font:qe.FRAKTUR},{interval:["1D51E","1D537"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.FRAKTUR},{interval:["FF21","FF3A"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.FULLWIDTH},{interval:["FF41","FF5A"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.FULLWIDTH},{interval:["1D434","1D44D"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.ITALIC},{interval:["1D44E","1D467"],base:Xe.LATINSMALL,subst:{"1D455":"210E"},capital:!1,category:"Ll",font:qe.ITALIC},{interval:["1D670","1D689"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.MONOSPACE},{interval:["1D68A","1D6A3"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.MONOSPACE},{interval:["0041","005A"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.NORMAL},{interval:["0061","007A"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.NORMAL},{interval:["1D49C","1D4B5"],base:Xe.LATINCAP,subst:{"1D49D":"212C","1D4A0":"2130","1D4A1":"2131","1D4A3":"210B","1D4A4":"2110","1D4A7":"2112","1D4A8":"2133","1D4AD":"211B"},capital:!0,category:"Lu",font:qe.SCRIPT},{interval:["1D4B6","1D4CF"],base:Xe.LATINSMALL,subst:{"1D4BA":"212F","1D4BC":"210A","1D4C4":"2134"},capital:!1,category:"Ll",font:qe.SCRIPT},{interval:["1D5A0","1D5B9"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.SANSSERIF},{interval:["1D5BA","1D5D3"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.SANSSERIF},{interval:["1D608","1D621"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.SANSSERIFITALIC},{interval:["1D622","1D63B"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.SANSSERIFITALIC},{interval:["1D5D4","1D5ED"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.SANSSERIFBOLD},{interval:["1D5EE","1D607"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.SANSSERIFBOLD},{interval:["1D63C","1D655"],base:Xe.LATINCAP,subst:{},capital:!0,category:"Lu",font:qe.SANSSERIFBOLDITALIC},{interval:["1D656","1D66F"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"Ll",font:qe.SANSSERIFBOLDITALIC},{interval:["0391","03A9"],base:Xe.GREEKCAP,subst:{"03A2":"03F4"},capital:!0,category:"Lu",font:qe.NORMAL},{interval:["03B0","03D0"],base:Xe.GREEKSMALL,subst:{"03B0":"2207","03CA":"2202","03CB":"03F5","03CC":"03D1","03CD":"03F0","03CE":"03D5","03CF":"03F1","03D0":"03D6"},capital:!1,category:"Ll",font:qe.NORMAL},{interval:["1D6A8","1D6C0"],base:Xe.GREEKCAP,subst:{},capital:!0,category:"Lu",font:qe.BOLD},{interval:["1D6C1","1D6E1"],base:Xe.GREEKSMALL,subst:{},capital:!1,category:"Ll",font:qe.BOLD},{interval:["1D6E2","1D6FA"],base:Xe.GREEKCAP,subst:{},capital:!0,category:"Lu",font:qe.ITALIC},{interval:["1D6FB","1D71B"],base:Xe.GREEKSMALL,subst:{},capital:!1,category:"Ll",font:qe.ITALIC},{interval:["1D71C","1D734"],base:Xe.GREEKCAP,subst:{},capital:!0,category:"Lu",font:qe.BOLDITALIC},{interval:["1D735","1D755"],base:Xe.GREEKSMALL,subst:{},capital:!1,category:"Ll",font:qe.BOLDITALIC},{interval:["1D756","1D76E"],base:Xe.GREEKCAP,subst:{},capital:!0,category:"Lu",font:qe.SANSSERIFBOLD},{interval:["1D76F","1D78F"],base:Xe.GREEKSMALL,subst:{},capital:!1,category:"Ll",font:qe.SANSSERIFBOLD},{interval:["1D790","1D7A8"],base:Xe.GREEKCAP,subst:{},capital:!0,category:"Lu",font:qe.SANSSERIFBOLDITALIC},{interval:["1D7A9","1D7C9"],base:Xe.GREEKSMALL,subst:{},capital:!1,category:"Ll",font:qe.SANSSERIFBOLDITALIC},{interval:["0030","0039"],base:Xe.DIGIT,subst:{},offset:0,category:"Nd",font:qe.NORMAL},{interval:["2070","2079"],base:Xe.DIGIT,subst:{2071:"00B9",2072:"00B2",2073:"00B3"},offset:0,category:"No",font:Ye.SUPER},{interval:["2080","2089"],base:Xe.DIGIT,subst:{},offset:0,category:"No",font:Ye.SUB},{interval:["245F","2473"],base:Xe.DIGIT,subst:{"245F":"24EA"},offset:0,category:"No",font:Ye.CIRCLED},{interval:["3251","325F"],base:Xe.DIGIT,subst:{},offset:21,category:"No",font:Ye.CIRCLED},{interval:["32B1","32BF"],base:Xe.DIGIT,subst:{},offset:36,category:"No",font:Ye.CIRCLED},{interval:["2474","2487"],base:Xe.DIGIT,subst:{},offset:1,category:"No",font:Ye.PARENTHESIZED},{interval:["2487","249B"],base:Xe.DIGIT,subst:{2487:"1F100"},offset:0,category:"No",font:Ye.PERIOD},{interval:["2775","277F"],base:Xe.DIGIT,subst:{2775:"24FF"},offset:0,category:"No",font:Ye.NEGATIVECIRCLED},{interval:["24EB","24F4"],base:Xe.DIGIT,subst:{},offset:11,category:"No",font:Ye.NEGATIVECIRCLED},{interval:["24F5","24FE"],base:Xe.DIGIT,subst:{},offset:1,category:"No",font:Ye.DOUBLECIRCLED},{interval:["277F","2789"],base:Xe.DIGIT,subst:{"277F":"1F10B"},offset:0,category:"No",font:Ye.CIRCLEDSANSSERIF},{interval:["2789","2793"],base:Xe.DIGIT,subst:{2789:"1F10C"},offset:0,category:"No",font:Ye.NEGATIVECIRCLEDSANSSERIF},{interval:["FF10","FF19"],base:Xe.DIGIT,subst:{},offset:0,category:"Nd",font:qe.FULLWIDTH},{interval:["1D7CE","1D7D7"],base:Xe.DIGIT,subst:{},offset:0,category:"Nd",font:qe.BOLD},{interval:["1D7D8","1D7E1"],base:Xe.DIGIT,subst:{},offset:0,category:"Nd",font:qe.DOUBLESTRUCK},{interval:["1D7E2","1D7EB"],base:Xe.DIGIT,subst:{},offset:0,category:"Nd",font:qe.SANSSERIF},{interval:["1D7EC","1D7F5"],base:Xe.DIGIT,subst:{},offset:0,category:"Nd",font:qe.SANSSERIFBOLD},{interval:["1D7F6","1D7FF"],base:Xe.DIGIT,subst:{},offset:0,category:"Nd",font:qe.MONOSPACE},{interval:["1F101","1F10A"],base:Xe.DIGIT,subst:{},offset:0,category:"No",font:Ye.COMMA},{interval:["24B6","24CF"],base:Xe.LATINCAP,subst:{},capital:!0,category:"So",font:Ye.CIRCLED},{interval:["24D0","24E9"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"So",font:Ye.CIRCLED},{interval:["1F110","1F129"],base:Xe.LATINCAP,subst:{},capital:!0,category:"So",font:Ye.PARENTHESIZED},{interval:["249C","24B5"],base:Xe.LATINSMALL,subst:{},capital:!1,category:"So",font:Ye.PARENTHESIZED},{interval:["1F130","1F149"],base:Xe.LATINCAP,subst:{},capital:!0,category:"So",font:Ye.SQUARED},{interval:["1F170","1F189"],base:Xe.LATINCAP,subst:{},capital:!0,category:"So",font:Ye.NEGATIVESQUARED},{interval:["1F150","1F169"],base:Xe.LATINCAP,subst:{},capital:!0,category:"So",font:Ye.NEGATIVECIRCLED}],Qe=new Map;function tn(t,e){return t+e.split("-").map((t=>t[0].toUpperCase()+t.slice(1))).join("")}for(const t of Ze){const e=tn(t.base,t.font),n=Je(t.interval,t.subst);let r=Qe.get(e);r?r.unicode=r.unicode.concat(n):(r=t,r.unicode=n,Qe.set(e,r))}var en;!function(t){t.CALIGRAPHIC="caligraphic",t.CALIGRAPHICBOLD="caligraphic-bold",t.OLDSTYLE="oldstyle",t.OLDSTYLEBOLD="oldstyle-bold",t.UNKNOWN="unknown"}(en||(en={}));const nn=Object.assign(Object.assign(Object.assign({},qe),en),Ye);var rn;!function(t){t.ALLLETTERS="allLetters",t.D="d",t.BAR="bar",t.TILDE="tilde"}(rn||(rn={}));const sn=Object.assign(Object.assign({},Xe),rn);var on,cn,an=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(r=Object.getOwnPropertySymbols(t);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(t,r[s])&&(n[r[s]]=t[r[s]])}return n};!function(t){t.functionApplication=String.fromCodePoint(8289),t.invisibleTimes=String.fromCodePoint(8290),t.invisibleComma=String.fromCodePoint(8291),t.invisiblePlus=String.fromCodePoint(8292)}(on||(on={}));class ln extends Map{get(t){return super.get(t)||{role:"unknown",type:"unknown",font:nn.UNKNOWN}}}class un extends Map{set(t,e,n=""){return super.set(this.secKey(e,t),n||e),this}has(t,e){return super.has(this.secKey(e,t))}get(t,e){return super.get(this.secKey(e,t))}secKey(t,e){return e?`${t} ${e}`:`${t}`}}function hn(t,e){for(const n of t)cn.Meaning.set(n,{role:e.role||"unknown",type:e.type||"unknown",font:e.font||nn.UNKNOWN}),e.secondary&&cn.Secondary.set(n,e.secondary)}function dn(t,e,n=1){const r={},s=function(t){let e=[];for(const n of t)Array.isArray(n)?e=e.concat(ze(n,{}).map((t=>parseInt(t,16)))):e.push(parseInt(n,16));return e}(e);for(const e of s)r[e]||(t.set(String.fromCodePoint(e),String.fromCodePoint(e+n)),r[e]=!0,r[e+n]=!0)}!function(t){t.Meaning=new ln,t.Secondary=new un,t.FencesHoriz=new Map,t.FencesVert=new Map}(cn||(cn={}));const fn=["cos","cot","csc","sec","sin","tan","arccos","arccot","arccsc","arcsec","arcsin","arctan"].concat(["cosh","coth","csch","sech","sinh","tanh","arcosh","arcoth","arcsch","arsech","arsinh","artanh"],["deg","det","dim","hom","ker","Tr"],["log","ln","lg","exp","gcd","lcm","arg","im","re","Pr"]);function pn(t,e,n,r,s,o=[],i={},c={}){const a=Qe.get(tn(t,r));a&&(a.unicode.forEach((t=>{cn.Meaning.set(t,{type:e,role:n,font:s}),o.forEach((e=>cn.Secondary.set(t,e)))})),function(t,e){for(const[n,r]of Object.entries(e)){const e=t[n];void 0!==e&&cn.Meaning.set(e,r)}}(a.unicode,i),function(t,e){for(const[n,r]of Object.entries(e)){const e=t[n];void 0!==e&&cn.Secondary.set(e,r)}}(a.unicode,c))}[{set:["23","25","26","40","5c","a1","a7","b6","bf","2017",["2022","2025"],"2027","2030","2031","203b","203c",["2041","2043"],["2047","2049"],["204b","204d"],"2050","2055","2056",["2058","205e"],"2234","2235","fe45","fe46","fe5f","fe60","fe68","fe6a","fe6b","ff03","ff05","ff06","ff0f","ff20","ff3c"],type:"punctuation",role:"unknown"},{set:["22","ab","bb","2dd",["2018","201f"],"2039","203a",["301d","301f"],"fe10","ff02","ff07"],type:"punctuation",role:"quotes"},{set:["3b","204f","2a1f","2a3e","fe14","fe54","ff1b"],type:"punctuation",role:"semicolon"},{set:["3f","203d","fe16","fe56","ff1f"],type:"punctuation",role:"question"},{set:["21","fe15","fe57","ff01"],type:"punctuation",role:"exclamation"},{set:["5e","60","a8","aa","b4","ba","2c7",["2d8","2da"],"2040","207a","207d","207e","ff3e","ff40"],type:"punctuation",role:"overaccent"},{set:["b8","2db","2038","203f","2054","208a","208d","208e"],type:"punctuation",role:"underaccent"},{set:["3a","2982","fe13","fe30","fe55","ff1a"],type:"punctuation",role:"colon"},{set:["2c","2063","fe50","ff0c"],type:"punctuation",role:"comma"},{set:["2026",["22ee","22f1"],"fe19"],type:"punctuation",role:"ellipsis"},{set:["2e","fe52","ff0e"],type:"punctuation",role:"fullstop"},{set:["2d","5f","af",["2010","2015"],"203e","203e","207b","208b","2212","2796",["fe49","fe4f"],"fe58","fe63","ff0d","ff3f","ffe3"],type:"operator",role:"dash",secondary:sn.BAR},{set:["7e","2dc","2f7","303","330","334","2053","223c","223d","301c","ff5e"],type:"operator",role:"tilde",secondary:sn.TILDE},{set:["27","2b9","2ba",["2032","2037"],"2057"],type:"punctuation",role:"prime"},{set:["b0"],type:"punctuation",role:"degree"},{set:["2b","b1","2064","2213","2214","2228","222a",["228c","228e"],"2294","2295","229d","229e","22bb","22bd","22c4","22ce","22d3","2304","271b","271c","2795","27cf","29fa","29fb","29fe",["2a22","2a28"],"2a2d","2a2e","2a39","2a42","2a45","2a46","2a48","2a4a","2a4c","2a4f","2a50","2a52","2a54","2a56","2a57","2a59","2a5b","2a5d",["2a61","2a63"],"2adc","2add","fe62","ff0b"],type:"operator",role:"addition"},{set:["2a","b7","d7","2020","2021","204e","2051","2062",["2217","2219"],"2227","2229","2240","2293","2297",["2299","229b"],"22a0","22a1","22b9","22bc",["22c5","22cc"],"22cf","22d2","22d4","2303","2305","2306","25cb","2715","2716","27ce","27d1",["29d1","29d7"],"29e2","2a1d",["2a2f","2a37"],["2a3b","2a3d"],"2a40","2a43","2a44","2a47","2a49","2a4b","2a4d","2a4e","2a51","2a53","2a55","2a58","2a5a","2a5c",["2a5e","2a60"],"2ada","2adb","fe61","ff0a"],type:"operator",role:"multiplication"},{set:["2d","af","2010","2011","2052","207b","208b","2212","2216","2238","2242","2296","229f","2796","29ff",["2a29","2a2c"],"2a3a","2a41","fe63","ff0d"],type:"operator",role:"subtraction"},{set:["2f","f7","2044","2215","2298","2797","27cc","29bc",["29f5","29f9"],"2a38"],type:"operator",role:"division"},{set:["ac","2200","2201","2203","2204","2206",["221a","221c"],"2310","ffe2"],type:"operator",role:"prefix operator"},{set:["2320","2321","23aa","23ae","23af","23b2","23b3","23b6","23b7"],type:"operator",role:"prefix operator"},{set:["1d7ca","1d7cb"],type:"operator",role:"prefix operator",font:nn.BOLD},{set:["3d","7e","207c","208c","221d","2237",["223a","223f"],"2243","2245","2248",["224a","224e"],["2251","225f"],"2261","2263","229c","22cd","22d5","29e4","29e6","2a66","2a67",["2a6a","2a6c"],["2a6c","2a78"],"fe66","ff1d"],type:"relation",role:"equality"},{set:["3c","3e","2241","2242","2244","2246","2247","2249","224f","2250","2260","2262",["2264","2281"],"22b0","22b1",["22d6","22e1"],["22e6","22e9"],["2976","2978"],"29c0","29c1","29e1","29e3","29e5",["2a79","2abc"],["2af7","2afa"],"fe64","fe65","ff1c","ff1e"],type:"relation",role:"inequality"},{set:[["2282","228b"],["228f","2292"],["22b2","22b8"],"22d0","22d1",["22e2","22e5"],["22ea","22ed"],"27c3","27c4",["27c7","27c9"],["27d5","27d7"],"27dc",["2979","297b"],"29df",["2abd","2ad8"]],type:"relation",role:"set"},{set:["2236",["27e0","27e5"],"292b","292c",["29b5","29bb"],"29be","29bf",["29c2","29d0"]],type:"relation",role:"unknown"},{set:["2205",["29b0","29b4"]],type:"identifier",role:"set empty"},{set:["1ab2","221e",["29dc","29de"]],type:"identifier",role:"infty"},{set:["22a2","22a3",["22a6","22af"],"27da","27db","27dd","27de","2ade",["2ae2","2ae6"],"2aec","2aed"],type:"relation",role:"logic"},{set:["22a4","22a5","22ba","27d8","27d9","27df","2adf","2ae0",["2ae7","2aeb"],"2af1"],type:"identifier",role:"logic"},{set:[["2190","21ff"],"2301","2324","238b","2794",["2798","27af"],["27b1","27be"],["27f0","27ff"],["2900","292a"],["292d","2975"],["297c","297f"],["2b00","2b11"],["2b30","2b4c"],["ffe9","ffec"]],type:"relation",role:"arrow"},{set:["2208","220a",["22f2","22f9"],"22ff","27d2","2ad9"],type:"operator",role:"element"},{set:["2209"],type:"operator",role:"nonelement"},{set:["220b","220d",["22fa","22fe"]],type:"operator",role:"reelement"},{set:["220c"],type:"operator",role:"renonelement"},{set:[["220f","2211"],["22c0","22c3"],["2a00","2a0b"],"2a3f","2afc","2aff"],type:"largeop",role:"sum"},{set:["2140"],type:"largeop",role:"sum",font:nn.DOUBLESTRUCK},{set:[["222b","2233"],["2a0c","2a17"],["2a17","2a1c"]],type:"largeop",role:"integral"},{set:[["2500","257F"]],type:"relation",role:"box"},{set:[["2580","259F"]],type:"identifier",role:"block"},{set:[["25A0","25FF"],["2B12","2B2F"],["2B50","2B59"]],type:"relation",role:"geometry"},{set:["220e","2300","2302","2311","29bd","29e0",["29e8","29f3"],"2a1e","2afe","ffed","ffee"],type:"operator",role:"geometry"},{set:[["221f","2222"],"22be","22bf",["2312","2314"],"237c","27c0",["299b","29af"]],type:"operator",role:"geometry"},{set:["24",["a2","a5"],"b5","2123",["2125","2127"],"212a","212b","fe69","ff04","ffe0","ffe1","ffe5","ffe6"],type:"identifier",role:"unknown"},{set:["a9","ae","210f","2114","2116","2117",["211e","2122"],"212e","2132",["2139","213b"],["2141","2144"],"214d","214e",["1f12a","1f12c"],"1f18a"],type:"identifier",role:"otherletter"},{set:["2224","2226","2239","2307","27b0","27bf","27c1","27c2","27ca","27cb","27cd","27d0","27d3","27d4","2981","2999","299a","29e7","29f4","2a20","2a21","2a64","2a65","2a68","2a69","2ae1",["2aee","2af0"],"2af2","2af3","2af5","2af6","2afb","2afd"],type:"operator",role:"unknown"},{set:["2605","2606","26aa","26ab",["2720","274d"]],type:"operator",role:"unknown"},{set:[["2145","2149"]],type:"identifier",role:"latinletter",font:nn.DOUBLESTRUCKITALIC,secondary:sn.ALLLETTERS},{set:[["213c","213f"]],type:"identifier",role:"greekletter",font:nn.DOUBLESTRUCK,secondary:sn.ALLLETTERS},{set:["3d0","3d7","3f6",["1d26","1d2a"],"1d5e","1d60",["1d66","1d6a"]],type:"identifier",role:"greekletter",font:nn.NORMAL,secondary:sn.ALLLETTERS},{set:[["2135","2138"]],type:"identifier",role:"otherletter",font:nn.NORMAL,secondary:sn.ALLLETTERS},{set:["131","237"],type:"identifier",role:"latinletter",font:nn.NORMAL},{set:["1d6a4","1d6a5"],type:"identifier",role:"latinletter",font:nn.ITALIC},{set:["2113","2118"],type:"identifier",role:"latinletter",font:nn.SCRIPT},{set:[["c0","d6"],["d8","f6"],["f8","1bf"],["1c4","2af"],["1d00","1d25"],["1d6b","1d9a"],["1e00","1ef9"],["363","36f"],["1dd3","1de6"],["1d62","1d65"],"1dca","2071","207f",["2090","209c"],"2c7c"],type:"identifier",role:"latinletter",font:nn.NORMAL},{set:[["00bc","00be"],["2150","215f"],"2189"],type:"number",role:"float"},{set:["23E8",["3248","324f"]],type:"number",role:"integer"},{set:[["214A","214C"],"2705","2713","2714","2717","2718"],type:"identifier",role:"unknown"},{set:["20","a0","ad",["2000","200f"],["2028","202f"],["205f","2060"],"206a","206b","206e","206f","feff",["fff9","fffb"]],type:"text",role:"space"},{set:["7c","a6","2223","23b8","23b9","23d0","2758",["fe31","fe34"],"ff5c","ffe4","ffe8"],type:"fence",role:"neutral"},{set:["2016","2225","2980","2af4"],type:"fence",role:"metric"}].forEach((t=>{var{set:e}=t,n=an(t,["set"]);return hn(function(t){let e=[];for(const n of t)Array.isArray(n)?e=e.concat(Je(n)):e.push(String.fromCodePoint(parseInt(n,16)));return e}(e),n)})),dn(cn.FencesVert,["23b4",["23dc","23e1"],["fe35","fe44"],"fe47"]),dn(cn.FencesHoriz,["28","2045",["2308","230f"],["231c","231f"],"2329","23b0",["2768","2775"],"27c5",["27e6","27ef"],["2983","2998"],["29d8","29db"],"29fc",["2e22","2e29"],["3008","3011"],["3014","301b"],"fd3e","fe17",["fe59","fe5e"],"ff08","ff5f","ff62"]),dn(cn.FencesHoriz,["5b","7b","ff3b","ff5b"],2),dn(cn.FencesHoriz,[["239b","23a6"]],3),dn(cn.FencesHoriz,[["23a7","23a9"]],4),hn([...cn.FencesHoriz.keys()],{type:"fence",role:"open"}),hn([...cn.FencesHoriz.values()],{type:"fence",role:"close"}),hn([...cn.FencesVert.keys()],{type:"fence",role:"top"}),hn([...cn.FencesVert.values()],{type:"fence",role:"bottom"}),function(){for(const[t,e]of Object.entries(nn)){const n=!!Ye[t]?nn.UNKNOWN:e===nn.FULLWIDTH?nn.NORMAL:e;pn(Xe.LATINCAP,"identifier","latinletter",e,n,[sn.ALLLETTERS]),pn(Xe.LATINSMALL,"identifier","latinletter",e,n,[sn.ALLLETTERS],{},{3:sn.D}),pn(Xe.GREEKCAP,"identifier","greekletter",e,n,[sn.ALLLETTERS]),pn(Xe.GREEKSMALL,"identifier","greekletter",e,n,[sn.ALLLETTERS],{0:{type:"operator",role:"prefix operator",font:n},26:{type:"operator",role:"prefix operator",font:n}}),pn(Xe.DIGIT,"number","integer",e,n)}}(),hn(["inf","lim","liminf","limsup","max","min","sup","injlim","projlim"],{type:"function",role:"limit function"}),hn(fn,{type:"function",role:"prefix function"}),hn(["mod","rem"],{type:"operator",role:"prefix function"});class mn{constructor(){this.rules=new Map}static parseUnicode(t){const e=parseInt(t,16);return String.fromCodePoint(e)}static testDynamicConstraints_(t,e){return E.getInstance().strict?e.cstr.equal(t):E.getInstance().comparator.match(e.cstr)}defineRulesFromMappings(t,e,n){for(const[r,s]of Object.entries(n))for(const[n,o]of Object.entries(s))this.defineRuleFromStrings(t,e,r,n,o)}getRules(t){let e=this.rules.get(t);return e||(e=[],this.rules.set(t,e)),e}defineRuleFromStrings(t,e,n,r,s){let o=this.getRules(t);const i=E.getInstance().parsers[n]||E.getInstance().defaultParser,c=E.getInstance().comparators[n],a=`${t}.${e}.${n}.${r}`,l=i.parse(a),u=c?c():E.getInstance().comparator,h=u.getReference();u.setReference(l);const d={cstr:l,action:s};o=o.filter((t=>!l.equal(t.cstr))),o.push(d),this.rules.set(t,o),u.setReference(h)}lookupRule(t,e){let n=this.getRules(e.getValue(r.LOCALE));return n=n.filter((function(t){return mn.testDynamicConstraints_(e,t)})),1===n.length?n[0]:n.length?n.sort(((t,e)=>E.getInstance().comparator.compare(t.cstr,e.cstr)))[0]:null}}let gn=c.DEFAULT_VALUES[r.LOCALE],Sn=c.DEFAULT_VALUES[r.MODALITY];function Nn(t){return!(!t.locale&&!t.modality)&&(gn=t.locale||gn,Sn=t.modality||Sn,!0)}let En={};function bn(t){En=t}const An=new Map,yn=new Map;function Tn(t,e){let n=An.get(e);return n||(n=new mn,n.base=yn.get(t),An.set(e,n),n)}function Cn(t){const e=yn.get(t.key);if(!e)return;const n=t.names;Object.assign(t,e),n&&e.names&&(t.names=t.names.concat(n))}function _n(t,e,n){Tn(t,e).defineRulesFromMappings(gn,Sn,n)}function In(t,e,n,r){Tn(n,n).defineRuleFromStrings(gn,Sn,t,e,r)}function On(t){if(!Nn(t))for(const[e,n]of Object.entries(t))In("default","default",e,n)}function Mn(t){for(let e,n=0;e=t.names[n];n++)_n(t.key,e,t.mappings)}function Rn(t){for(const e of Object.keys(En)){const n=Object.assign({},t);n.mappings={};const r=En[e];n.names=n.names.map((function(t){return e+t}));for(const e of Object.keys(t.mappings)){n.mappings[e]={};for(const s of Object.keys(t.mappings[e]))n.mappings[e][s]=ke[gn]().FUNCTIONS.si(r,t.mappings[e][s])}Mn(n)}}function xn(t,e){return e=e||{},t.length?(e[t[0]]=xn(t.slice(1),e[t[0]]),e):e}E.getInstance().evaluator=function(t,e){const n=function(t,e){const n=An.get(t);return n?n.lookupRule(null,e):null}(t,e);return n?n.action:null};class Ln{constructor(t,e){this.speech=t,this.attributes=e}static empty(){return new Ln("",{})}static stringEmpty(t){return new Ln(t,{})}static stringAttr(t,e){return new Ln(t,e)}static singleton(t,e={}){return[Ln.stringAttr(t,e)]}static node(t,e,n={}){const r=Ln.getAttributes(e);return Object.assign(r,n),new Ln(t,r)}static getAttributes(t){const e={};for(const n of Ln.attributeList)t.hasAttribute(n)&&(e[n]=t.getAttribute(n));return e}}Ln.attributeList=["id","extid"];class vn{static create(t,e={}){return t.text=nt.getInstance().apply(t.text,e),new vn(t)}constructor({context:t,text:e,userValue:n,annotation:r,attributes:s,personality:o,layout:i}){this.context=t||"",this.text=e||"",this.userValue=n||"",this.annotation=r||"",this.attributes=s||{},this.personality=o||{},this.layout=i||""}isEmpty(){return 0===this.context.length&&0===this.text.length&&0===this.userValue.length&&0===this.annotation.length}clone(){let t,e;if(this.personality){t={};for(const[e,n]of Object.entries(this.personality))t[e]=n}if(this.attributes){e={};for(const[t,n]of Object.entries(this.attributes))e[t]=n}return new vn({context:this.context,text:this.text,userValue:this.userValue,annotation:this.annotation,personality:t,attributes:e,layout:this.layout})}toString(){return'AuditoryDescription(context="'+this.context+'"  text="'+this.text+'"  userValue="'+this.userValue+'"  annotation="'+this.annotation+'")'}descriptionString(){return this.context&&this.text?this.context+" "+this.text:this.context||this.text}descriptionSpan(){return Ln.stringAttr(this.descriptionString(),this.attributes)}equals(t){return this.context===t.context&&this.text===t.text&&this.userValue===t.userValue&&this.annotation===t.annotation}}const Fn=new Map;function wn(t,e,n){const r={};if(e){const t=Fn.get(e)||{};Object.assign(r,t)}Fn.set(t,Object.assign(r,n))}function Dn(t,e){const n=t.length;let r=0,s=e;return e||(s=""),function(){return r<n&&(r+=1),s+" "+r}}function Pn(t,e){const n=parseFloat(e),r=isNaN(n)?e:n;return function(){return[vn.create({text:"",personality:{pause:r}})]}}function kn(t,e){let n;return n=t.length>0?O("../../content/*",t[0]):[],function(){const t=n.shift(),r=e?[vn.create({text:e},{translate:!0})]:[];if(!t)return r;const s=E.evaluateNode(t);return r.concat(s)}}class Un{constructor(t,e,n){this.domain=t,this.name=e,this.func=n,this.active=!1}annotate(t){t.childNodes.forEach(this.annotate.bind(this)),t.addAnnotation(this.domain,this.func(t))}}class Bn{constructor(t,e,n,r={}){this.domain=t,this.name=e,this.func=n,this.def=r,this.active=!1}visit(t,e){let n=this.func(t,e);t.addAnnotation(this.domain,n[0]);for(let e,r=0;e=t.childNodes[r];r++)n=this.visit(e,n[1]);return n}}const Gn=new Map,$n=new Map;function jn(t){const e=t.domain+":"+t.name;t instanceof Un?Gn.set(e,t):$n.set(e,t)}function Vn(t,e){const n=t+":"+e,r=Gn.get(n)||$n.get(n);r&&(r.active=!0)}function Hn(t,e){const n=e.split("-"),r=Dn(t,n[0]||""),s=n[1]||"",o=n[2]||"";let i=!0;return function(){const t=r();return i?(i=!1,o+t+s):t+s}}function Wn(t){return Kn(t)||function(t){return Yn(t)||"infixop"===t.type&&"implicit"===t.role&&(2===t.childNodes.length&&(Yn(t.childNodes[0])||Kn(t.childNodes[0]))&&Yn(t.childNodes[1])||3===t.childNodes.length&&Kn(t.childNodes[0])&&Yn(t.childNodes[1])&&Yn(t.childNodes[2]))}(t)||function(t){return"punctuated"===t.type&&"endpunct"===t.role&&2===t.childNodes.length&&"degree"===t.childNodes[1].role&&(Yn(t.childNodes[0])||Xn(t.childNodes[0])||"prefixop"===t.childNodes[0].type&&"negative"===t.childNodes[0].role&&(Yn(t.childNodes[0].childNodes[0])||Xn(t.childNodes[0].childNodes[0])))}(t)||function(t){return"prefixop"===t.type&&"negative"===t.role&&qn(t.childNodes[0])&&"prefixop"!==t.childNodes[0].type&&"appl"!==t.childNodes[0].type&&"punctuated"!==t.childNodes[0].type}(t)||function(t){return"appl"===t.type&&("prefix function"===t.childNodes[0].role||"simple function"===t.childNodes[0].role)&&(qn(t.childNodes[1])||"fenced"===t.childNodes[1].type&&qn(t.childNodes[1].childNodes[0]))}(t)}function qn(t){return t.hasAnnotation("clearspeak","simple")}function Yn(t){return"identifier"===t.type&&("latinletter"===t.role||"greekletter"===t.role||"otherletter"===t.role||"simple function"===t.role)}function Xn(t){return"number"===t.type&&("integer"===t.role||"float"===t.role)}function Kn(t){return Xn(t)||function(t){if(zn("Fraction_Over")||zn("Fraction_FracOver"))return!1;if("fraction"!==t.type||"vulgar"!==t.role)return!1;if(zn("Fraction_Ordinal"))return!0;const e=parseInt(t.childNodes[0].textContent,10),n=parseInt(t.childNodes[1].textContent,10);return e>0&&e<20&&n>0&&n<11}(t)}function zn(t){return E.getInstance().style===t}function Jn(t){if(function(t){if(!t.hasAttribute("annotation"))return!1;const e=t.getAttribute("annotation");return!!/clearspeak:simple$|clearspeak:simple;/.exec(e)}(t))return!0;if("subscript"!==t.tagName)return!1;const e=t.childNodes[0].childNodes,n=e[1];return"identifier"===e[0].tagName&&(Zn(n)||"infixop"===n.tagName&&n.hasAttribute("role")&&"implicit"===n.getAttribute("role")&&function(t){const e=O("children/*",t);return e.every((t=>Zn(t)||"identifier"===t.tagName))}(n))}function Zn(t){return"number"===t.tagName&&t.hasAttribute("role")&&"integer"===t.getAttribute("role")}function Qn(t){return O("matrix"===t.tagName?"children/row/children/cell/children/*":"children/line/children/*",t).every(Jn)?[t]:[]}function tr(t){return Y(t,20,11)?[t]:[]}function er(t){const e=parseInt(t.textContent,10);return[Ln.stringEmpty(isNaN(e)?t.textContent:e>10?K.NUMBERS.numericOrdinal(e):K.NUMBERS.wordOrdinal(e))]}jn(new Un("clearspeak","simple",(function(t){return Wn(t)?"simple":""}))),jn(new Un("clearspeak","unit",(function(t){return function(t){return"text"===t.type||"punctuated"===t.type&&"text"===t.role&&Xn(t.childNodes[0])&&function(t){for(let e=0;e<t.length-1;e++)if("text"!==t[e].type||""!==t[e].textContent)return!1;return"text"===t[t.length-1].type}(t.childNodes.slice(1))||"identifier"===t.type&&"unit"===t.role||"infixop"===t.type&&("implicit"===t.role||"unit"===t.role)}(t)?"unit":""})));let nr=null;function rr(t){let e=0;const n=t.textContent,r="open"===t.getAttribute("role")?0:1;let s=t.parentNode;for(;s;)"fenced"===s.tagName&&s.childNodes[0].childNodes[r].textContent===n&&e++,s=s.parentNode;return nr=e>1?K.NUMBERS.wordOrdinal(e):"",[Ln.stringEmpty(nr)]}function sr(t){const e=t.previousSibling;let n,r;return e?(n=e,r=t):(n=t,r=t.nextSibling),r&&function(t,e){const n=cn.Meaning.get(t);return"fence"===n.type&&("neutral"===n.role||"metric"===n.role?t===e:cn.FencesHoriz.get(t)===e||cn.FencesVert.get(t)===e)}(n.textContent,r.textContent)?[t]:[]}function or(t){const e=R(t.parentNode.childNodes),n=O("../../children/*",t),r=e.indexOf(t);return ar(n[r])||ar(n[r+1])?[t]:[]}function ir(t){const e=R(t.parentNode.childNodes),n=O("../../children/*",t),r=e.indexOf(t);return cr(n[r])&&n[r+1]&&(cr(n[r+1])||"root"===n[r+1].tagName||"sqrt"===n[r+1].tagName||"superscript"===n[r+1].tagName&&n[r+1].childNodes[0].childNodes[0]&&("number"===n[r+1].childNodes[0].childNodes[0].tagName||"identifier"===n[r+1].childNodes[0].childNodes[0].tagName)&&("2"===n[r+1].childNodes[0].childNodes[1].textContent||"3"===n[r+1].childNodes[0].childNodes[1].textContent))?[t]:[]}function cr(t){return!!t&&("number"===t.tagName||"identifier"===t.tagName||"function"===t.tagName||"appl"===t.tagName||"fraction"===t.tagName)}function ar(t){return t&&("fenced"===t.tagName||t.hasAttribute("role")&&"leftright"===t.getAttribute("role")||function(t){return!!t&&("matrix"===t.tagName||"vector"===t.tagName)}(t))}function lr(t){return[Ln.stringEmpty(K.NUMBERS.wordOrdinal(parseInt(t.textContent,10)))]}function ur(t,e){const n=[];for(;t.length||e.length;)t.length&&n.push(t.shift()),e.length&&n.push(e.shift());return n}function hr(t,e){return t?e?t.filter((t=>e.indexOf(t)<0)):t:[]}nt.getInstance().setCorrection("insertNesting",(function(t,e){if(!e||!t)return t;const n=t.match(/^(open|close) /);return n?n[0]+e+" "+t.substring(n[0].length):e+" "+t}));let dr=null;function fr(t){dr=t}const pr=new Map,mr={combine_juxtaposition:!0,convert_juxtaposition:!0,multioperator:!0},gr={};function Sr(t){const e=t.name;pr.set(e,t),mr[e]||(mr[e]=!1)}function Nr(t,e,n){const r=pr.get(t);return r&&!gr[t]&&(mr[t]||r.applicable(e))?r.apply(e):n?n(e):e}const Er=[];function br(t,e){for(let n,r=0;n=Er[r];r++){const r=n.compare(t,e);if(0!==r)return r}return 0}function Ar(t){if(t.length<=1)return t;const e=t.slice();!function(t){t.sort(br)}(e);const n=[];let r;do{r=e.pop(),n.push(r)}while(r&&e.length&&0===br(e[e.length-1],r));return n}function yr(t,e){return t.match(/^.+:.+$/)||!e?t:t+":"+e}new class{constructor(t,e=null){this.comparator=t,this.type=e,function(t){Er.push(t)}(this)}compare(t,e){return this.type&&this.type===t.type&&this.type===e.type?this.comparator(t,e):0}}((function(t,e){return"simple function"===t.role?1:"simple function"===e.role?-1:0}),"identifier");class Tr extends Map{set(t,e){return super.set(yr(t,e.font),e),this}setNode(t){this.set(t.textContent,t.meaning())}get(t,e=null){return super.get(yr(t,e))}getNode(t){return this.get(t.textContent,t.font)}}class Cr extends Map{add(t,e){const n=this.get(t);n?n.push(e):super.set(t,[e])}get(t,e=null){return super.get(yr(t,e))}getNode(t){return this.get(t.textContent,t.font)}minimize(){for(const[t,e]of this)1===e.length&&this.delete(t)}isMultiValued(){for(const t of this.values())if(t.length>1)return!0;return!1}}class _r extends Cr{add(t,e){super.add(yr(t,e.font),e)}addNode(t){this.add(t.textContent,t)}toString(){const t=[];for(const[e,n]of this){const r=Array(e.length+3).join(" "),s=n.map((t=>t.toString())).join("\n"+r);t.push(e+": "+s)}return t.join("\n")}collateMeaning(){const t=new Ir;for(const[e,n]of this)t.set(e,n.map((t=>t.meaning())));return t}}class Ir extends Cr{add(t,e){const n=this.get(t,e.font);n&&n.find((function(t){return r=e,(n=t).type===r.type&&n.role===r.role&&n.font===r.font;var n,r}))||super.add(yr(t,e.font),e)}addNode(t){this.add(t.textContent,t.meaning())}toString(){const t=[];for(const[e,n]of this){const r=Array(e.length+3).join(" "),s=n.map((t=>`{type: ${t.type}, role: ${t.role}, font: ${t.font}}`)).join("\n"+r);t.push(e+": "+s)}return t.join("\n")}reduce(){for(const[t,e]of this)1!==e.length&&this.set(t,Ar(e))}default(){const t=new Tr;for(const[e,n]of this)1===n.length&&t.set(e,n[0]);return t}newDefault(){const t=this.default();this.reduce();const e=this.default();return t.size!==e.size?e:null}}const Or=["MO","MI","MN","MTEXT","MS","MSPACE"],Mr=["MERROR","MPHANTOM","MALIGNGROUP","MALIGNMARK","MPRESCRIPTS","ANNOTATION","ANNOTATION-XML"],Rr=["MATH","MROW","MPADDED","MACTION","NONE","MSTYLE","SEMANTICS"],xr=["MROOT","MSQRT"],Lr=["aria-label","exact-speech","alt"];function vr(t){return!!t&&"MATH"===B(t)}function Fr(t){return!!t&&-1!==Mr.indexOf(B(t))}function wr(t){return!!t&&-1!==Rr.indexOf(B(t))}function Dr(t){return!!t&&"MGLYPH"===B(t)&&!function(t){return!!t&&-1!==Or.indexOf(B(t))}(t.parentNode)}function Pr(t){const e=[];for(let n,r=0;n=t[r];r++){if(n.nodeType!==L.ELEMENT_NODE)continue;const t=B(n);-1===Mr.indexOf(t)&&(-1!==Rr.indexOf(t)&&0===n.childNodes.length||e.push(n))}return e}function kr(t,e){if(e.hasAttributes()){const n=e.attributes;for(let e=n.length-1;e>=0;e--){const r=n[e].name;r.match(/^ext/)&&(t.attributes[r]=n[e].value,t.nobreaking=!0),-1!==Lr.indexOf(r)&&(t.attributes["ext-speech"]=n[e].value,t.nobreaking=!0),r.match(/texclass$/)&&(t.attributes.texclass=n[e].value),"latex"===r&&(t.attributes.latex=n[e].value),"href"===r&&(t.attributes.href=n[e].value,t.nobreaking=!0)}}}function Ur(t){return t&&t.embellished&&t.childNodes.length>0?Ur(t.childNodes[0]):t}function Br(t,e,n){n&&t.reverse();const r=[];for(let s,o=0;s=t[o];o++){if(e(s))return n?{head:t.slice(o+1).reverse(),div:s,tail:r.reverse()}:{head:r,div:s,tail:t.slice(o+1)};r.push(s)}return n?{head:[],div:null,tail:r.reverse()}:{head:r,div:null,tail:[]}}function Gr(t,e){let n=t;const r=[],s=[];let o=null;do{o=Br(n,e),s.push(o.head),r.push(o.div),n=o.tail}while(o.div);return r.pop(),{rel:r,comp:s}}class $r{static fromXml(t){const e=parseInt(t.getAttribute("id"),10),n=new $r(e);return n.type=t.tagName,$r.setAttribute(n,t,"role"),$r.setAttribute(n,t,"font"),$r.setAttribute(n,t,"embellished"),$r.setAttribute(n,t,"fencepointer","fencePointer"),t.getAttribute("annotation")&&n.parseAnnotation(t.getAttribute("annotation")),kr(n,t),$r.processChildren(n,t),n}static setAttribute(t,e,n,r){r=r||n;const s=e.getAttribute(n);s&&(t[r]=s)}static processChildren(t,e){for(const n of R(e.childNodes)){if(n.nodeType===L.TEXT_NODE){t.textContent=n.textContent;continue}const e=R(n.childNodes).map($r.fromXml);e.forEach((e=>e.parent=t)),"CONTENT"===B(n)?t.contentNodes=e:t.childNodes=e}}constructor(t){this.id=t,this.mathml=[],this.parent=null,this.type="unknown",this.role="unknown",this.font=nn.UNKNOWN,this.embellished=null,this.fencePointer="",this.childNodes=[],this.textContent="",this.mathmlTree=null,this.contentNodes=[],this.annotation={},this.attributes={},this.nobreaking=!1}querySelectorAll(t){let e=[];for(let n,r=0;n=this.childNodes[r];r++)e=e.concat(n.querySelectorAll(t));for(let n,r=0;n=this.contentNodes[r];r++)e=e.concat(n.querySelectorAll(t));return t(this)&&e.unshift(this),e}xml(t,e){const n=function(n,r){const s=r.map((function(n){return n.xml(t,e)})),o=t.createElementNS("",n);for(let t,e=0;t=s[e];e++)o.appendChild(t);return o},r=t.createElementNS("",this.type);return e||this.xmlAttributes(r),r.textContent=this.textContent,this.contentNodes.length>0&&r.appendChild(n("content",this.contentNodes)),this.childNodes.length>0&&r.appendChild(n("children",this.childNodes)),r}toString(t=!1){const e=x("<snode/>");return $(this.xml(e.ownerDocument,t))}allAttributes(){const t=[];return t.push(["role",this.role]),this.font!==nn.UNKNOWN&&t.push(["font",this.font]),Object.keys(this.annotation).length&&t.push(["annotation",this.annotationXml()]),this.embellished&&t.push(["embellished",this.embellished]),this.fencePointer&&t.push(["fencepointer",this.fencePointer]),t.push(["id",this.id.toString()]),t}annotationXml(){const t=[];for(const[e,n]of Object.entries(this.annotation))n.forEach((n=>t.push(e+":"+n)));return t.join(";")}attributesXml(){const t=[];for(const[e,n]of Object.entries(this.attributes))t.push(e+":"+n);return t.join(";")}toJson(){const t={};t.type=this.type;const e=this.allAttributes();for(let n,r=0;n=e[r];r++)t[n[0]]=n[1].toString();return this.textContent&&(t.$t=this.textContent),this.childNodes.length&&(t.children=this.childNodes.map((function(t){return t.toJson()}))),this.contentNodes.length&&(t.content=this.contentNodes.map((function(t){return t.toJson()}))),t}updateContent(t,e){const n=e?t.replace(/^[ \f\n\r\t\v\u200b]*/,"").replace(/[ \f\n\r\t\v\u200b]*$/,""):t.trim();if(t=t&&!n?t:n,this.textContent===t)return;const r=cn.Meaning.get(t);this.textContent=t,this.role=r.role,this.type=r.type,this.font=r.font}addMathmlNodes(t){for(let e,n=0;e=t[n];n++)-1===this.mathml.indexOf(e)&&this.mathml.push(e)}appendChild(t){this.childNodes.push(t),this.addMathmlNodes(t.mathml),t.parent=this}replaceChild(t,e){const n=this.childNodes.indexOf(t);if(-1===n)return;t.parent=null,e.parent=this,this.childNodes[n]=e;const r=t.mathml.filter((function(t){return-1===e.mathml.indexOf(t)})),s=e.mathml.filter((function(e){return-1===t.mathml.indexOf(e)}));this.removeMathmlNodes(r),this.addMathmlNodes(s)}appendContentNode(t){t&&(this.contentNodes.push(t),this.addMathmlNodes(t.mathml),t.parent=this)}removeContentNode(t){if(t){const e=this.contentNodes.indexOf(t);-1!==e&&this.contentNodes.slice(e,1)}}equals(t){if(!t)return!1;if(this.type!==t.type||this.role!==t.role||this.textContent!==t.textContent||this.childNodes.length!==t.childNodes.length||this.contentNodes.length!==t.contentNodes.length)return!1;for(let e,n,r=0;e=this.childNodes[r],n=t.childNodes[r];r++)if(!e.equals(n))return!1;for(let e,n,r=0;e=this.contentNodes[r],n=t.contentNodes[r];r++)if(!e.equals(n))return!1;return!0}displayTree(){console.info(this.displayTree_(0))}addAnnotation(t,e){e&&this.addAnnotation_(t,e)}getAnnotation(t){const e=this.annotation[t];return e||[]}hasAnnotation(t,e){const n=this.annotation[t];return!!n&&-1!==n.indexOf(e)}parseAnnotation(t){const e=t.split(";");for(let t=0,n=e.length;t<n;t++){const n=e[t].split(":");this.addAnnotation(n[0],n[1])}}meaning(){return{type:this.type,role:this.role,font:this.font}}xmlAttributes(t){const e=this.allAttributes();for(let n,r=0;n=e[r];r++)t.setAttribute(n[0],n[1]);this.addExternalAttributes(t)}addExternalAttributes(t){for(const[e,n]of Object.entries(this.attributes))t.setAttribute(e,n)}parseAttributes(t){if(!t)return;const e=t.split(";");for(let t=0,n=e.length;t<n;t++){const[n,r]=e[t].split(":");n&&(this.attributes[n]=r)}}removeMathmlNodes(t){const e=this.mathml;for(let n,r=0;n=t[r];r++){const t=e.indexOf(n);-1!==t&&e.splice(t,1)}this.mathml=e}displayTree_(t){t++;const e=Array(t).join("  ");let n="";n+="\n"+e+this.toString(),n+="\n"+e+"MathmlTree:",n+="\n"+e+this.mathmlTreeString(),n+="\n"+e+"MathML:";for(let t,r=0;t=this.mathml[r];r++)n+="\n"+e+t.toString();return n+="\n"+e+"Begin Content",this.contentNodes.forEach((function(e){n+=e.displayTree_(t)})),n+="\n"+e+"End Content",n+="\n"+e+"Begin Children",this.childNodes.forEach((function(e){n+=e.displayTree_(t)})),n+="\n"+e+"End Children",n}mathmlTreeString(){return this.mathmlTree?this.mathmlTree.toString():"EMPTY"}addAnnotation_(t,e){const n=this.annotation[t];n?n.push(e):this.annotation[t]=[e]}}class jr{constructor(){this.leafMap=new _r,this.defaultMap=new Tr,this.idCounter_=-1}makeNode(t){return this.createNode_(t)}makeUnprocessed(t){const e=this.createNode_();return e.mathml=[t],e.mathmlTree=t,e}makeEmptyNode(){const t=this.createNode_();return t.type="empty",t}makeContentNode(t){const e=this.createNode_();return e.updateContent(t),e}makeMultipleContentNodes(t,e){const n=[];for(let r=0;r<t;r++)n.push(this.makeContentNode(e));return n}makeLeafNode(t,e){if(!t)return this.makeEmptyNode();const n=this.makeContentNode(t);n.font=e||n.font;const r=this.defaultMap.getNode(n);return r&&(n.type=r.type,n.role=r.role,n.font=r.font),this.leafMap.addNode(n),n}makeBranchNode(t,e,n,r){const s=this.createNode_();return r&&s.updateContent(r),s.type=t,s.childNodes=e,s.contentNodes=n,e.concat(n).forEach((function(t){t.parent=s,s.addMathmlNodes(t.mathml)})),s}createNode_(t){return void 0!==t?this.idCounter_=Math.max(this.idCounter_,t):t=++this.idCounter_,new $r(t)}}function Vr(t,e){return t.type===e}function Hr(t,e){return t.embellished===e}function Wr(t,e){return t.role===e}function qr(t){return Vr(t,"fence")||Vr(t,"punctuation")||Vr(t,"operator")||Vr(t,"relation")}function Yr(t){return Qr(t)&&!Wr(t,"division")||Vr(t,"appl")||Jr(t)}function Xr(t){return Qr(t)||Jr(t)}function Kr(t,e){return!!e&&Vr(e,"identifier")&&cn.Secondary.has(t.textContent,sn.D)}function zr(t){if(Vr(t,"identifier")){const e=t.textContent[0];return e&&t.textContent[1]&&cn.Secondary.has(e,sn.D)}return!1}function Jr(t){return ts(t)||es(t)}function Zr(t){return t.embellished?t.embellished:"operator"===(e=t.type)||"relation"===e||"fence"===e||"punctuation"===e?t.type:null;var e}function Qr(t){return Vr(t,"operator")||Hr(t,"operator")}function ts(t){return Vr(t,"relation")||Hr(t,"relation")}function es(t){return Vr(t,"punctuation")||Hr(t,"punctuation")}function ns(t){return Vr(t,"fence")||Hr(t,"fence")}function rs(t){return!(!t||!ns(t))&&(!t.embellished||ss(t))}function ss(t){return!t.embellished||!function(t){return Vr(t,"tensor")&&(!Vr(t.childNodes[1],"empty")||!Vr(t.childNodes[2],"empty"))&&(!Vr(t.childNodes[3],"empty")||!Vr(t.childNodes[4],"empty"))}(t)&&((!Wr(t,"close")||!Vr(t,"tensor"))&&((!Wr(t,"open")||!Vr(t,"subscript")&&!Vr(t,"superscript"))&&ss(t.childNodes[0])))}function os(t){return!!t&&(Vr(t,"table")||Vr(t,"multiline"))}function is(t){return!!t&&cs(t)&&os(t.childNodes[0])}function cs(t){return!!t&&Vr(t,"fenced")&&(Wr(t,"leftright")||As(t))&&1===t.childNodes.length}function as(t,e){return e.length>0&&Wr(e[e.length-1],"openfence")}function ls(t){return t.childNodes.every((function(t){return t.childNodes.length<=1}))}function us(t){return Vr(t,"largeop")||Vr(t,"limboth")||Vr(t,"limlower")||Vr(t,"limupper")||Vr(t,"function")&&Wr(t,"limit function")||(Vr(t,"overscore")||Vr(t,"underscore"))&&us(t.childNodes[0])}function hs(t,e,n){return 1===e.length&&("punctuation"===t[n].type||"punctuation"===t[n].embellished)&&t[n]===e[0]}function ds(t){return Vr(t,"identifier")&&Wr(t,"simple function")}const fs=["punctuation","punctuated","relseq","multirel","table","multiline","cases","inference"],ps=["limupper","limlower","limboth","subscript","superscript","underscore","overscore","tensor"];function ms(t){const e=t.type;return-1===fs.indexOf(e)&&("infixop"!==e||"implicit"===t.role)&&("fenced"===e?"leftright"!==t.role||ms(t.childNodes[0]):-1===ps.indexOf(e)||ms(t.childNodes[0]))}function gs(t){return function(t){return"number"===t.type&&("integer"===t.role||"float"===t.role)}(t)||"vulgar"===t.role||"mixed"===t.role}function Ss(t){const e=t.childNodes;return"unit"===t.role&&(!e.length||"unit"===e[0].role)}function Ns(t){const e=t.childNodes;return"infixop"===t.type&&("multiplication"===t.role||"implicit"===t.role)&&e.length&&(Ss(e[0])||gs(e[0]))&&t.childNodes.slice(1).every(Ss)}function Es(t){return"infixop"===t.type&&("implicit"===t.role||"unit"===t.role&&!!t.contentNodes.length&&t.contentNodes[0].textContent===on.invisibleTimes)}function bs(t){return"infixop"===t.type&&"implicit"===t.role}function As(t){return"neutral"===t.role||"metric"===t.role}function ys(t,e){return As(t)&&As(e)&&Ur(t).textContent===Ur(e).textContent}function Ts(t){return!!As(t)&&(!t.embellished||"superscript"!==t.type&&"subscript"!==t.type&&("tensor"!==t.type||"empty"===t.childNodes[3].type&&"empty"===t.childNodes[4].type))}function Cs(t){return!!As(t)&&(!t.embellished||("tensor"!==t.type||"empty"===t.childNodes[1].type&&"empty"===t.childNodes[2].type))}class _s{static getInstance(){return _s.instance=_s.instance||new _s,_s.instance}static tableToMultiline(t){if(!ls(t))return Nr("rewrite_subcases",t,_s.classifyTable);t.type="multiline";for(let e,n=0;e=t.childNodes[n];n++)_s.rowToLine_(e,"multiline");var e;return 1!==t.childNodes.length||Vr(e=t.childNodes[0],"line")&&e.contentNodes.length&&Wr(e.contentNodes[0],"label")||!cs(t.childNodes[0].childNodes[0])||_s.tableToMatrixOrVector_(_s.rewriteFencedLine_(t)),_s.binomialForm_(t),_s.classifyMultiline(t),t}static number(t){"unknown"!==t.type&&"identifier"!==t.type||(t.type="number"),_s.meaningFromContent(t,_s.numberRole_),_s.exprFont_(t)}static classifyMultiline(t){let e=0;const n=t.childNodes.length;let r;for(;e<n&&(!(r=t.childNodes[e])||!r.childNodes.length);)e++;if(e>=n)return;const s=r.childNodes[0].role;"unknown"!==s&&t.childNodes.every((function(t){const e=t.childNodes[0];return!e||e.role===s&&(Vr(e,"relation")||Vr(e,"relseq"))}))&&(t.role=s)}static classifyTable(t){const e=_s.computeColumns_(t);return _s.classifyByColumns_(t,e,"equality")||_s.classifyByColumns_(t,e,"inequality",["equality"])||_s.classifyByColumns_(t,e,"arrow")||_s.detectCaleyTable(t),t}static detectCaleyTable(t){if(!t.mathmlTree)return!1;const e=t.mathmlTree,n=e.getAttribute("columnlines"),r=e.getAttribute("rowlines");return!(!n||!r)&&(!(!_s.cayleySpacing(n)||!_s.cayleySpacing(r))&&(t.role="cayley",!0))}static cayleySpacing(t){const e=t.split(" ");return("solid"===e[0]||"dashed"===e[0])&&e.slice(1).every((t=>"none"===t))}static proof(t,e,n){const r=_s.separateSemantics(e);return _s.getInstance().proof(t,r,n)}static findSemantics(t,e,n){const r=null==n?null:n,s=_s.getSemantics(t);return!!s&&(!!s[e]&&(null==r||s[e]===r))}static getSemantics(t){const e=t.getAttribute("semantics");return e?_s.separateSemantics(e):null}static removePrefix(t){const[,...e]=t.split("_");return e.join("_")}static separateSemantics(t){const e={};return t.split(";").forEach((function(t){const[n,r]=t.split(":");e[_s.removePrefix(n)]=r})),e}static matchSpaces_(t,e){for(let n,r=0;n=e[r];r++){const e=t[r].mathmlTree,s=t[r+1].mathmlTree;if(!e||!s)continue;const o=e.nextSibling;if(!o||o===s)continue;const i=_s.getSpacer_(o);i&&(n.mathml.push(i),n.mathmlTree=i,n.role="space")}}static getSpacer_(t){if("MSPACE"===B(t))return t;for(;wr(t)&&1===t.childNodes.length;)if("MSPACE"===B(t=t.childNodes[0]))return t;return null}static fenceToPunct_(t){const e=_s.FENCE_TO_PUNCT_[t.role];if(e){for(;t.embellished;)t.embellished="punctuation",Wr(t,"subsup")||Wr(t,"underover")||(t.role=e),t=t.childNodes[0];t.type="punctuation",t.role=e}}static classifyFunction_(t,e){if("appl"===t.type||"bigop"===t.type||"integral"===t.type)return"";if(e[0]&&e[0].textContent===on.functionApplication){_s.getInstance().funcAppls[t.id]=e.shift();let n="simple function";return Nr("simple2prefix",t),"prefix function"!==t.role&&"limit function"!==t.role||(n=t.role),_s.propagateFunctionRole_(t,n),"prefix"}const n=_s.CLASSIFY_FUNCTION_[t.role];return n||("identifier"===(r=t).type||"latinletter"===r.role||"greekletter"===r.role||"otherletter"===r.role?"simple":"");var r}static propagateFunctionRole_(t,e){if(t){if("infixop"===t.type)return;Wr(t,"subsup")||Wr(t,"underover")||(t.role=e),_s.propagateFunctionRole_(t.childNodes[0],e)}}static getFunctionOp_(t,e){if(e(t))return t;for(let n,r=0;n=t.childNodes[r];r++){const t=_s.getFunctionOp_(n,e);if(t)return t}return null}static tableToMatrixOrVector_(t){const e=t.childNodes[0];Vr(e,"multiline")?_s.tableToVector_(t):_s.tableToMatrix_(t),t.contentNodes.forEach(e.appendContentNode.bind(e));for(let t,n=0;t=e.childNodes[n];n++)_s.assignRoleToRow_(t,_s.getComponentRoles_(e));return e.parent=null,e}static tableToVector_(t){const e=t.childNodes[0];e.type="vector",1!==e.childNodes.length?_s.binomialForm_(e):_s.tableToSquare_(t)}static binomialForm_(t){2===t.childNodes.length&&(t.role="binomial",t.childNodes[0].role="binomial",t.childNodes[1].role="binomial")}static tableToMatrix_(t){const e=t.childNodes[0];e.type="matrix",e.childNodes&&e.childNodes.length>0&&e.childNodes[0].childNodes&&e.childNodes.length===e.childNodes[0].childNodes.length?_s.tableToSquare_(t):e.childNodes&&1===e.childNodes.length&&(e.role="rowvector")}static tableToSquare_(t){const e=t.childNodes[0];As(t)?e.role="determinant":e.role="squarematrix"}static getComponentRoles_(t){const e=t.role;return e&&"unknown"!==e?e:t.type.toLowerCase()||"unknown"}static tableToCases_(t,e){for(let e,n=0;e=t.childNodes[n];n++)_s.assignRoleToRow_(e,"cases");return t.type="cases",t.appendContentNode(e),ls(t)&&_s.binomialForm_(t),t}static rewriteFencedLine_(t){const e=t.childNodes[0],n=t.childNodes[0].childNodes[0],r=t.childNodes[0].childNodes[0].childNodes[0];return n.parent=t.parent,t.parent=n,r.parent=e,n.childNodes=[t],e.childNodes=[r],n}static rowToLine_(t,e){const n=e||"unknown";Vr(t,"row")&&(t.type="line",t.role=n,1===t.childNodes.length&&Vr(t.childNodes[0],"cell")&&(t.childNodes=t.childNodes[0].childNodes,t.childNodes.forEach((function(e){e.parent=t}))))}static assignRoleToRow_(t,e){Vr(t,"line")?t.role=e:Vr(t,"row")&&(t.role=e,t.childNodes.forEach((function(t){Vr(t,"cell")&&(t.role=e)})))}static nextSeparatorFunction_(t){let e;if(t){if(t.match(/^\s+$/))return null;e=t.replace(/\s/g,"").split("").filter((function(t){return t}))}else e=[","];return function(){return e.length>1?e.shift():e[0]}}static meaningFromContent(t,e){const n=[...t.textContent].filter((t=>t.match(/[^\s]/))),r=n.map((t=>cn.Meaning.get(t)));e(t,n,r)}static numberRole_(t,e,n){if("unknown"===t.role)return n.every((function(t){return"number"===t.type&&"integer"===t.role||"punctuation"===t.type&&"comma"===t.role}))?(t.role="integer",void("0"===e[0]&&t.addAnnotation("general","basenumber"))):void(n.every((function(t){return"number"===t.type&&"integer"===t.role||"punctuation"===t.type}))?t.role="float":t.role="othernumber")}static exprFont_(t){if(t.font!==nn.UNKNOWN)return;const e=[...t.textContent].map((t=>cn.Meaning.get(t))).reduce((function(t,e){return t&&e.font&&e.font!==nn.UNKNOWN&&e.font!==t?t===nn.UNKNOWN?e.font:null:t}),nn.UNKNOWN);e&&(t.font=e)}static purgeFences_(t){const e=t.rel,n=t.comp,r=[],s=[];for(;e.length>0;){const t=e.shift();let o=n.shift();rs(t)?(r.push(t),s.push(o)):(_s.fenceToPunct_(t),o.push(t),o=o.concat(n.shift()),n.unshift(o))}return s.push(n.shift()),{rel:r,comp:s}}static rewriteFencedNode_(t){const e=t.contentNodes[0],n=t.contentNodes[1];let r=_s.rewriteFence_(t,e);return t.contentNodes[0]=r.fence,r=_s.rewriteFence_(r.node,n),t.contentNodes[1]=r.fence,t.contentNodes[0].parent=t,t.contentNodes[1].parent=t,r.node.parent=null,r.node}static rewriteFence_(t,e){if(!e.embellished)return{node:t,fence:e};const n=e.childNodes[0],r=_s.rewriteFence_(t,n);return Vr(e,"superscript")||Vr(e,"subscript")||Vr(e,"tensor")?(Wr(e,"subsup")||(e.role=t.role),n!==r.node&&(e.replaceChild(n,r.node),n.parent=t),_s.propagateFencePointer_(e,n),{node:e,fence:r.fence}):(e.replaceChild(n,r.fence),e.mathmlTree&&-1===e.mathml.indexOf(e.mathmlTree)&&e.mathml.push(e.mathmlTree),{node:r.node,fence:e})}static propagateFencePointer_(t,e){t.fencePointer=e.fencePointer||e.id.toString(),t.embellished=null}static classifyByColumns_(t,e,n,r){return!!(3===e.length&&_s.testColumns_(e,1,(t=>_s.isPureRelation_(t,n)))||2===e.length&&(_s.testColumns_(e,1,(t=>_s.isEndRelation_(t,n)||_s.isPureRelation_(t,n)))||_s.testColumns_(e,0,(t=>_s.isEndRelation_(t,n,!0)||_s.isPureRelation_(t,n)))))&&(t.role=n,!0)}static isEndRelation_(t,e,n){const r=n?t.childNodes.length-1:0;return Vr(t,"relseq")&&Wr(t,e)&&Vr(t.childNodes[r],"empty")}static isPureRelation_(t,e){return Vr(t,"relation")&&Wr(t,e)}static computeColumns_(t){const e=[];for(let n,r=0;n=t.childNodes[r];r++)for(let t,r=0;t=n.childNodes[r];r++){e[r]?e[r].push(t):e[r]=[t]}return e}static testColumns_(t,e,n){const r=t[e];return!!r&&(r.some((function(t){return t.childNodes.length&&n(t.childNodes[0])}))&&r.every((function(t){return!t.childNodes.length||n(t.childNodes[0])})))}setNodeFactory(t){_s.getInstance().factory_=t,fr(_s.getInstance().factory_)}getNodeFactory(){return _s.getInstance().factory_}identifierNode(t,e,n){if("MathML-Unit"===n)t.type="identifier",t.role="unit";else if(!e&&1===t.textContent.length&&("integer"===t.role||"latinletter"===t.role||"greekletter"===t.role)&&t.font===nn.NORMAL)return t.font=nn.ITALIC,Nr("simpleNamedFunction",t);return"unknown"===t.type&&(t.type="identifier"),_s.exprFont_(t),Nr("simpleNamedFunction",t)}implicitNode(t){if(t=_s.getInstance().getMixedNumbers_(t),1===(t=_s.getInstance().combineUnits_(t)).length)return t[0];return Nr("combine_juxtaposition",_s.getInstance().implicitNode_(t))}text(t,e){return _s.exprFont_(t),t.type="text","ANNOTATION-XML"===e?(t.role="annotation",t):"MS"===e?(t.role="string",t):"MSPACE"===e||t.textContent.match(/^\s*$/)?(t.role="space",t):/\s/.exec(t.textContent)?(t.role="text",t):(t.role="unknown",t)}row(t){return 0===(t=t.filter((function(t){return!Vr(t,"empty")}))).length?_s.getInstance().factory_.makeEmptyNode():(t=_s.getInstance().getFencesInRow_(t),t=_s.getInstance().tablesInRow(t),t=_s.getInstance().getPunctuationInRow_(t),t=_s.getInstance().getTextInRow_(t),t=_s.getInstance().getFunctionsInRow_(t),_s.getInstance().relationsInRow_(t))}limitNode(t,e){if(!e.length)return _s.getInstance().factory_.makeEmptyNode();let n,r=e[0],s="unknown";if(!e[1])return r;if(us(r)){n=_s.MML_TO_LIMIT_[t];const o=n.length;if(s=n.type,e=e.slice(0,n.length+1),1===o&&qr(e[1])||2===o&&qr(e[1])&&qr(e[2]))return n=_s.MML_TO_BOUNDS_[t],_s.getInstance().accentNode_(r,e,n.type,n.length,n.accent);if(2===o){if(qr(e[1]))return r=_s.getInstance().accentNode_(r,[r,e[1]],{MSUBSUP:"subscript",MUNDEROVER:"underscore"}[t],1,!0),e[2]?_s.getInstance().makeLimitNode_(r,[r,e[2]],null,"limupper"):r;if(e[2]&&qr(e[2]))return r=_s.getInstance().accentNode_(r,[r,e[2]],{MSUBSUP:"superscript",MUNDEROVER:"overscore"}[t],1,!0),_s.getInstance().makeLimitNode_(r,[r,e[1]],null,"limlower");e[o]||(s="limlower")}return _s.getInstance().makeLimitNode_(r,e,null,s)}return n=_s.MML_TO_BOUNDS_[t],_s.getInstance().accentNode_(r,e,n.type,n.length,n.accent)}tablesInRow(t){let e=Gr(t,is),n=[];for(let t,r=0;t=e.rel[r];r++)n=n.concat(e.comp.shift()),n.push(_s.tableToMatrixOrVector_(t));n=n.concat(e.comp.shift()),e=Gr(n,os),n=[];for(let t,r=0;t=e.rel[r];r++){const r=e.comp.shift();as(0,r)&&_s.tableToCases_(t,r.pop()),n=n.concat(r),n.push(t)}return n.concat(e.comp.shift())}mfenced(t,e,n,r){if(n&&r.length>0){const t=_s.nextSeparatorFunction_(n),e=[r.shift()];r.forEach((n=>{e.push(_s.getInstance().factory_.makeContentNode(t())),e.push(n)})),r=e}return t&&e?_s.getInstance().horizontalFencedNode_(_s.getInstance().factory_.makeContentNode(t),_s.getInstance().factory_.makeContentNode(e),r):(t&&r.unshift(_s.getInstance().factory_.makeContentNode(t)),e&&r.push(_s.getInstance().factory_.makeContentNode(e)),_s.getInstance().row(r))}fractionLikeNode(t,e,n,r){let s;if(!r&&function(t){if(!t)return!1;if(-1!==["negativeveryverythinmathspace","negativeverythinmathspace","negativethinmathspace","negativemediummathspace","negativethickmathspace","negativeverythickmathspace","negativeveryverythickmathspace"].indexOf(t))return!0;const e=t.match(/[0-9.]+/);return!!e&&0===parseFloat(e[0])}(n)){const n=_s.getInstance().factory_.makeBranchNode("line",[t],[]),r=_s.getInstance().factory_.makeBranchNode("line",[e],[]);return s=_s.getInstance().factory_.makeBranchNode("multiline",[n,r],[]),_s.binomialForm_(s),_s.classifyMultiline(s),s}return s=_s.getInstance().fractionNode_(t,e),r&&s.addAnnotation("general","bevelled"),s}tensor(t,e,n,r,s){const o=_s.getInstance().factory_.makeBranchNode("tensor",[t,_s.getInstance().scriptNode_(e,"leftsub"),_s.getInstance().scriptNode_(n,"leftsuper"),_s.getInstance().scriptNode_(r,"rightsub"),_s.getInstance().scriptNode_(s,"rightsuper")],[]);return o.role=t.role,o.embellished=Zr(t),o}pseudoTensor(t,e,n){const r=t=>!Vr(t,"empty"),s=e.filter(r).length,o=n.filter(r).length;if(!s&&!o)return t;const i=s?o?"MSUBSUP":"MSUB":"MSUP",c=[t];return s&&c.push(_s.getInstance().scriptNode_(e,"rightsub",!0)),o&&c.push(_s.getInstance().scriptNode_(n,"rightsuper",!0)),_s.getInstance().limitNode(i,c)}font(t){const e=_s.MATHJAX_FONTS[t];return e||t}proof(t,e,n){if(e.inference||e.axiom||console.log("Noise"),e.axiom){const e=_s.getInstance().cleanInference(t.childNodes),r=e.length?_s.getInstance().factory_.makeBranchNode("inference",n(e),[]):_s.getInstance().factory_.makeEmptyNode();return r.role="axiom",r.mathmlTree=t,r}const r=_s.getInstance().inference(t,e,n);return e.proof&&(r.role="proof",r.childNodes[0].role="final"),r}inference(t,e,n){if(e.inferenceRule){const e=_s.getInstance().getFormulas(t,[],n);return _s.getInstance().factory_.makeBranchNode("inference",[e.conclusion,e.premises],[])}const r=e.labelledRule,s=R(t.childNodes),o=[];"left"!==r&&"both"!==r||o.push(_s.getInstance().getLabel(t,s,n,"left")),"right"!==r&&"both"!==r||o.push(_s.getInstance().getLabel(t,s,n,"right"));const i=_s.getInstance().getFormulas(t,s,n),c=_s.getInstance().factory_.makeBranchNode("inference",[i.conclusion,i.premises],o);return c.mathmlTree=t,c}getLabel(t,e,n,r){const s=_s.getInstance().findNestedRow(e,"prooflabel",r),o=_s.getInstance().factory_.makeBranchNode("rulelabel",n(R(s.childNodes)),[]);return o.role=r,o.mathmlTree=s,o}getFormulas(t,e,n){const r=e.length?_s.getInstance().findNestedRow(e,"inferenceRule"):t,s="up"===_s.getSemantics(r).inferenceRule,o=s?r.childNodes[1]:r.childNodes[0],i=s?r.childNodes[0]:r.childNodes[1],c=o.childNodes[0].childNodes[0],a=R(c.childNodes[0].childNodes),l=[];let u=1;for(const t of a)u%2&&l.push(t.childNodes[0]),u++;const h=n(l),d=n(R(i.childNodes[0].childNodes))[0],f=_s.getInstance().factory_.makeBranchNode("premises",h,[]);f.mathmlTree=c;const p=_s.getInstance().factory_.makeBranchNode("conclusion",[d],[]);return p.mathmlTree=i.childNodes[0].childNodes[0],{conclusion:p,premises:f}}findNestedRow(t,e,n){return _s.getInstance().findNestedRow_(t,e,0,n)}cleanInference(t){return R(t).filter((function(t){return"MSPACE"!==B(t)}))}operatorNode(t){return"unknown"===t.type&&(t.type="operator"),Nr("multioperator",t)}constructor(){this.funcAppls={},this.splitRoles=new Map([["subtraction","negative"],["addition","positive"]]),this.splitOps=["\u2212","-","\u2010","\u2011","+"],this.factory_=new jr,fr(this.factory_)}implicitNode_(t){const e=_s.getInstance().factory_.makeMultipleContentNodes(t.length-1,on.invisibleTimes);_s.matchSpaces_(t,e);const n=_s.getInstance().infixNode_(t,e[0]);return n.role="implicit",e.forEach((function(t){t.parent=n})),n.contentNodes=e,n}infixNode_(t,e){const n=_s.getInstance().factory_.makeBranchNode("infixop",t,[e],Ur(e).textContent);return n.role=e.role,Nr("propagateSimpleFunction",n)}explicitMixed_(t){const e=Gr(t,(function(t){return t.textContent===on.invisiblePlus}));if(!e.rel.length)return t;let n=[];for(let t,r=0;t=e.rel[r];r++){const s=e.comp[r],o=e.comp[r+1],i=s.length-1;if(s[i]&&o[0]&&Vr(s[i],"number")&&!Wr(s[i],"mixed")&&Vr(o[0],"fraction")){const t=_s.getInstance().factory_.makeBranchNode("number",[s[i],o[0]],[]);t.role="mixed",n=n.concat(s.slice(0,i)),n.push(t),o.shift()}else n=n.concat(s),n.push(t)}return n.concat(e.comp[e.comp.length-1])}concatNode_(t,e,n){if(0===e.length)return t;const r=e.map((function(t){return Ur(t).textContent})).join(" "),s=_s.getInstance().factory_.makeBranchNode(n,[t],e,r);return e.length>1&&(s.role="multiop"),s}prefixNode_(t,e){const n=this.splitSingles(e);let r=t;for(;n.length>0;){const t=n.pop();r=_s.getInstance().concatNode_(r,t,"prefixop"),1===t.length&&-1!==this.splitOps.indexOf(t[0].textContent)&&(r.role=this.splitRoles.get(t[0].role))}return r}splitSingles(t){let e=0;const n=[];let r=0;for(;r<t.length;){const s=t[r];!this.splitRoles.has(s.role)||t[r-1]&&t[r-1].role===s.role||t[r+1]&&t[r+1].role===s.role||-1===this.splitOps.indexOf(s.textContent)||(n.push(t.slice(e,r)),n.push(t.slice(r,r+1)),e=r+1),r++}return e<r&&n.push(t.slice(e,r)),n}postfixNode_(t,e){return e.length?_s.getInstance().concatNode_(t,e,"postfixop"):t}combineUnits_(t){const e=Gr(t,(function(t){return!Wr(t,"unit")}));if(t.length===e.rel.length)return e.rel;const n=[];let r,s;do{const t=e.comp.shift();r=e.rel.shift();let o=null;s=n.pop(),s&&(t.length&&gs(s)?t.unshift(s):n.push(s)),1===t.length&&(o=t.pop()),t.length>1&&(o=_s.getInstance().implicitNode_(t),o.role="unit"),o&&n.push(o),r&&n.push(r)}while(r);return n}getMixedNumbers_(t){const e=Gr(t,(function(t){return Vr(t,"fraction")&&Wr(t,"vulgar")}));if(!e.rel.length)return t;let n=[];for(let t,r=0;t=e.rel[r];r++){const s=e.comp[r],o=s.length-1;if(s[o]&&Vr(s[o],"number")&&(Wr(s[o],"integer")||Wr(s[o],"float"))){const e=_s.getInstance().factory_.makeBranchNode("number",[s[o],t],[]);e.role="mixed",n=n.concat(s.slice(0,o)),n.push(e)}else n=n.concat(s),n.push(t)}return n.concat(e.comp[e.comp.length-1])}getTextInRow_(t){if(0===t.length)return t;if(1===t.length)return"text"===t[0].type&&"unknown"===t[0].role&&(t[0].role="annotation"),t;const{rel:e,comp:n}=Gr(t,(t=>Vr(t,"text")));if(0===e.length)return t;const r=[];let s=n.shift();for(;e.length>0;){let t=e.shift(),o=n.shift();const i=[];for(;!o.length&&e.length&&"space"!==t.role&&"space"!==e[0].role;)i.push(t),t=e.shift(),o=n.shift();if(i.length){s.length&&r.push(_s.getInstance().row(s)),i.push(t);let e=_s.getInstance().dummyNode_(i);r.push(e),s=o;continue}if("unknown"!==t.role){s.length&&r.push(_s.getInstance().row(s)),r.push(t),s=o;continue}const c=cn.Meaning.get(t.textContent);"punctuation"!==c.type?"unknown"===c.type?(_s.meaningFromContent(t,((t,e,n)=>{if("unknown"===t.role){if(_s.numberRole_(t,e,n),"othernumber"===t.role)return n.some((t=>"number"!==t.type&&"identifier"!==t.type))?(t.type="text",void(t.role="annotation")):void(t.role="unknown");t.type="number"}})),"text"!==t.type||"unknown"===t.role?("unknown"===t.role&&(e.length||o.length?o.length&&"fenced"===o[0].type?(t.type="function",t.role="prefix function"):t.role="text":(t.type="identifier",t.role="unit")),s.push(t),s=s.concat(o)):(s.length&&r.push(_s.getInstance().row(s)),r.push(t),s=o)):(t.type=c.type,t.role=c.role,t.font=c.font,t.addAnnotation("general","text"),s.push(t),s=s.concat(o)):(t.role=c.role,t.font=c.font,s.length&&r.push(_s.getInstance().row(s)),r.push(t),s=o)}return s.length>0&&r.push(_s.getInstance().row(s)),r.length>1?[_s.getInstance().dummyNode_(r)]:r}relationsInRow_(t){const e=Gr(t,ts),n=e.rel[0];if(!n)return _s.getInstance().operationsInRow_(t);if(1===t.length)return t[0];const r=e.comp.map(_s.getInstance().operationsInRow_);let s;return e.rel.some((function(t){return!t.equals(n)}))?(s=_s.getInstance().factory_.makeBranchNode("multirel",r,e.rel),e.rel.every((function(t){return t.role===n.role}))&&(s.role=n.role),s):(s=_s.getInstance().factory_.makeBranchNode("relseq",r,e.rel,Ur(n).textContent),s.role=n.role,s)}operationsInRow_(t){if(0===t.length)return _s.getInstance().factory_.makeEmptyNode();if(1===(t=_s.getInstance().explicitMixed_(t)).length)return t[0];const e=[];for(;t.length>0&&Qr(t[0]);)e.push(t.shift());if(0===t.length)return _s.getInstance().prefixNode_(e.pop(),e);if(1===t.length)return _s.getInstance().prefixNode_(t[0],e);const n=Br(t=Nr("convert_juxtaposition",t),Qr),r=_s.getInstance().prefixNode_(_s.getInstance().implicitNode(n.head),e);return n.div?_s.getInstance().operationsTree_(n.tail,r,n.div):(Ns(r)&&(r.role="unit"),r)}operationsTree_(t,e,n,r){const s=r||[];if(0===t.length){if(s.unshift(n),"infixop"===e.type){const t=_s.getInstance().postfixNode_(e.childNodes.pop(),s);return e.appendChild(t),e}return _s.getInstance().postfixNode_(e,s)}const o=Br(t,Qr);if(0===o.head.length)return s.push(o.div),_s.getInstance().operationsTree_(o.tail,e,n,s);const i=_s.getInstance().prefixNode_(_s.getInstance().implicitNode(o.head),s),c=_s.getInstance().appendOperand_(e,n,i);return o.div?_s.getInstance().operationsTree_(o.tail,c,o.div,[]):c}appendOperand_(t,e,n){if("infixop"!==t.type)return _s.getInstance().infixNode_([t,n],e);const r=_s.getInstance().appendDivisionOp_(t,e,n);return r||(_s.getInstance().appendExistingOperator_(t,e,n)?t:"multiplication"===e.role?_s.getInstance().appendMultiplicativeOp_(t,e,n):_s.getInstance().appendAdditiveOp_(t,e,n))}appendDivisionOp_(t,e,n){return"division"===e.role?Es(t)?_s.getInstance().infixNode_([t,n],e):_s.getInstance().appendLastOperand_(t,e,n):"division"===t.role?_s.getInstance().infixNode_([t,n],e):null}appendLastOperand_(t,e,n){let r=t,s=t.childNodes[t.childNodes.length-1];for(;s&&"infixop"===s.type&&!Es(s);)r=s,s=r.childNodes[t.childNodes.length-1];const o=_s.getInstance().infixNode_([r.childNodes.pop(),n],e);return r.appendChild(o),t}appendMultiplicativeOp_(t,e,n){if(Es(t))return _s.getInstance().infixNode_([t,n],e);let r=t,s=t.childNodes[t.childNodes.length-1];for(;s&&"infixop"===s.type&&!Es(s);)r=s,s=r.childNodes[t.childNodes.length-1];const o=_s.getInstance().infixNode_([r.childNodes.pop(),n],e);return r.appendChild(o),t}appendAdditiveOp_(t,e,n){return _s.getInstance().infixNode_([t,n],e)}appendExistingOperator_(t,e,n){return!(!t||"infixop"!==t.type||Es(t))&&(t.contentNodes[0].equals(e)?(t.appendContentNode(e),t.appendChild(n),!0):_s.getInstance().appendExistingOperator_(t.childNodes[t.childNodes.length-1],e,n))}getFencesInRow_(t){let e=Gr(t,ns);e=_s.purgeFences_(e);const n=e.comp.shift();return _s.getInstance().fences_(e.rel,e.comp,[],[n])}fences_(t,e,n,r){if(0===t.length&&0===n.length)return r[0];const s=t=>Wr(t,"open");if(0===t.length){const t=r.shift();for(;n.length>0;){if(s(n[0])){const e=n.shift();_s.fenceToPunct_(e),t.push(e)}else{const e=Br(n,s),o=e.head.length-1,i=_s.getInstance().neutralFences_(e.head,r.slice(0,o));r=r.slice(o),t.push(...i),e.div&&e.tail.unshift(e.div),n=e.tail}t.push(...r.shift())}return t}const o=n[n.length-1],i=t[0].role;if("open"===i||As(t[0])&&(!o||!ys(t[0],o))){n.push(t.shift());const s=e.shift();return s&&r.push(s),_s.getInstance().fences_(t,e,n,r)}if(o&&"close"===i&&"open"===o.role){const s=_s.getInstance().horizontalFencedNode_(n.pop(),t.shift(),r.pop());return r.push(r.pop().concat([s],e.shift())),_s.getInstance().fences_(t,e,n,r)}if(o&&ys(t[0],o)){if(!Ts(o)||!Cs(t[0])){n.push(t.shift());const s=e.shift();return s&&r.push(s),_s.getInstance().fences_(t,e,n,r)}const s=_s.getInstance().horizontalFencedNode_(n.pop(),t.shift(),r.pop());return r.push(r.pop().concat([s],e.shift())),_s.getInstance().fences_(t,e,n,r)}if(o&&"close"===i&&As(o)&&n.some(s)){const o=Br(n,s,!0),i=r.pop(),c=r.length-o.tail.length+1,a=_s.getInstance().neutralFences_(o.tail,r.slice(c));r=r.slice(0,c);const l=_s.getInstance().horizontalFencedNode_(o.div,t.shift(),r.pop().concat(a,i));return r.push(r.pop().concat([l],e.shift())),_s.getInstance().fences_(t,e,o.head,r)}const c=t.shift();return _s.fenceToPunct_(c),r.push(r.pop().concat([c],e.shift())),_s.getInstance().fences_(t,e,n,r)}neutralFences_(t,e){if(0===t.length)return t;if(1===t.length)return _s.fenceToPunct_(t[0]),t;const n=t.shift();if(!Ts(n)){_s.fenceToPunct_(n);const r=e.shift();return r.unshift(n),r.concat(_s.getInstance().neutralFences_(t,e))}const r=Br(t,(function(t){return ys(t,n)}));if(!r.div){_s.fenceToPunct_(n);const r=e.shift();return r.unshift(n),r.concat(_s.getInstance().neutralFences_(t,e))}if(!Cs(r.div))return _s.fenceToPunct_(r.div),t.unshift(n),_s.getInstance().neutralFences_(t,e);const s=_s.getInstance().combineFencedContent_(n,r.div,r.head,e);if(r.tail.length>0){const t=s.shift(),e=_s.getInstance().neutralFences_(r.tail,s);return t.concat(e)}return s[0]}combineFencedContent_(t,e,n,r){if(0===n.length){const n=_s.getInstance().horizontalFencedNode_(t,e,r.shift());return r.length>0?r[0].unshift(n):r=[[n]],r}const s=r.shift(),o=n.length-1,i=r.slice(0,o),c=(r=r.slice(o)).shift(),a=_s.getInstance().neutralFences_(n,i);s.push(...a),s.push(...c);const l=_s.getInstance().horizontalFencedNode_(t,e,s);return r.length>0?r[0].unshift(l):r=[[l]],r}horizontalFencedNode_(t,e,n){const r=_s.getInstance().row(n);let s=_s.getInstance().factory_.makeBranchNode("fenced",[r],[t,e]);return"open"===t.role?(_s.getInstance().classifyHorizontalFence_(s),s=Nr("propagateComposedFunction",s)):s.role=t.role,s=Nr("detect_cycle",s),_s.rewriteFencedNode_(s)}classifyHorizontalFence_(t){t.role="leftright";const e=t.childNodes;if(!function(t){return function(t){return!!t&&-1!==["{","\ufe5b","\uff5b"].indexOf(t.textContent)}(t.contentNodes[0])&&function(t){return!!t&&-1!==["}","\ufe5c","\uff5d"].indexOf(t.textContent)}(t.contentNodes[1])}(t)||e.length>1)return;if(0===e.length||"empty"===e[0].type)return void(t.role="set empty");const n=e[0].type;if(1===e.length&&ms(e[0]))return void(t.role="set singleton");const r=e[0].role;if("punctuated"===n&&"sequence"===r){if("comma"!==e[0].contentNodes[0].role)return 1!==e[0].contentNodes.length||"vbar"!==e[0].contentNodes[0].role&&"colon"!==e[0].contentNodes[0].role?void 0:(t.role="set extended",void _s.getInstance().setExtension_(t));t.role="set collection"}}setExtension_(t){const e=t.childNodes[0].childNodes[0];var n;e&&"infixop"===e.type&&1===e.contentNodes.length&&(n=e.contentNodes[0],["element","nonelement","reelement","renonelement"].includes(n.role))&&(e.addAnnotation("set","intensional"),e.contentNodes[0].addAnnotation("set","intensional"))}getPunctuationInRow_(t){if(t.length<=1)return t;const e=t=>{const e=t.type;return"punctuation"===e||"text"===e||"operator"===e||"relation"===e},n=Gr(t,(function(n){if(!es(n))return!1;if(es(n)&&!Wr(n,"ellipsis"))return!0;const r=t.indexOf(n);if(0===r)return!t[1]||!e(t[1]);const s=t[r-1];if(r===t.length-1)return!e(s);const o=t[r+1];return!e(s)||!e(o)}));if(0===n.rel.length)return t;const r=[];let s=n.comp.shift();s.length>0&&r.push(_s.getInstance().row(s));let o=0;for(;n.comp.length>0;)r.push(n.rel[o++]),s=n.comp.shift(),s.length>0&&r.push(_s.getInstance().row(s));return[_s.getInstance().punctuatedNode_(r,n.rel)]}punctuatedNode_(t,e){const n=_s.getInstance().factory_.makeBranchNode("punctuated",t,e);if(e.length===t.length){const t=e[0].role;if("unknown"!==t&&e.every((function(e){return e.role===t})))return n.role=t,n}return hs(t,e,0)?n.role="startpunct":hs(t,e,t.length-1)?n.role="endpunct":e.every((t=>Wr(t,"dummy")))?n.role="text":e.every((t=>Wr(t,"space")))?n.role="space":n.role="sequence",n}dummyNode_(t){const e=_s.getInstance().factory_.makeMultipleContentNodes(t.length-1,on.invisibleComma);return e.forEach((function(t){t.role="dummy"})),_s.getInstance().punctuatedNode_(t,e)}accentRole_(t,e){if(!qr(t))return!1;const n=t.textContent,r=cn.Secondary.get(n,sn.BAR)||cn.Secondary.get(n,sn.TILDE)||t.role;return t.role="underscore"===e?"underaccent":"overaccent",t.addAnnotation("accent",r),!0}accentNode_(t,e,n,r,s){const o=(e=e.slice(0,r+1))[1],i=e[2];let c;if(!s&&i&&(c=_s.getInstance().factory_.makeBranchNode("subscript",[t,o],[]),c.role="subsup",e=[c,i],n="superscript"),s){const r=_s.getInstance().accentRole_(o,n);if(i){_s.getInstance().accentRole_(i,"overscore")&&!r?(c=_s.getInstance().factory_.makeBranchNode("overscore",[t,i],[]),e=[c,o],n="underscore"):(c=_s.getInstance().factory_.makeBranchNode("underscore",[t,o],[]),e=[c,i],n="overscore"),c.role="underover"}}return _s.getInstance().makeLimitNode_(t,e,c,n)}makeLimitNode_(t,e,n,r){if("limupper"===r&&"limlower"===t.type)return t.childNodes.push(e[1]),e[1].parent=t,t.type="limboth",t;if("limlower"===r&&"limupper"===t.type)return t.childNodes.splice(1,-1,e[1]),e[1].parent=t,t.type="limboth",t;const s=_s.getInstance().factory_.makeBranchNode(r,e,[]),o=Zr(t);return n&&(n.embellished=o),s.embellished=o,s.role=t.role,s}getFunctionsInRow_(t,e){const n=e||[];if(0===t.length)return n;const r=t.shift(),s=_s.classifyFunction_(r,t);if(!s)return n.push(r),_s.getInstance().getFunctionsInRow_(t,n);const o=_s.getInstance().getFunctionsInRow_(t,[]),i=_s.getInstance().getFunctionArgs_(r,o,s);return n.concat(i)}getFunctionArgs_(t,e,n){let r,s,o;switch(n){case"integral":{const n=_s.getInstance().getIntegralArgs_(e);if(!n.intvar&&!n.integrand.length)return n.rest.unshift(t),n.rest;const r=_s.getInstance().row(n.integrand);return o=_s.getInstance().integralNode_(t,r,n.intvar),Nr("intvar_from_fraction",o),n.rest.unshift(o),n.rest}case"prefix":if(e[0]&&"fenced"===e[0].type){const n=e.shift();return As(n)||(n.role="leftright"),o=_s.getInstance().functionNode_(t,n),e.unshift(o),e}if(r=Br(e,Yr),r.head.length)s=_s.getInstance().row(r.head),r.div&&r.tail.unshift(r.div);else{if(!r.div||!Vr(r.div,"appl"))return e.unshift(t),e;s=r.div}return o=_s.getInstance().functionNode_(t,s),r.tail.unshift(o),r.tail;case"bigop":return r=Br(e,Xr),r.head.length?(s=_s.getInstance().row(r.head),o=_s.getInstance().bigOpNode_(t,s),r.div&&r.tail.unshift(r.div),r.tail.unshift(o),r.tail):(e.unshift(t),e);default:{if(0===e.length)return[t];const n=e[0];return"fenced"===n.type&&!As(n)&&function(t){const e=t.childNodes;if(0===e.length)return!0;if(e.length>1)return!1;const n=e[0];if("infixop"===n.type){if("implicit"!==n.role)return!1;if(n.childNodes.some((t=>Vr(t,"infixop"))))return!1}return!0}(n)?(n.role="leftright",_s.propagateFunctionRole_(t,"simple function"),o=_s.getInstance().functionNode_(t,e.shift()),e.unshift(o),e):(e.unshift(t),e)}}}getIntegralArgs_(t,e=[]){if(0===t.length){const t=Br(e,Xr);return t.div&&t.tail.unshift(t.div),{integrand:t.head,intvar:null,rest:t.tail}}Nr("intvar_from_implicit",t);const n=t[0];if(Jr(n))return{integrand:e,intvar:null,rest:t};if(zr(n))return n.role="integral",{integrand:e,intvar:n,rest:t.slice(1)};if(t[1]&&Kr(n,t[1])){const r=_s.getInstance().prefixNode_(t[1],[n]);return r.role="integral",{integrand:e,intvar:r,rest:t.slice(2)}}return e.push(t.shift()),_s.getInstance().getIntegralArgs_(t,e)}functionNode_(t,e){const n=_s.getInstance().factory_.makeContentNode(on.functionApplication),r=_s.getInstance().funcAppls[t.id];r&&(n.mathmlTree=r.mathmlTree,n.mathml=r.mathml,n.annotation=r.annotation,n.attributes=r.attributes,delete _s.getInstance().funcAppls[t.id]),n.type="punctuation",n.role="application";const s=_s.getFunctionOp_(t,(function(t){return Vr(t,"function")||Vr(t,"identifier")&&Wr(t,"simple function")}));return _s.getInstance().functionalNode_("appl",[t,e],s,[n])}bigOpNode_(t,e){const n=_s.getFunctionOp_(t,(t=>Vr(t,"largeop")));return _s.getInstance().functionalNode_("bigop",[t,e],n,[])}integralNode_(t,e,n){e=e||_s.getInstance().factory_.makeEmptyNode(),n=n||_s.getInstance().factory_.makeEmptyNode();const r=_s.getFunctionOp_(t,(t=>Vr(t,"largeop")));return _s.getInstance().functionalNode_("integral",[t,e,n],r,[])}functionalNode_(t,e,n,r){const s=e[0];let o;n&&(o=n.parent,r.push(n));const i=_s.getInstance().factory_.makeBranchNode(t,e,r);return i.role=s.role,o&&(n.parent=o),i}fractionNode_(t,e){const n=_s.getInstance().factory_.makeBranchNode("fraction",[t,e],[]);return n.role=n.childNodes.every((function(t){return Vr(t,"number")&&Wr(t,"integer")}))?"vulgar":n.childNodes.every(Ss)?"unit":"division",Nr("propagateSimpleFunction",n)}scriptNode_(t,e,n){let r;switch(t.length){case 0:r=_s.getInstance().factory_.makeEmptyNode();break;case 1:if(r=t[0],n)return r;break;default:r=_s.getInstance().dummyNode_(t)}return r.role=e,r}findNestedRow_(t,e,n,r){if(n>3)return null;for(let s,o=0;s=t[o];o++){const t=B(s);if("MSPACE"!==t){if("MROW"===t)return _s.getInstance().findNestedRow_(R(s.childNodes),e,n+1,r);if(_s.findSemantics(s,e,r))return s}}return null}}_s.FENCE_TO_PUNCT_={metric:"metric",neutral:"vbar",open:"openfence",close:"closefence"},_s.MML_TO_LIMIT_={MSUB:{type:"limlower",length:1},MUNDER:{type:"limlower",length:1},MSUP:{type:"limupper",length:1},MOVER:{type:"limupper",length:1},MSUBSUP:{type:"limboth",length:2},MUNDEROVER:{type:"limboth",length:2}},_s.MML_TO_BOUNDS_={MSUB:{type:"subscript",length:1,accent:!1},MSUP:{type:"superscript",length:1,accent:!1},MSUBSUP:{type:"subscript",length:2,accent:!1},MUNDER:{type:"underscore",length:1,accent:!0},MOVER:{type:"overscore",length:1,accent:!0},MUNDEROVER:{type:"underscore",length:2,accent:!0}},_s.CLASSIFY_FUNCTION_={integral:"integral",sum:"bigop","prefix function":"prefix","limit function":"prefix","simple function":"prefix","composed function":"prefix"},_s.MATHJAX_FONTS={"-tex-caligraphic":nn.CALIGRAPHIC,"-tex-caligraphic-bold":nn.CALIGRAPHICBOLD,"-tex-calligraphic":nn.CALIGRAPHIC,"-tex-calligraphic-bold":nn.CALIGRAPHICBOLD,"-tex-oldstyle":nn.OLDSTYLE,"-tex-oldstyle-bold":nn.OLDSTYLEBOLD,"-tex-mathit":nn.ITALIC};const Is=_s;let Os={};function Ms(t){return Array.from(t.textContent).map(Ln.stringEmpty)}function Rs(t,e){const n=Array.from(t.textContent),r=[],s=Is.getInstance(),o=t.ownerDocument;for(let t,i=0;t=n[i];i++){const n=s.getNodeFactory().makeLeafNode(t,nn.UNKNOWN),i=s.identifierNode(n,nn.UNKNOWN,"");e(i),r.push(i.xml(o))}return r}function xs(t){return Rs(t,(function(t){t.textContent.match(/\W/)||(t.type="number")}))}function Ls(t){return Rs(t,(function(t){t.font=nn.UNKNOWN,t.type="identifier"}))}const vs=["cases","cell","integral","line","matrix","multiline","overscore","root","row","sqrt","subscript","superscript","table","underscore","vector"];function Fs(t){return Os={},[t]}function ws(t,e,n,r,s,o){r=r||vs,s=s||{},o=o||function(t){return!1};const i=$(e);if(Os[t]||(Os[t]={}),Os[t][i])return Os[t][i];if(o(e)||n.indexOf(e.tagName)<0)return 0;const c=Ds(e,n,hr(r,n),s,o,0);return Os[t][i]=c,c}function Ds(t,e,n,r,s,o){if(s(t)||n.indexOf(t.tagName)>-1||function(t,e){if(!t.attributes)return!1;const n=R(t.attributes);for(let t,r=0;t=n[r];r++)if(e[t.nodeName]===t.nodeValue)return!0;return!1}(t,r))return o;if(e.indexOf(t.tagName)>-1&&o++,!t.childNodes||0===t.childNodes.length)return o;const i=R(t.childNodes);return Math.max.apply(null,i.map((function(t){return Ds(t,e,n,r,s,o)})))}function Ps(t){return ws("fraction",t,["fraction"],vs,{},K.FUNCTIONS.fracNestDepth)}function ks(t,e,n){const r=Ps(t),s=Array(r).fill(e);return n&&s.push(n),s.join(K.MESSAGES.regexp.JOINER_FRAC)}function Us(t){return Ln.singleton(ks(t,K.MESSAGES.MS.START,K.MESSAGES.MS.FRAC_V))}function Bs(t){return Ln.singleton(ks(t,K.MESSAGES.MS.END,K.MESSAGES.MS.FRAC_V),{kind:"LAST"})}function Gs(t){return Ln.singleton(ks(t,K.MESSAGES.MS.FRAC_OVER),{})}function $s(t){return Ln.singleton(ks(t,K.MESSAGES.MS.START,K.MESSAGES.MS.FRAC_B))}function js(t){return Ln.singleton(ks(t,K.MESSAGES.MS.END,K.MESSAGES.MS.FRAC_B),{kind:"LAST"})}function Vs(t){const e=Ps(t);return Ln.singleton(1===e?K.MESSAGES.MS.FRAC_S:K.FUNCTIONS.combineNestedFraction(K.MESSAGES.MS.NEST_FRAC,K.FUNCTIONS.radicalNestDepth(e-1),K.MESSAGES.MS.FRAC_S))}function Hs(t){const e=Ps(t);return Ln.singleton(1===e?K.MESSAGES.MS.ENDFRAC:K.FUNCTIONS.combineNestedFraction(K.MESSAGES.MS.NEST_FRAC,K.FUNCTIONS.radicalNestDepth(e-1),K.MESSAGES.MS.ENDFRAC),{kind:"LAST"})}function Ws(t){const e=Ps(t);return Ln.singleton(1===e?K.MESSAGES.MS.FRAC_OVER:K.FUNCTIONS.combineNestedFraction(K.MESSAGES.MS.NEST_FRAC,K.FUNCTIONS.radicalNestDepth(e-1),K.MESSAGES.MS.FRAC_OVER))}function qs(t){return K.FUNCTIONS.fracNestDepth(t)?[t]:[]}function Ys(t,e,n){for(;t.parentNode;){const r=t.parentNode,s=r.parentNode;if(!s)break;const o=t.getAttribute&&t.getAttribute("role");("subscript"===s.tagName&&t===r.childNodes[1]||"tensor"===s.tagName&&o&&("leftsub"===o||"rightsub"===o))&&(e=n.sub+K.MESSAGES.regexp.JOINER_SUBSUPER+e),("superscript"===s.tagName&&t===r.childNodes[1]||"tensor"===s.tagName&&o&&("leftsuper"===o||"rightsuper"===o))&&(e=n.sup+K.MESSAGES.regexp.JOINER_SUBSUPER+e),t=s}return e.trim()}function Xs(t){return Ln.singleton(Ys(t,K.MESSAGES.MS.SUBSCRIPT,{sup:K.MESSAGES.MS.SUPER,sub:K.MESSAGES.MS.SUB}))}function Ks(t){return Ln.singleton(Ys(t,K.MESSAGES.MS.SUB,{sup:K.MESSAGES.MS.SUP,sub:K.MESSAGES.MS.SUB}))}function zs(t){return Ln.singleton(Ys(t,K.MESSAGES.MS.SUPERSCRIPT,{sup:K.MESSAGES.MS.SUPER,sub:K.MESSAGES.MS.SUB}))}function Js(t){return Ln.singleton(Ys(t,K.MESSAGES.MS.SUP,{sup:K.MESSAGES.MS.SUP,sub:K.MESSAGES.MS.SUB}))}function Zs(t){const e=Ys(t,"",{sup:K.MESSAGES.MS.SUPER,sub:K.MESSAGES.MS.SUB});return Ln.singleton(e?e.replace(new RegExp(K.MESSAGES.MS.SUB+"$"),K.MESSAGES.MS.SUBSCRIPT).replace(new RegExp(K.MESSAGES.MS.SUPER+"$"),K.MESSAGES.MS.SUPERSCRIPT):K.MESSAGES.MS.BASELINE)}function Qs(t){const e=Ys(t,"",{sup:K.MESSAGES.MS.SUP,sub:K.MESSAGES.MS.SUB});return Ln.singleton(e||K.MESSAGES.MS.BASE)}function to(t){return ws("radical",t,["sqrt","root"],vs,{})}function eo(t,e,n){const r=to(t),s=function(t){const e="sqrt"===t.tagName?"2":O("children/*[1]",t)[0].textContent.trim();return K.MESSAGES.MSroots[e]||""}(t);return n=s?K.FUNCTIONS.combineRootIndex(n,s):n,1===r?n:K.FUNCTIONS.combineNestedRadical(e,K.FUNCTIONS.radicalNestDepth(r-1),n)}function no(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NESTED,K.MESSAGES.MS.STARTROOT))}function ro(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NESTED,K.MESSAGES.MS.ENDROOT))}function so(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NESTED,K.MESSAGES.MS.ROOTINDEX))}function oo(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.STARTROOT))}function io(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.ENDROOT))}function co(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.ROOTINDEX))}function ao(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.ROOT))}function lo(t){return Ln.singleton(eo(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.INDEX))}function uo(t){const e=function(t){return ws("underscore",t,["underscore"],vs,{},(function(t){return t.tagName&&"underscore"===t.tagName&&"underaccent"===t.childNodes[0].childNodes[1].getAttribute("role")}))}(t);return Ln.singleton(Array(e).join(K.MESSAGES.MS.UNDER)+K.MESSAGES.MS.UNDERSCRIPT)}function ho(t){return Ln.singleton(K.MESSAGES.MS.ENDSCRIPTS)}function fo(t){const e=function(t){return ws("overscore",t,["overscore"],vs,{},(function(t){return t.tagName&&"overscore"===t.tagName&&"overaccent"===t.childNodes[0].childNodes[1].getAttribute("role")}))}(t);return Ln.singleton(Array(e).join(K.MESSAGES.MS.OVER)+K.MESSAGES.MS.OVERSCRIPT)}function po(t){if("matrix"!==t.tagName||"determinant"!==t.getAttribute("role"))return[];const e=O("children/row/children/cell/children/*",t);for(let t,n=0;t=e[n];n++)if("number"!==t.tagName){if("identifier"===t.tagName){const e=t.getAttribute("role");if("latinletter"===e||"greekletter"===e||"otherletter"===e)continue}return[]}return[t]}function mo(){const t=t=>t.map((t=>"ancestor::"+t)),e=t=>"not("+t+")",n=e(t(["subscript","superscript","tensor"]).join(" or ")),r=t(["relseq","multrel"]),s=t(["fraction","punctuation","fenced","sqrt","root"]);let o=[];for(let t,e=0;t=s[e];e++)o=o.concat(r.map((function(e){return t+"/"+e})));return[["ancestor::*/following-sibling::*",n,e(o.join(" | "))].join(" and ")]}function go(t){if(!t.childNodes.length||!t.childNodes[0].childNodes.length||!t.childNodes[0].childNodes[0].childNodes.length)return Ln.singleton("");const e=t.childNodes[0].childNodes[0].childNodes[0].textContent;return Ln.singleton(e.match(/^\(.+\)$/)?e.slice(1,-1):e)}const So=new Map([[3,"CSFleftsuperscript"],[4,"CSFleftsubscript"],[2,"CSFbaseline"],[1,"CSFrightsubscript"],[0,"CSFrightsuperscript"]]),No=new Map([[4,2],[3,3],[2,1],[1,4],[0,5]]);function Eo(t){const e=[];let n="",r="",s=parseInt(t,2);for(let t=0;t<5;t++){const o="children/*["+No.get(t)+"]";if(1&s){const e=So.get(t%5);n="[t] "+e+"Verbose; [n] "+o+";"+n,r="[t] "+e+"Brief; [n] "+o+";"+r}else e.unshift("name("+o+')="empty"');s>>=1}return[e,n,r]}function bo(t,e=!0){const n=["11111","11110","11101","11100","10111","10110","10101","10100","01111","01110","01101","01100"];for(const r of n){let n="tensor"+r,[s,o,i]=Eo(r);if(t.defineRule(n,"default",o,"self::tensor",...s),e&&(t.defineRule(n,"brief",i,"self::tensor",...s),t.defineRule(n,"sbrief",i,"self::tensor",...s)),!(3&parseInt(r,2)))continue;const c=So.get(2);o+="; [t]"+c+"Verbose",i+="; [t]"+c+"Brief",n+="-baseline";const a="((.//*[not(*)])[last()]/@id)!=(((.//ancestor::fraction|ancestor::root|ancestor::sqrt|ancestor::cell|ancestor::line|ancestor::stree)[1]//*[not(*)])[last()]/@id)";t.defineRule(n,"default",o,"self::tensor",a,...s),e&&(t.defineRule(n,"brief",i,"self::tensor",a,...s),t.defineRule(n,"sbrief",i,"self::tensor",a,...s))}}function Ao(t){let e=Object.keys(K.MESSAGES.MSroots).length;if(!e)return[];if(e++,!t.childNodes||0===t.childNodes.length||!t.childNodes[0].childNodes)return[];const n=t.childNodes[0].childNodes[0].textContent;if(!/^\d+$/.test(n))return[];const r=parseInt(n,10);return r>1&&r<=e?[t]:[]}function yo(t,e){let n=0;return function(){return K.NUMBERS.numericOrdinal(++n)+" "+e}}function To(t,e){let n=0;return function(){return K.NUMBERS.numberToOrdinal(++n,!1)+" "+e}}function Co(t){const e=q(t,K.MESSAGES.MS.FRAC_OVER);return e.convertible&&e.enumerator&&e.denominator?[Ln.node(K.NUMBERS.numberToWords(e.enumerator),t.childNodes[0].childNodes[0],{separator:""}),Ln.stringAttr(K.NUMBERS.vulgarSep,{separator:""}),Ln.node(K.NUMBERS.numberToOrdinal(e.denominator,1!==e.enumerator),t.childNodes[0].childNodes[1])]:[Ln.node(e.content||"",t)]}function _o(t){const e=R(t.parentNode.childNodes);return Ln.singleton(K.NUMBERS.numericOrdinal(e.indexOf(t)+1).toString())}function Io(t){const e=Zs(t);return e[0].speech=e[0].speech.replace(/-$/,""),e}function Oo(t){const e=Qs(t);return e[0].speech=e[0].speech.replace(/-$/,""),e}function Mo(t){const e=zs(t);return e[0].speech=e[0].speech.replace(/^exposant/,"exposant gauche"),e}function Ro(t){const e=Xs(t);return e[0].speech=e[0].speech.replace(/^indice/,"indice gauche"),e}function xo(t){const e=Js(t);return e[0].speech=e[0].speech.replace(/^sup/,"sup gauche"),e}function Lo(t){const e=Ks(t);return e[0].speech=e[0].speech.replace(/^sub/,"sub gauche"),e}function vo(t,e,n){const r=Ps(t),s=Array.apply(null,Array(r)).map((t=>e));return n&&s.unshift(n),s.join(K.MESSAGES.regexp.JOINER_FRAC)}function Fo(t){return Ln.singleton(vo(t,K.MESSAGES.MS.START,K.MESSAGES.MS.FRAC_V))}function wo(t){return Ln.singleton(vo(t,K.MESSAGES.MS.END,K.MESSAGES.MS.FRAC_V))}function Do(t){return Ln.singleton(vo(t,K.MESSAGES.MS.START,K.MESSAGES.MS.FRAC_B))}function Po(t){return Ln.singleton(vo(t,K.MESSAGES.MS.END,K.MESSAGES.MS.FRAC_B))}function ko(t){const e=Ps(t);return 1===e?Ln.singleton(K.MESSAGES.MS.FRAC_S):Ln.singleton(K.FUNCTIONS.combineNestedFraction(K.FUNCTIONS.radicalNestDepth(e-1),K.MESSAGES.MS.NEST_FRAC,K.MESSAGES.MS.FRAC_S))}function Uo(t){const e=Ps(t);return 1===e?Ln.singleton(K.MESSAGES.MS.ENDFRAC):Ln.singleton(K.FUNCTIONS.combineNestedFraction(K.FUNCTIONS.radicalNestDepth(e-1),K.MESSAGES.MS.NEST_FRAC,K.MESSAGES.MS.ENDFRAC))}function Bo(t){const e=Ps(t);return 1===e?Ln.singleton(K.MESSAGES.MS.FRAC_OVER):Ln.singleton(K.FUNCTIONS.combineNestedFraction(K.FUNCTIONS.radicalNestDepth(e-1),K.MESSAGES.MS.NEST_FRAC,K.MESSAGES.MS.FRAC_OVER))}function Go(t){return 1===O("children/*[1]",t)[0].toString().match(/[^>\u2062>]+<\/[^>]*>/g).length?[t]:[]}function $o(t,e,n){const r=to(t);return 1===r?n:K.FUNCTIONS.combineNestedRadical(K.FUNCTIONS.radicalNestDepth(r-1),e,n)}function jo(t){return Ln.singleton($o(t,K.MESSAGES.MS.NESTED,K.MESSAGES.MS.STARTROOT))}function Vo(t){return Ln.singleton($o(t,K.MESSAGES.MS.NESTED,K.MESSAGES.MS.ENDROOT))}function Ho(t){return Ln.singleton($o(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.STARTROOT))}function Wo(t){return Ln.singleton($o(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.ENDROOT))}function qo(t){return Ln.singleton($o(t,K.MESSAGES.MS.NEST_ROOT,K.MESSAGES.MS.ROOT))}function Yo(t,e){const n=function(t){const e=O("children/*[1]",t)[0].textContent.trim();return K.MESSAGES.MSroots[e]||e+"\uc81c\uacf1\uadfc"}(t);return n||e}function Xo(t){return Ln.singleton(Yo(t,K.MESSAGES.MS.ROOTINDEX))}function Ko(t){return Ln.singleton(Yo(t,K.MESSAGES.MS.ROOTINDEX))}function zo(t){return Ln.singleton(Yo(t,K.MESSAGES.MS.INDEX))}function Jo(t){const e=O("children/*",t);return Ln.singleton(K.NUMBERS.wordOrdinal(e.length))}function Zo(t){const e=O("children/*",t);return Ln.singleton(K.NUMBERS.wordOrdinal(e.length-1))}function Qo(t){const e=O("children/*",t),n=O("content/*",t);return Ln.singleton(K.NUMBERS.wordOrdinal(e.length-n.length))}function ti(t,e){const n=t;let r=0;return function(){const t=vn.create({text:ni(n[r])&&ri(n[r+1])?K.MESSAGES.unitTimes:""},{});return r++,[t]}}const ei=["superscript","subscript","overscore","underscore"];function ni(t){for(;t;){if("unit"===t.getAttribute("role"))return!0;const e=t.tagName,n=O("children/*",t);t=-1!==ei.indexOf(e)?n[0]:n[n.length-1]}return!1}function ri(t){for(;t;){if("unit"===t.getAttribute("role"))return!0;t=O("children/*",t)[0]}return!1}function si(t){for(;t;){if("number"===t.tagName&&"1"===t.textContent)return[t];if("infixop"!==t.tagName||"multiplication"!==t.getAttribute("role")&&"implicit"!==t.getAttribute("role"))return[];t=O("children/*",t)[0]}return[]}function oi(t){const e=Ps(t);return Ln.singleton(new Array(e).join(K.MESSAGES.MS.FRACTION_REPEAT)+K.MESSAGES.MS.FRACTION_START)}function ii(t){const e=Ps(t);return Ln.singleton(new Array(e).join(K.MESSAGES.MS.FRACTION_REPEAT)+K.MESSAGES.MS.FRACTION_END)}function ci(t){const e=Ps(t);return Ln.singleton(new Array(e).join(K.MESSAGES.MS.FRACTION_REPEAT)+K.MESSAGES.MS.FRACTION_OVER)}function ai(t){const e=Ps(t);return Ln.singleton(new Array(e).join(K.MESSAGES.MS.FRACTION_REPEAT)+"\u2838"+K.MESSAGES.MS.FRACTION_OVER)}function li(t){return K.MESSAGES.regexp.HYPER===Ps(t).toString()?[t]:[]}function ui(t,e){const n=hi(t);return Ln.singleton(1===n?e:new Array(n).join(K.MESSAGES.MS.NESTED)+e)}function hi(t,e){const n=e||0;return t.parentNode?hi(t.parentNode,"root"===t.tagName||"sqrt"===t.tagName?n+1:n):n}function di(t){return ui(t,K.MESSAGES.MS.STARTROOT)}function fi(t){return ui(t,K.MESSAGES.MS.ENDROOT)}function pi(t){return ui(t,K.MESSAGES.MS.ROOTINDEX)}nt.getInstance().setCorrection("enlargeFence",(function(t){const e="\u2820";if(1===t.length)return e+t;const n=t.split("");return n.every((function(t){return"\u2833"===t}))?e+n.join(e):t.slice(0,-1)+e+t.slice(-1)}));const mi=["multirel","relseq","appl","row","line"],gi=["subscript","superscript","overscore","underscore"];function Si(t,e){const n=t.parent;if(!n)return!1;const r=n.type;return-1!==mi.indexOf(r)||"prefixop"===r&&"negative"===n.role&&!e.script||"prefixop"===r&&"geometry"===n.role||!("punctuated"!==r||e.enclosed&&"text"!==n.role)}function Ni(t,e){const n=t.slice(0);let r,s=!0;return r=t.length>0?O("../../content/*",t[0]):[],function(){const t=r.shift(),o=n.shift(),i=n[0],c=e?[vn.create({text:e},{translate:!0})]:[];if(!t)return c;const a=o?Ys(o,"",{sup:K.MESSAGES.MS.SUPER,sub:K.MESSAGES.MS.SUB}):"",l=o&&"EMPTY"!==B(o)||s&&t.parentNode.parentNode&&t.parentNode.parentNode.previousSibling?[vn.create({text:K.MESSAGES.regexp.SPACE+a},{})]:[],u=i&&"EMPTY"!==B(i)||!r.length&&t.parentNode.parentNode&&t.parentNode.parentNode.nextSibling?[vn.create({text:K.MESSAGES.regexp.SPACE},{})]:[],h=E.evaluateNode(t);return s=!1,c.concat(l,h,u)}}function Ei(t,e){const n=t.slice(0);let r;return r=t.length>0?O("../../content/*",t[0]):[],function(){const t=n.shift(),s=n[0],o=r.shift(),i=e?[vn.create({text:e},{translate:!0})]:[];if(!o)return i;const c=t&&"NUMBER"===B(t),a=s&&"NUMBER"===B(s);return i.concat(c&&a&&"space"===o.getAttribute("role")?[vn.create({text:K.MESSAGES.regexp.SPACE},{})]:[])}}jn(new Bn("nemeth","number",(function(t,e){return t.childNodes.length?(-1!==gi.indexOf(t.type)&&(e.script=!0),"fenced"===t.type?(e.number=!1,e.enclosed=!0,["",e]):(Si(t,e)&&(e.number=!0,e.enclosed=!1),["",e])):(Si(t,e)&&(e.number=!0,e.script=!1,e.enclosed=!1),[e.number?"number":"",{number:!1,enclosed:e.enclosed,script:e.script}])}),{number:!0}));let bi=!1;function Ai(){bi||(wn(c.BASE_LOCALE+".speech.mathspeak","",{CQFspaceoutNumber:xs,CQFspaceoutIdentifier:Ls,CSFspaceoutText:Ms,CSFopenFracVerbose:Us,CSFcloseFracVerbose:Bs,CSFoverFracVerbose:Gs,CSFopenFracBrief:$s,CSFcloseFracBrief:js,CSFopenFracSbrief:Vs,CSFcloseFracSbrief:Hs,CSFoverFracSbrief:Ws,CSFvulgarFraction:Co,CQFvulgarFractionSmall:qs,CSFopenRadicalVerbose:no,CSFcloseRadicalVerbose:ro,CSFindexRadicalVerbose:so,CSFopenRadicalBrief:oo,CSFcloseRadicalBrief:io,CSFindexRadicalBrief:co,CSFopenRadicalSbrief:ao,CSFindexRadicalSbrief:lo,CQFisSmallRoot:Ao,CSFsuperscriptVerbose:zs,CSFsuperscriptBrief:Js,CSFsubscriptVerbose:Xs,CSFsubscriptBrief:Ks,CSFbaselineVerbose:Zs,CSFbaselineBrief:Qs,CSFleftsuperscriptVerbose:zs,CSFleftsubscriptVerbose:Xs,CSFrightsuperscriptVerbose:zs,CSFrightsubscriptVerbose:Xs,CSFleftsuperscriptBrief:Js,CSFleftsubscriptBrief:Ks,CSFrightsuperscriptBrief:Js,CSFrightsubscriptBrief:Ks,CSFunderscript:uo,CSFoverscript:fo,CSFendscripts:ho,CTFordinalCounter:yo,CTFwordCounter:To,CTFcontentIterator:kn,CQFdetIsSimple:po,CSFRemoveParens:go,CQFresetNesting:Fs,CGFbaselineConstraint:mo,CGFtensorRules:bo}),wn("es.speech.mathspeak",c.BASE_LOCALE+".speech.mathspeak",{CTFunitMultipliers:ti,CQFoneLeft:si}),wn("fr.speech.mathspeak",c.BASE_LOCALE+".speech.mathspeak",{CSFbaselineVerbose:Io,CSFbaselineBrief:Oo,CSFleftsuperscriptVerbose:Mo,CSFleftsubscriptVerbose:Ro,CSFleftsuperscriptBrief:xo,CSFleftsubscriptBrief:Lo}),wn("ko.speech.mathspeak",c.BASE_LOCALE+".speech.mathspeak",{CSFopenFracVerbose:Fo,CSFcloseFracVerbose:wo,CSFopenFracBrief:Do,CSFcloseFracBrief:Po,CSFopenFracSbrief:ko,CSFoverFracSbrief:Bo,CSFcloseFracSbrief:Uo,CQFisSimpleIndex:Go,CSFindexRadicalVerbose:Xo,CSFindexRadicalBrief:Ko,CSFindexRadicalSbrief:zo,CSFopenRadicalVerbose:jo,CSFcloseRadicalVerbose:Vo,CSFopenRadicalBrief:Ho,CSFcloseRadicalBrief:Wo,CSFopenRadicalSbrief:qo}),wn(c.BASE_LOCALE+".speech.clearspeak","",{CTFpauseSeparator:Pn,CTFnodeCounter:Hn,CTFcontentIterator:kn,CSFvulgarFraction:Co,CQFvulgarFractionSmall:tr,CQFcellsSimple:Qn,CSFordinalExponent:er,CSFwordOrdinal:lr,CQFmatchingFences:sr,CSFnestingDepth:rr,CQFfencedArguments:or,CQFsimpleArguments:ir,CQFspaceoutNumber:xs}),wn("en.prefix.default","",{CSFordinalPosition:_o}),wn("en.speech.chromevox","",{CTFnodeCounter:Dn,CTFcontentIterator:kn}),wn("en.speech.emacspeak","en.speech.chromevox",{CQFvulgarFractionSmall:qs,CSFvulgarFraction:Co}),wn("ko.summary.","ko.speech.mathspeak",{CSFordinalConversion:Jo,CSFdecreasedOrdinalConversion:Zo,CSFlistOrdinalConversion:Qo}),wn("nemeth.braille.default",c.BASE_LOCALE+".speech.mathspeak",{CSFopenFraction:oi,CSFcloseFraction:ii,CSFoverFraction:ci,CSFoverBevFraction:ai,CQFhyperFraction:li,CSFopenRadical:di,CSFcloseRadical:fi,CSFindexRadical:pi,CSFsubscript:Xs,CSFsuperscript:zs,CSFbaseline:Zs,CGFtensorRules:t=>bo(t,!1),CTFrelationIterator:Ni,CTFimplicitIterator:Ei}),bi=!0)}class yi{constructor(t,e,n,r){this.name=t,this.dynamicCstr=e,this.precondition=n,this.action=r,this.context=null}toString(){return this.name+" | "+this.dynamicCstr.toString()+" | "+this.precondition.toString()+" ==> "+this.action.toString()}}var Ti,Ci;function _i(t){switch(t){case"[n]":return Ti.NODE;case"[m]":return Ti.MULTI;case"[t]":return Ti.TEXT;case"[p]":return Ti.PERSONALITY;default:throw"Parse error: "+t}}!function(t){t.NODE="NODE",t.MULTI="MULTI",t.TEXT="TEXT",t.PERSONALITY="PERSONALITY"}(Ti||(Ti={}));class Ii{static grammarFromString(t){return nt.parseInput(t)}static fromString(t){const e={type:_i(t.substring(0,3))};let n=t.slice(3).trim();if(!n)throw new Ri("Missing content.");switch(e.type){case Ti.TEXT:if('"'===n[0]){const t=xi(n,"\\(")[0].trim();if('"'!==t.slice(-1))throw new Ri("Invalid string syntax.");e.content=t,n=n.slice(t.length).trim(),-1===n.indexOf("(")&&(n="");break}case Ti.NODE:case Ti.MULTI:{const t=n.indexOf(" (");if(-1===t){e.content=n.trim(),n="";break}e.content=n.substring(0,t).trim(),n=n.slice(t).trim()}}if(n){const t=Ii.attributesFromString(n);t.grammar&&(e.grammar=t.grammar,delete t.grammar),Object.keys(t).length&&(e.attributes=t)}return new Ii(e)}static attributesFromString(t){if("("!==t[0]||")"!==t.slice(-1))throw new Ri("Invalid attribute expression: "+t);const e={},n=xi(t.slice(1,-1),",");for(const t of n){const n=t.indexOf(":");if(-1===n)e[t.trim()]="true";else{const r=t.substring(0,n).trim(),s=t.slice(n+1).trim();e[r]=r===et?Ii.grammarFromString(s):s}}return e}constructor({type:t,content:e,attributes:n,grammar:r}){this.type=t,this.content=e,this.attributes=n,this.grammar=r}toString(){let t="";t+=function(t){switch(t){case Ti.NODE:return"[n]";case Ti.MULTI:return"[m]";case Ti.TEXT:return"[t]";case Ti.PERSONALITY:return"[p]";default:throw"Unknown type error: "+t}}(this.type),t+=this.content?" "+this.content:"";const e=this.attributesToString();return t+=e?" "+e:"",t}grammarToString(){return this.getGrammar().join(":")}getGrammar(){if(!this.grammar)return[];const t=[];for(const[e,n]of Object.entries(this.grammar))t.push(!0===n?e:!1===n?`!${e}`:`${e}=${n}`);return t}attributesToString(){const t=this.getAttributes(),e=this.grammarToString();return e&&t.push("grammar:"+e),t.length>0?"("+t.join(", ")+")":""}getAttributes(){if(!this.attributes)return[];const t=[];for(const[e,n]of Object.entries(this.attributes))t.push("true"===n?e:`${e}:${n}`);return t}}class Oi{static fromString(t){const e=xi(t,";").filter((function(t){return t.match(/\S/)})).map((function(t){return t.trim()})),n=[];for(let t=0,r=e.length;t<r;t++){const r=Ii.fromString(e[t]);r&&n.push(r)}return Oi.naiveSpan(n),new Oi(n)}static naiveSpan(t){var e;let n=!1;for(let r,s=0;r=t[s];s++){if(n&&(r.type!==Ti.TEXT||'"'!==r.content[0]&&!r.content.match(/^CSF/)))continue;if(!n&&r.type===Ti.PERSONALITY)continue;if(!n){n=!0;continue}if(null===(e=r.attributes)||void 0===e?void 0:e.span)continue;const o=t[s+1];o&&o.type!==Ti.NODE||Oi.addNaiveSpan(r,o?o.content:"LAST")}}static addNaiveSpan(t,e){t.attributes||(t.attributes={}),t.attributes.span=e}constructor(t){this.components=t}toString(){return this.components.map((function(t){return t.toString()})).join("; ")}}class Mi{static constraintValue(t,e){for(let n,r=0;n=e[r];r++)if(t.match(n))return++r;return 0}toString(){const t=this.constraints.join(", ");return`${this.query}, ${t} (${this.priority}, ${this.rank})`}constructor(t,...e){this.query=t,this.constraints=e;const[n,r]=this.presetPriority();this.priority=n?r:this.calculatePriority()}calculatePriority(){const t=Mi.constraintValue(this.query,Mi.queryPriorities);if(!t)return 0;const e=this.query.match(/^self::.+\[(.+)\]/);let n=0;if((null==e?void 0:e.length)&&e[1]){const t=e[1];n=Mi.constraintValue(t,Mi.attributePriorities)}return 100*t+10*n}presetPriority(){if(!this.constraints.length)return[!1,0];const t=this.constraints[this.constraints.length-1].match(/^priority=(.*$)/);if(!t)return[!1,0];this.constraints.pop();const e=parseFloat(t[1]);return[!0,isNaN(e)?0:e]}}Mi.queryPriorities=[/^self::\*$/,/^self::[\w-]+$/,/^self::\*\[.+\]$/,/^self::[\w-]+\[.+\]$/],Mi.attributePriorities=[/^@[\w-]+$/,/^@[\w-]+!=".+"$/,/^not\(contains\(@[\w-]+,\s*".+"\)\)$/,/^contains\(@[\w-]+,".+"\)$/,/^@[\w-]+=".+"$/];class Ri extends S{constructor(t){super(t),this.name="RuleError"}}function xi(t,e){const n=[];let r="";for(;""!==t;){const s=t.search(e);if(-1===s){if((t.match(/"/g)||[]).length%2!=0)throw new Ri("Invalid string in expression: "+t);n.push(r+t),r="",t=""}else if((t.substring(0,s).match(/"/g)||[]).length%2==0)n.push(r+t.substring(0,s)),r="",t=t.substring(s+1);else{const e=t.substring(s).search('"');if(-1===e)throw new Ri("Invalid string in expression: "+t);r+=t.substring(0,s+e+1),t=t.substring(s+e+1)}}return r&&n.push(r),n}class Li{constructor(t,e){this.prefix=t,this.store=e}add(t,e){this.checkCustomFunctionSyntax_(t)&&(this.store[t]=e)}addStore(t){const e=Object.keys(t.store);for(let n,r=0;n=e[r];r++)this.add(n,t.store[n])}lookup(t){return this.store[t]}checkCustomFunctionSyntax_(t){const e=new RegExp("^"+this.prefix);return!!t.match(e)||(console.error("FunctionError: Invalid function name. Expected prefix "+this.prefix),!1)}}class vi extends Li{constructor(){super("CQF",{})}}class Fi extends Li{constructor(){super("CSF",{})}}class wi extends Li{constructor(){super("CTF",{})}}class Di extends Li{constructor(){super("CGF",{})}}class Pi{constructor(){this.customQueries=new vi,this.customStrings=new Fi,this.contextFunctions=new wi,this.customGenerators=new Di}applyCustomQuery(t,e){const n=this.customQueries.lookup(e);return n?n(t):null}applySelector(t,e){return this.applyCustomQuery(t,e)||O(e,t)}applyQuery(t,e){const n=this.applySelector(t,e);return n.length>0?n[0]:null}applyConstraint(t,e){return!!this.applyQuery(t,e)||function(t,e){let n;try{n=I(t,e,y.result.BOOLEAN_TYPE)}catch(t){return!1}return n.booleanValue}(e,t)}constructString(t,e){const n=this.constructString_(t,e);return Array.isArray(n)?n.map((t=>t.speech)).join(""):n}constructSpan(t,e,n){const r=this.constructString_(t,e);if(Array.isArray(r)){const t=r[r.length-1];return t.attributes=Object.assign({},n,t.attributes),r}return[Ln.node(r,t,n)]}constructString_(t,e){if(!e)return"";if('"'===e.charAt(0))return e.slice(1,-1);const n=this.customStrings.lookup(e);return n?n(t):function(t,e){let n;try{n=I(t,e,y.result.STRING_TYPE)}catch(t){return""}return n.stringValue}(e,t)}parse(t){const e=Array.isArray(t)?t:Object.entries(t);for(const t of e){switch(t[0].slice(0,3)){case"CQF":this.customQueries.add(t[0],t[1]);break;case"CSF":this.customStrings.add(t[0],t[1]);break;case"CTF":this.contextFunctions.add(t[0],t[1]);break;case"CGF":this.customGenerators.add(t[0],t[1]);break;default:console.error("FunctionError: Invalid function name "+t[0])}}}}class ki{static compareStaticConstraints_(t,e){if(t.length!==e.length)return!1;for(let n,r=0;n=t[r];r++)if(-1===e.indexOf(n))return!1;return!0}static comparePreconditions_(t,e){const n=t.precondition,r=e.precondition;return n.query===r.query&&ki.compareStaticConstraints_(n.constraints,r.constraints)}constructor(){this.context=new Pi,this.parseOrder=c.DEFAULT_ORDER,this.parser=new a(this.parseOrder),this.locale=c.DEFAULT_VALUES[r.LOCALE],this.modality=c.DEFAULT_VALUES[r.MODALITY],this.domain="",this.initialized=!1,this.inherits=null,this.kind="standard",this.customTranscriptions={},this.preconditions=new Map,this.speechRules_=[],this.rank=0,this.parseMethods={Rule:this.defineRule,Generator:this.generateRules,Action:this.defineAction,Precondition:this.definePrecondition,Ignore:this.ignoreRules}}defineRule(t,e,n,r,...s){const o=this.parseAction(n),i=this.parsePrecondition(r,s),c=this.parseCstr(e);if(!(o&&i&&c))return console.error(`Rule Error: ${r}, (${e}): ${n}`),null;const a=new yi(t,c,i,o);return a.precondition.rank=this.rank++,this.addRule(a),a}addRule(t){t.context=this.context,this.speechRules_.unshift(t)}deleteRule(t){const e=this.speechRules_.indexOf(t);-1!==e&&this.speechRules_.splice(e,1)}findRule(t){for(let e,n=0;e=this.speechRules_[n];n++)if(t(e))return e;return null}findAllRules(t){return this.speechRules_.filter(t)}evaluateDefault(t){const e=t.textContent.slice(0);return e.match(/^\s+$/)?this.evaluateWhitespace(e):this.evaluateString(e)}evaluateWhitespace(t){return[]}evaluateCustom(t){const e=this.customTranscriptions[t];return void 0!==e?vn.create({text:e},{adjust:!0,translate:!1}):null}evaluateCharacter(t){return this.evaluateCustom(t)||vn.create({text:t},{adjust:!0,translate:!0})}removeDuplicates(t){for(let e,n=this.speechRules_.length-1;e=this.speechRules_[n];n--)e!==t&&t.dynamicCstr.equal(e.dynamicCstr)&&ki.comparePreconditions_(e,t)&&this.speechRules_.splice(n,1)}getSpeechRules(){return this.speechRules_}setSpeechRules(t){this.speechRules_=t}getPreconditions(){return this.preconditions}parseCstr(t){try{return this.parser.parse(this.locale+"."+this.modality+(this.domain?"."+this.domain:"")+"."+t)}catch(e){if("RuleError"===e.name)return console.error("Rule Error ",`Illegal Dynamic Constraint: ${t}.`,e.message),null;throw e}}parsePrecondition(t,e){try{const n=this.parsePrecondition_(t);t=n[0];let r=n.slice(1);for(const t of e)r=r.concat(this.parsePrecondition_(t));return new Mi(t,...r)}catch(n){if("RuleError"===n.name)return console.error("Rule Error ",`Illegal preconditions: ${t}, ${e}.`,n.message),null;throw n}}parseAction(t){try{return Oi.fromString(t)}catch(e){if("RuleError"===e.name)return console.error("Rule Error ",`Illegal action: ${t}.`,e.message),null;throw e}}parse(t){this.modality=t.modality||this.modality,this.locale=t.locale||this.locale,this.domain=t.domain||this.domain,this.context.parse(t.functions||[]),"actions"!==t.kind&&(this.kind=t.kind||this.kind,this.inheritRules()),this.parseRules(t.rules||[])}parseRules(t){for(let e,n=0;e=t[n];n++){const t=e[0],n=this.parseMethods[t];t&&n&&n.apply(this,e.slice(1))}}generateRules(t){const e=this.context.customGenerators.lookup(t);e&&e(this)}defineAction(t,e){let n;try{n=Oi.fromString(e)}catch(t){if("RuleError"===t.name)return void console.error("Action Error ",e,t.message);throw t}const r=this.getFullPreconditions(t);if(!r)return void console.error(`Action Error: No precondition for action ${t}`);this.ignoreRules(t);const s=new RegExp("^\\w+\\.\\w+\\."+(this.domain?"\\w+\\.":""));r.conditions.forEach((([e,r])=>{const o=this.parseCstr(e.toString().replace(s,""));this.addRule(new yi(t,o,r,n))}))}getFullPreconditions(t){const e=this.preconditions.get(t);return e||!this.inherits?e:this.inherits.getFullPreconditions(t)}definePrecondition(t,e,n,...r){const s=this.parsePrecondition(n,r),o=this.parseCstr(e);s&&o?(s.rank=this.rank++,this.preconditions.set(t,new Ui(o,s))):console.error(`Precondition Error: ${n}, (${e})`)}inheritRules(){if(!this.inherits||!this.inherits.getSpeechRules().length)return;const t=new RegExp("^\\w+\\.\\w+\\."+(this.domain?"\\w+\\.":""));this.inherits.getSpeechRules().forEach((e=>{const n=this.parseCstr(e.dynamicCstr.toString().replace(t,""));this.addRule(new yi(e.name,n,e.precondition,e.action))}))}ignoreRules(t,...e){let n=this.findAllRules((e=>e.name===t));if(!e.length)return void n.forEach(this.deleteRule.bind(this));let r=[];for(const t of e){const e=this.parseCstr(t);for(const t of n)e.equal(t.dynamicCstr)?this.deleteRule(t):r.push(t);n=r,r=[]}}parsePrecondition_(t){const e=this.context.customGenerators.lookup(t);return e?e():[t]}}class Ui{constructor(t,e){this.base=t,this._conditions=[],this.constraints=[],this.allCstr={},this.constraints.push(t),this.addCondition(t,e)}get conditions(){return this._conditions}addConstraint(t){if(this.constraints.filter((e=>e.equal(t))).length)return;this.constraints.push(t);const e=[];for(const[n,r]of this.conditions)this.base.equal(n)&&e.push([t,r]);this._conditions=this._conditions.concat(e)}addBaseCondition(t){this.addCondition(this.base,t)}addFullCondition(t){this.constraints.forEach((e=>this.addCondition(e,t)))}addCondition(t,e){const n=t.toString()+" "+e.toString();this.allCstr.condStr||(this.allCstr[n]=!0,this._conditions.push([t,e]))}}class Bi extends ki{constructor(){super(),this.annotators=[],this.parseMethods.Alias=this.defineAlias,this.parseMethods.SpecializedRule=this.defineSpecializedRule,this.parseMethods.Specialized=this.defineSpecialized}initialize(){this.initialized||(this.annotations(),this.initialized=!0)}annotations(){for(let t,e=0;t=this.annotators[e];e++)Vn(this.domain,t)}defineAlias(t,e,...n){const r=this.parsePrecondition(e,n);if(!r)return void console.error(`Precondition Error: ${e} ${n}`);const s=this.preconditions.get(t);s?s.addFullCondition(r):console.error(`Alias Error: No precondition by the name of ${t}`)}defineRulesAlias(t,e,...n){const r=this.findAllRules((function(e){return e.name===t}));if(0===r.length)throw new Ri("Rule with name "+t+" does not exist.");const s=[];r.forEach((t=>{(t=>{const e=t.dynamicCstr.toString(),n=t.action.toString();for(let t,r=0;t=s[r];r++)if(t.action===n&&t.cstr===e)return!1;return s.push({cstr:e,action:n}),!0})(t)&&this.addAlias_(t,e,n)}))}defineSpecializedRule(t,e,n,r){const s=this.parseCstr(e),o=this.findRule((e=>e.name===t&&s.equal(e.dynamicCstr))),i=this.parseCstr(n);if(!o&&r)throw new Ri("Rule named "+t+" with style "+e+" does not exist.");const c=r?Oi.fromString(r):o.action,a=new yi(o.name,i,o.precondition,c);this.addRule(a)}defineSpecialized(t,e,n){const r=this.parseCstr(n);if(!r)return void console.error(`Dynamic Constraint Error: ${n}`);const s=this.preconditions.get(t);s?s.addConstraint(r):console.error(`Alias Error: No precondition by the name of ${t}`)}evaluateString(t){const e=[];if(t.match(/^\s+$/))return e;let n=this.matchNumber_(t);if(n&&n.length===t.length)return e.push(this.evaluateCharacter(n.number)),e;const r=t.replace(/\s/g," ").split(" ").filter((t=>t));for(let t,s=0;t=r[s];s++)if(1===t.length)e.push(this.evaluateCharacter(t));else if(t.match(new RegExp("^["+K.MESSAGES.regexp.TEXT+"]+$")))e.push(this.evaluateCharacter(t));else{let r=t;for(;r;){n=this.matchNumber_(r);const t=r.match(new RegExp("^["+K.MESSAGES.regexp.TEXT+"]+"));if(n)e.push(this.evaluateCharacter(n.number)),r=r.substring(n.length);else if(t)e.push(this.evaluateCharacter(t[0])),r=r.substring(t[0].length);else{const t=Array.from(r),n=t[0];e.push(this.evaluateCharacter(n)),r=t.slice(1).join("")}}}return e}parse(t){super.parse(t),this.annotators=t.annotators||[]}addAlias_(t,e,n){const r=this.parsePrecondition(e,n),s=new yi(t.name,t.dynamicCstr,r,t.action);s.name=t.name,this.addRule(s)}matchNumber_(t){const e=t.match(new RegExp("^"+K.MESSAGES.regexp.NUMBER)),n=t.match(new RegExp("^"+Bi.regexp.NUMBER));if(!e&&!n)return null;const r=n&&n[0]===t;if(e&&e[0]===t||!r)return e?{number:e[0],length:e[0].length}:null;return{number:n[0].replace(new RegExp(Bi.regexp.DIGIT_GROUP,"g"),"X").replace(new RegExp(Bi.regexp.DECIMAL_MARK,"g"),K.MESSAGES.regexp.DECIMAL_MARK).replace(/X/g,K.MESSAGES.regexp.DIGIT_GROUP.replace(/\\/g,"")),length:n[0].length}}}Bi.regexp={NUMBER:"((\\d{1,3})(?=(,| ))((,| )\\d{3})*(\\.\\d+)?)|^\\d*\\.\\d+|^\\d+",DECIMAL_MARK:"\\.",DIGIT_GROUP:","};class Gi extends Bi{constructor(){super(...arguments),this.modality="braille",this.customTranscriptions={"\u22ca":"\u2808\u2821\u2833"}}evaluateString(t){const e=[],n=Array.from(t);for(let t=0;t<n.length;t++)e.push(this.evaluateCharacter(n[t]));return e}annotations(){for(let t,e=0;t=this.annotators[e];e++)Vn(this.locale,t)}}class $i extends Gi{constructor(){super(...arguments),this.locale="euro",this.customTranscriptions={},this.customCommands={"\\cdot":"*"}}evaluateString(t){const e=t.split(/(\\[a-z]+)/i);return console.log(e),super.evaluateString(this.cleanup(e).join(""))}cleanup(t){let e=[];for(const n of t){if(n.match(/^\\/)){const t=this.customCommands[n];e.push(t||n);continue}const t=n.split("").map((t=>{const e=cn.Meaning.get(t);return"operator"===e.type||"relation"===e.type?" "+t:t}));e=e.concat(t)}return e}}!function(t){t.ROOT="root",t.DYNAMIC="dynamic",t.QUERY="query",t.BOOLEAN="boolean",t.STATIC="static"}(Ci||(Ci={}));class ji{constructor(t,e){this.constraint=t,this.test=e,this.children_={},this.kind=Ci.ROOT}getConstraint(){return this.constraint}getKind(){return this.kind}applyTest(t){return this.test(t)}addChild(t){const e=t.getConstraint(),n=this.children_[e];return this.children_[e]=t,n}getChild(t){return this.children_[t]}getChildren(){const t=[];for(const e of Object.values(this.children_))t.push(e);return t}findChildren(t){const e=[];for(const n of Object.values(this.children_))n.applyTest(t)&&e.push(n);return e}removeChild(t){delete this.children_[t]}toString(){return this.constraint}}class Vi extends ji{constructor(t,e){super(t,e),this.rule_=null,this.kind=Ci.STATIC}getRule(){return this.rule_}setRule(t){this.rule_&&m.getInstance().output("Replacing rule "+this.rule_+" with "+t),this.rule_=t}toString(){return this.getRule()?this.constraint+"\n==> "+this.getRule().action:this.constraint}}function Hi(t,e,n){switch(t){case Ci.ROOT:return new Wi;case Ci.DYNAMIC:return new qi(e);case Ci.QUERY:return new Ki(e,n);case Ci.BOOLEAN:return new zi(e,n);default:return null}}class Wi extends ji{constructor(){super("",(()=>!0)),this.kind=Ci.ROOT}}class qi extends ji{constructor(t){super(t,(e=>e===t)),this.kind=Ci.DYNAMIC}}const Yi={"=":(t,e)=>t===e,"!=":(t,e)=>t!==e,"<":(t,e)=>t<e,">":(t,e)=>t>e,"<=":(t,e)=>t<=e,">=":(t,e)=>t>=e};function Xi(t){if(t.match(/^self::\*$/))return t=>!0;if(t.match(/^self::\w+$/)){const e=t.slice(6).toUpperCase();return t=>t.tagName&&B(t)===e}if(t.match(/^self::\w+:\w+$/)){const e=t.split(":"),n=C(e[2]);if(!n)return null;const r=e[3].toUpperCase();return t=>t.localName&&t.localName.toUpperCase()===r&&t.namespaceURI===n}if(t.match(/^@\w+$/)){const e=t.slice(1);return t=>t.hasAttribute&&t.hasAttribute(e)}if(t.match(/^@\w+="[\w\d ]+"$/)){const e=t.split("="),n=e[0].slice(1),r=e[1].slice(1,-1);return t=>t.hasAttribute&&t.hasAttribute(n)&&t.getAttribute(n)===r}if(t.match(/^@\w+!="[\w\d ]+"$/)){const e=t.split("!="),n=e[0].slice(1),r=e[1].slice(1,-1);return t=>!t.hasAttribute||!t.hasAttribute(n)||t.getAttribute(n)!==r}if(t.match(/^contains\(\s*@grammar\s*,\s*"[\w\d ]+"\s*\)$/)){const e=t.split('"')[1];return t=>!!nt.getInstance().getParameter(e)}if(t.match(/^not\(\s*contains\(\s*@grammar\s*,\s*"[\w\d ]+"\s*\)\s*\)$/)){const e=t.split('"')[1];return t=>!nt.getInstance().getParameter(e)}if(t.match(/^name\(\.\.\/\.\.\)="\w+"$/)){const e=t.split('"')[1].toUpperCase();return t=>{var n,r;return(null===(r=null===(n=t.parentNode)||void 0===n?void 0:n.parentNode)||void 0===r?void 0:r.tagName)&&B(t.parentNode.parentNode)===e}}if(t.match(/^count\(preceding-sibling::\*\)=\d+$/)){const e=t.split("="),n=parseInt(e[1],10);return t=>{var e;return(null===(e=t.parentNode)||void 0===e?void 0:e.childNodes[n])===t}}if(t.match(/^.+\[@category!?=".+"\]$/)){let[,e,n,r]=t.match(/^(.+)\[@category(!?=)"(.+)"\]$/);const s=r.match(/^unit:(.+)$/);let o="";return s&&(r=s[1],o=":unit"),t=>{const s=O(e,t)[0];if(s){const t=function(t){const e=An.get(t);return(null==e?void 0:e.base)?e.base.category:""}(s.textContent+o);return"="===n?t===r:t!==r}return!1}}if(t.match(/^string-length\(.+\)\W+\d+/)){const[,e,n,r]=t.match(/^string-length\((.+)\)(\W+)(\d+)/),s=Yi[n]||Yi["="],o=parseInt(r,10);return t=>{const n=O(e,t)[0];return!!n&&s(Array.from(n.textContent).length,o)}}return null}class Ki extends Vi{constructor(t,e){super(t,Xi(t)),this.context=e,this.kind=Ci.QUERY}applyTest(t){return this.test?this.test(t):this.context.applyQuery(t,this.constraint)===t}}class zi extends Vi{constructor(t,e){super(t,Xi(t)),this.context=e,this.kind=Ci.BOOLEAN}applyTest(t){return this.test?this.test(t):this.context.applyConstraint(t,this.constraint)}}class Ji{static collectRules_(t){const e=[];let n=[t];for(;n.length;){const t=n.shift();if(t.getKind()===Ci.QUERY||t.getKind()===Ci.BOOLEAN){const n=t.getRule();n&&e.unshift(n)}n=n.concat(t.getChildren())}return e}static printWithDepth_(t,e,n){n+=new Array(e+2).join(e.toString())+": "+t.toString()+"\n";const r=t.getChildren();for(let t,s=0;t=r[s];s++)n=Ji.printWithDepth_(t,e+1,n);return n}static order_(t){const e=t.getChildren();if(!e.length)return 0;const n=Math.max.apply(null,e.map(Ji.order_));return Math.max(e.length,n)}constructor(){this.root=Hi(Ci.ROOT,"",null)}addRule(t){let e=this.root;const n=t.context,r=t.dynamicCstr.getValues();for(let t=0,s=r.length;t<s;t++)e=this.addNode_(e,r[t],Ci.DYNAMIC,n);e=this.addNode_(e,t.precondition.query,Ci.QUERY,n);const s=t.precondition.constraints;for(let t=0,r=s.length;t<r;t++)e=this.addNode_(e,s[t],Ci.BOOLEAN,n);e.setRule(t)}lookupRules(t,e){let n=[this.root];const r=[];for(;e.length;){const t=e.shift(),r=[];for(;n.length;){n.shift().getChildren().forEach((e=>{e.getKind()===Ci.DYNAMIC&&-1===t.indexOf(e.getConstraint())||r.push(e)}))}n=r.slice()}for(;n.length;){const e=n.shift();if(e.getRule){const t=e.getRule();t&&r.push(t)}const s=e.findChildren(t);n=n.concat(s)}return r}hasSubtrie(t){let e=this.root;for(let n=0,r=t.length;n<r;n++){const r=t[n];if(e=e.getChild(r),!e)return!1}return!0}toString(){return Ji.printWithDepth_(this.root,0,"")}collectRules(t=this.root){return Ji.collectRules_(t)}order(){return Ji.order_(this.root)}enumerate(t){return this.enumerate_(this.root,t)}byConstraint(t){let e=this.root;for(;t.length&&e;){const n=t.shift();e=e.getChild(n)}return e||null}enumerate_(t,e){e=e||{};const n=t.getChildren();for(let t,r=0;t=n[r];r++)t.kind===Ci.DYNAMIC&&(e[t.getConstraint()]=this.enumerate_(t,e[t.getConstraint()]));return e}addNode_(t,e,n,r){let s=t.getChild(e);return s||(s=Hi(n,e,r),t.addChild(s)),s}}class Zi{static getInstance(){return Zi.instance=Zi.instance||new Zi,Zi.instance}static debugSpeechRule(t,e){const n=t.precondition,r=t.context.applyQuery(e,n.query);m.getInstance().output(n.query,r?r.toString():r),n.constraints.forEach((n=>m.getInstance().output(n,t.context.applyConstraint(e,n))))}static debugNamedSpeechRule(t,e){const n=Zi.getInstance().trie.collectRules().filter((e=>e.name==t));for(let r,s=0;r=n[s];s++)m.getInstance().output("Rule",t,"DynamicCstr:",r.dynamicCstr.toString(),"number",s),Zi.debugSpeechRule(r,e)}evaluateNode(t){M(t);const e=(new Date).getTime();let n=[];try{n=this.evaluateNode_(t)}catch(t){console.error("Something went wrong computing speech."),m.getInstance().output(t)}const r=(new Date).getTime();return m.getInstance().output("Time:",r-e),n}toString(){return this.trie.collectRules().map((t=>t.toString())).join("\n")}runInSetting(t,e){const n=E.getInstance(),r={};for(const[e,s]of Object.entries(t))r[e]=n[e],n[e]=s;n.setDynamicCstr();const s=e();for(const[t,e]of Object.entries(r))n[t]=e;return n.setDynamicCstr(),s}static addStore(t){const e=function(t){const e=`${t.locale}.${t.modality}.${t.domain}`;if("actions"===t.kind){const n=Qi.get(e);return n.parse(t),n}Ai(),t&&!t.functions&&(t.functions=function(t,e,n){return Fn.get([t,e,n].join("."))||Fn.get([c.DEFAULT_VALUES[r.LOCALE],e,n].join("."))||Fn.get([c.BASE_LOCALE,e,n].join("."))||{}}(t.locale,t.modality,t.domain));const n=function(t,e){if("braille"===e&&"euro"===t)return new $i;if("braille"===e)return new Gi;return new Bi}(t.locale,t.modality);Qi.set(e,n),t.inherits&&(n.inherits=Qi.get(`${t.inherits}.${t.modality}.${t.domain}`));return n.parse(t),n.initialize(),n}(t);"abstract"!==e.kind&&e.getSpeechRules().forEach((t=>Zi.getInstance().trie.addRule(t))),Zi.getInstance().addEvaluator(e)}processGrammar(t,e,n){const r={};for(const[s,o]of Object.entries(n))r[s]="string"==typeof o?t.constructString(e,o):o;nt.getInstance().pushState(r)}addEvaluator(t){const e=t.evaluateDefault.bind(t),n=this.evaluators_[t.locale];if(n)return void(n[t.modality]=e);const r={};r[t.modality]=e,this.evaluators_[t.locale]=r}getEvaluator(t,e){const n=this.evaluators_[t]||this.evaluators_[c.DEFAULT_VALUES[r.LOCALE]];return n[e]||n[c.DEFAULT_VALUES[r.MODALITY]]}enumerate(t){return this.trie.enumerate(t)}constructor(){this.trie=null,this.evaluators_={},this.trie=new Ji}evaluateNode_(t){return t?(this.updateConstraint_(),this.evaluateTree_(t)):[]}evaluateTree_(t){const e=E.getInstance();let n;m.getInstance().output(e.mode!==s.HTTP?t.toString():t),nt.getInstance().setAttribute(t);const r=this.lookupRule(t,e.dynamicCstr);if(!r)return e.strict?[]:(n=this.getEvaluator(e.locale,e.modality)(t),t.attributes&&this.addPersonality_(n,{},!1,t),n);m.getInstance().generateOutput((()=>["Apply Rule:",r.name,r.dynamicCstr.toString(),(e.mode,s.HTTP,t).toString()])),nt.getInstance().processSingles();const o=r.context,i=r.action.components;n=[];for(let e,r=0;e=i[r];r++){let r=[];const s=e.content||"",i=e.attributes||{};let c=!1;e.grammar&&this.processGrammar(o,t,e.grammar);let a=null;if(i.engine){a=E.getInstance().dynamicCstr.getComponents();const t=nt.parseInput(i.engine);E.getInstance().setDynamicCstr(t)}switch(e.type){case Ti.NODE:{const e=o.applyQuery(t,s);e&&(r=this.evaluateTree_(e))}break;case Ti.MULTI:{c=!0;const e=o.applySelector(t,s);e.length>0&&(r=this.evaluateNodeList_(o,e,i.sepFunc,o.constructString(t,i.separator),i.ctxtFunc,o.constructString(t,i.context)))}break;case Ti.TEXT:{const e=i.span;let n={};if(e){const r=O(e,t);n=r.length?Ln.getAttributes(r[0]):{kind:e}}r=o.constructSpan(t,s,n).map((function(t){return vn.create({text:t.speech,attributes:t.attributes},{adjust:!0})}))}break;case Ti.PERSONALITY:default:r=[vn.create({text:s})]}r[0]&&!c&&(i.context&&(r[0].context=o.constructString(t,i.context)+(r[0].context||"")),i.annotation&&(r[0].annotation=i.annotation)),this.addLayout(r,i,c),e.grammar&&nt.getInstance().popState(),n=n.concat(this.addPersonality_(r,i,c,t)),a&&E.getInstance().setDynamicCstr(a)}return nt.getInstance().popState(),n}evaluateNodeList_(t,e,n,r,s,o){if(!e.length)return[];const i=r||"",c=o||"",a=t.contextFunctions.lookup(s),l=a?a(e,c):function(){return c},u=t.contextFunctions.lookup(n),h=u?u(e,i):function(){return[vn.create({text:i},{translate:!0})]};let d=[];for(let t,n=0;t=e[n];n++){const r=this.evaluateTree_(t);if(r.length>0&&(r[0].context=l()+(r[0].context||""),d=d.concat(r),n<e.length-1)){const t=h();d=d.concat(t)}}return d}addLayout(t,e,n){const r=e.layout;r&&(r.match(/^begin/)?t.unshift(new vn({text:"",layout:r})):r.match(/^end/)?t.push(new vn({text:"",layout:r})):(t.unshift(new vn({text:"",layout:`begin${r}`})),t.push(new vn({text:"",layout:`end${r}`}))))}addPersonality_(t,e,n,r){const s={};let i=null;for(const t of u){const n=e[t];if(void 0===n)continue;const r=parseFloat(n),c=isNaN(r)?'"'===n.charAt(0)?n.slice(1,-1):n:r;t===o.PAUSE?i=c:s[t]=c}for(let e,n=0;e=t[n];n++)this.addRelativePersonality_(e,s),this.addExternalAttributes_(e,r);if(n&&t.length&&delete t[t.length-1].personality[o.JOIN],i&&t.length){const e=t[t.length-1];e.text||Object.keys(e.personality).length?t.push(vn.create({text:"",personality:{pause:i}})):e.personality[o.PAUSE]=i}return t}addExternalAttributes_(t,e){if(void 0===t.attributes.id&&(t.attributes.id=e.getAttribute("id")),e.hasAttributes()){const n=e.attributes;for(let e=n.length-1;e>=0;e--){const r=n[e].name;!t.attributes[r]&&r.match(/^ext/)&&(t.attributes[r]=n[e].value)}}}addRelativePersonality_(t,e){if(!t.personality)return t.personality=e,t;const n=t.personality;for(const[t,r]of Object.entries(e))n[t]&&"number"==typeof n[t]&&"number"==typeof r?n[t]=n[t]+r:n[t]||(n[t]=r);return t}updateConstraint_(){const t=E.getInstance().dynamicCstr,e=E.getInstance().strict,n=this.trie,s={};let o=t.getValue(r.LOCALE),i=t.getValue(r.MODALITY),a=t.getValue(r.DOMAIN);n.hasSubtrie([o,i,a])||(a=c.DEFAULT_VALUES[r.DOMAIN],n.hasSubtrie([o,i,a])||(i=c.DEFAULT_VALUES[r.MODALITY],n.hasSubtrie([o,i,a])||(o=c.DEFAULT_VALUES[r.LOCALE]))),s[r.LOCALE]=[o],s[r.MODALITY]=["summary"!==i?i:c.DEFAULT_VALUES[r.MODALITY]],s[r.DOMAIN]=["speech"!==i?c.DEFAULT_VALUES[r.DOMAIN]:a];const l=t.getOrder();for(let n,r=0;n=l[r];r++)if(!s[n]){const r=t.getValue(n),o=this.makeSet_(r,t.preference),i=c.DEFAULT_VALUES[n];e||r===i||o.push(i),s[n]=o}t.updateProperties(s)}makeSet_(t,e){return e&&Object.keys(e).length?t.split(":"):[t]}lookupRule(t,e){if(!t||t.nodeType!==L.ELEMENT_NODE&&t.nodeType!==L.TEXT_NODE)return null;const n=this.lookupRules(t,e);return n.length>0?this.pickMostConstraint_(e,n):null}lookupRules(t,e){return this.trie.lookupRules(t,e.allProperties())}pickMostConstraint_(t,e){const n=E.getInstance().comparator;return e.sort((function(t,e){return n.compare(t.dynamicCstr,e.dynamicCstr)||e.precondition.priority-t.precondition.priority||e.precondition.constraints.length-t.precondition.constraints.length||e.precondition.rank-t.precondition.rank})),m.getInstance().generateOutput((()=>e.map((t=>t.name+"("+t.dynamicCstr.toString()+")"))).bind(this)),e[0]}}const Qi=new Map;E.nodeEvaluator=Zi.getInstance().evaluateNode.bind(Zi.getInstance());const tc={small:["default"],capital:["default"],digit:["default"]};function ec(t){const e=E.getInstance().locale;E.getInstance().locale=t,Ue(),Nn({locale:t}),function(){const t=K.ALPHABETS,e=(t,e)=>{const n={};return Object.keys(t).forEach((t=>n[t]=!0)),Object.keys(e).forEach((t=>n[t]=!0)),Object.keys(n)};tc.small=e(t.smallPrefix,t.letterTrans),tc.capital=e(t.capPrefix,t.letterTrans),tc.digit=e(t.digitPrefix,t.digitTrans)}();for(const t of Qe.values()){const e=t.unicode;if("offset"in t)sc(e,t.font,t.offset||0);else{rc(e,K.ALPHABETS[t.base],t.font,!!t.capital)}}E.getInstance().locale=e,Ue()}function nc(t){return function(t){return"string"==typeof t?{font:t,combiner:K.ALPHABETS.combiner}:{font:t[0],combiner:K.COMBINERS[t[1]]||W[t[1]]||K.ALPHABETS.combiner}}("normal"===t||"fullwidth"===t?"":K.MESSAGES.font[t]||K.MESSAGES.embellish[t]||"")}function rc(t,e,n,r){const s=nc(n);for(let n,o,i=0;n=t[i],o=e[i];i++){const t=r?K.ALPHABETS.capPrefix:K.ALPHABETS.smallPrefix,e=r?tc.capital:tc.small;oc(s.combiner,n,o,s.font,t,K.ALPHABETS.letterTrans,e)}}function sc(t,e,n){const r=nc(e);for(let e,s=0;e=t[s];s++){const t=K.ALPHABETS.digitPrefix,o=s+n;oc(r.combiner,e,o,r.font,t,K.ALPHABETS.digitTrans,tc.digit)}}function oc(t,e,n,r,s,o,i){for(let c,a=0;c=i[a];a++){const i=c in o?o[c]:o.default,a=c in s?s[c]:s.default;In(c,"default",e,t(i(n),r,a))}}var ic=function(t,e,n,r){return new(n||(n=Promise))((function(s,o){function i(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((r=r.apply(t,e||[])).next())}))};const cc={functions:function(t){for(const n of t)Nn(n)||(e=n.key,hn(n.names||[],cn.Meaning.get(e)||{type:"function",role:"prefix function"}),"base"!==gn?(Cn(n),Mn(n)):yn.set(n.key,n));var e},symbols:function(t){for(const e of t){if(Nn(e))continue;const t=mn.parseUnicode(e.key);"base"!==gn?_n(t,t,e.mappings):yn.set(t,e)}},units:function(t){for(const e of t)Nn(e)||(e.key+=":unit","base"!==gn?(Cn(e),e.names&&(e.names=e.names.map((function(t){return t+":unit"}))),e.si&&Rn(e),Mn(e)):yn.set(e.key,e))},si:t=>t.forEach(bn),messages:function(t){const e=ke[t.locale];if(!e)return void console.error("Locale "+t.locale+" does not exist!");const n=t.kind.toUpperCase(),r=t.messages;if(!r)return;const s=e();for(const[t,e]of Object.entries(r))s[n][t]=e},rules:Zi.addStore,characters:t=>t.forEach(On)};let ac=!1;function lc(t=E.getInstance().locale){return ic(this,void 0,void 0,(function*(){return ac||(!function(){for(const t of Qe.values()){const e=t.unicode;for(const n of e)yn.set(n,{key:n,category:t.category})}}(),uc(c.BASE_LOCALE),ac=!0),b.promises[c.BASE_LOCALE].then((()=>ic(this,void 0,void 0,(function*(){const e=E.getInstance().defaultLocale;return e?(uc(e),b.promises[e].then((()=>ic(this,void 0,void 0,(function*(){return uc(t),b.promises[t]}))))):(uc(t),b.promises[t])}))))}))}function uc(t=E.getInstance().locale){b.loaded[t]||(b.loaded[t]=[!1,!1],gn=c.DEFAULT_VALUES[r.LOCALE],Sn=c.DEFAULT_VALUES[r.MODALITY],function(t){if(E.getInstance().isIE&&E.getInstance().mode===s.HTTP)return void fc(t);!function(t){const e=function(){if(E.getInstance().customLoader)return E.getInstance().customLoader;return hc()}(),n=new Promise((n=>{e(t).then((e=>{var r;r=e,dc(JSON.parse(r)),b.loaded[t]=[!0,!0],n(t)}),(e=>{b.loaded[t]=[!0,!1],console.error(`Unable to load locale: ${t}`),E.getInstance().locale=E.getInstance().defaultLocale,n(t)}))}));b.promises[t]=n}(t)}(t))}function hc(){switch(E.getInstance().mode){case s.ASYNC:return pc;case s.HTTP:return gc;case s.SYNC:default:return mc}}function dc(t,e){let n=!0;for(let r,s=0;r=Object.keys(t)[s];s++){const s=r.split("/");e&&e!==s[0]||(n&&"symbols"===s[1]&&"base"!==s[0]&&(ec(s[0]),n=!1),cc[s[1]](t[r]))}}function fc(t,e){let n=e||1;Ge?dc(Ge,t):n<=5&&setTimeout((()=>fc(t,n++)).bind(this),300)}function pc(t){const e=We(t);return new Promise(((t,n)=>{p.Z.fs.readFile(e,"utf8",((e,r)=>{if(e)return n(e);t(r)}))}))}function mc(t){const e=We(t);return new Promise(((t,n)=>{let r="{}";try{r=p.Z.fs.readFileSync(e,"utf8")}catch(t){return n(t)}t(r)}))}function gc(t){const e=We(t),n=new XMLHttpRequest;return new Promise(((t,r)=>{n.onreadystatechange=function(){if(4===n.readyState){const e=n.status;0===e||e>=200&&e<400?t(n.responseText):r(e)}},n.open("GET",e,!0),n.send()}))}var Sc,Nc=function(t,e,n,r){return new(n||(n=Promise))((function(s,o){function i(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((r=r.apply(t,e||[])).next())}))};function Ec(t){return Nc(this,void 0,void 0,(function*(){const e=E.getInstance();"default"!==t.domain||"speech"!==t.modality&&t.modality&&"speech"!==e.modality||(t.domain="mathspeak");const n=n=>{void 0!==t[n]&&(e[n]=t[n])};return n("mode"),e.configurate(t),E.BINARY_FEATURES.forEach((n=>{void 0!==t[n]&&(e[n]=!!t[n])})),E.STRING_FEATURES.forEach(n),t.debug&&m.getInstance().init(),t.json&&(p.Z.jsonPath=He(t.json)),t.xpath&&(p.Z.WGXpath=t.xpath),e.setCustomLoader(t.custom),function(t){t.isIE=Be(),t.isEdge="undefined"!=typeof window&&"MSGestureEvent"in window&&null===(null===(e=window.chrome)||void 0===e?void 0:e.loadTimes)&&(document.evaluate=null,$e(!0),!0);var e}(e),Ue(),e.setDynamicCstr(),e.init?(b.promises.init=new Promise(((t,e)=>{setTimeout((()=>{t("init")}),10)})),e.init=!1,b.get()):e.delay?(e.delay=!1,b.get()):lc()}))}!function(t){t[t.ENTER=13]="ENTER",t[t.ESC=27]="ESC",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.LEFT=37]="LEFT",t[t.UP=38]="UP",t[t.RIGHT=39]="RIGHT",t[t.DOWN=40]="DOWN",t[t.TAB=9]="TAB",t[t.LESS=188]="LESS",t[t.GREATER=190]="GREATER",t[t.DASH=189]="DASH",t[t.ZERO=48]="ZERO",t[t.ONE=49]="ONE",t[t.TWO=50]="TWO",t[t.THREE=51]="THREE",t[t.FOUR=52]="FOUR",t[t.FIVE=53]="FIVE",t[t.SIX=54]="SIX",t[t.SEVEN=55]="SEVEN",t[t.EIGHT=56]="EIGHT",t[t.NINE=57]="NINE",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z"}(Sc||(Sc={}));const bc=new Map([[13,"ENTER"],[27,"ESC"],[32,"SPACE"],[33,"PAGE_UP"],[34,"PAGE_DOWN"],[35,"END"],[36,"HOME"],[37,"LEFT"],[38,"UP"],[39,"RIGHT"],[40,"DOWN"],[9,"TAB"],[188,"LESS"],[190,"GREATER"],[189,"DASH"],[48,"ZERO"],[49,"ONE"],[50,"TWO"],[51,"THREE"],[52,"FOUR"],[53,"FIVE"],[54,"SIX"],[55,"SEVEN"],[56,"EIGHT"],[57,"NINE"],[65,"A"],[66,"B"],[67,"C"],[68,"D"],[69,"E"],[70,"F"],[71,"G"],[72,"H"],[73,"I"],[74,"J"],[75,"K"],[76,"L"],[77,"M"],[78,"N"],[79,"O"],[80,"P"],[81,"Q"],[82,"R"],[83,"S"],[84,"T"],[85,"U"],[86,"V"],[87,"W"],[88,"X"],[89,"Y"],[90,"Z"]]);var Ac;!function(t){t.CLICK="click",t.DBLCLICK="dblclick",t.MOUSEDOWN="mousedown",t.MOUSEUP="mouseup",t.MOUSEOVER="mouseover",t.MOUSEOUT="mouseout",t.MOUSEMOVE="mousemove",t.SELECTSTART="selectstart",t.KEYPRESS="keypress",t.KEYDOWN="keydown",t.KEYUP="keyup",t.TOUCHSTART="touchstart",t.TOUCHMOVE="touchmove",t.TOUCHEND="touchend",t.TOUCHCANCEL="touchcancel"}(Ac||(Ac={}));function yc(t,e,n){return(n||function(n,r){return"number"==typeof n&&"number"==typeof r?n+r:"number"==typeof n?r:"number"==typeof r?n:[t,e].sort()[0]}).call(null,t,e)}function Tc(t,e){delete t.open,e.close.forEach((e=>delete t[e])),e.open.forEach((n=>t[n]=e[n]));const n=Object.keys(t);t.open=n}function Cc(t,e){if(t.length<=1)return t;const n=[];for(let r,s=0;r=e[s],t.length;s++)r.close&&r.close.length&&r.close.forEach((function(e){const r=t.indexOf(e);-1!==r&&(n.unshift(e),t.splice(r,1))}));return n}let _c={},Ic=[];function Oc(t){_c={},Ic=[];let e=[];const n={};for(let r,s=0;r=t[s];s++){let t=null;const s=r.descriptionSpan(),i=r.personality,c=i[o.JOIN];delete i[o.JOIN],void 0!==i[o.PAUSE]&&(t={[o.PAUSE]:i[o.PAUSE]},delete i[o.PAUSE]);Fc(e,s,wc(i,n),c,t,!0)}return e=e.concat(function(){const t=[];for(let e=Ic.length-1;e>=0;e--){const n=Ic[e];if(n.length){const e={open:[],close:[]};for(let t=0;t<n.length;t++){const r=n[t];e.close.push(r),e[r]=0}t.push(e)}}return t}()),e=function(t){const e={},n=[];for(let r,s=0;r=t[s];s++){if(!xc(r)){Mc(n,r);continue}if(!r.close||1!==r.close.length||r.open.length){Rc(r,e),n.push(r);continue}let o=t[s+1];if(!o||vc(o)){Rc(r,e),n.push(r);continue}const i=Lc(o)?o:null;i&&(o=t[s+2]),o&&xc(o)&&o.open[0]===r.close[0]&&!o.close.length&&o[o.open[0]]===e[o.open[0]]?i?(Mc(n,i),s+=2):s+=1:(Rc(r,e),n.push(r))}return n}(e),e=E.getInstance().cleanpause?function(t){for(;Lc(t[0]);)t.shift();for(;Lc(t[t.length-1]);)t.pop();return t}(e):e,e}function Mc(t,e){const n=t[t.length-1];if(n){if(vc(e)&&vc(n)){if(void 0===n.join)return void(n.span=n.span.concat(e.span));const t=n.span.pop(),r=e.span.shift();return n.span.push(t+n.join+r),n.span=n.span.concat(e.span),void(n.join=e.join)}Lc(e)&&Lc(n)?n.pause=yc(n.pause,e.pause):t.push(e)}else t.push(e)}function Rc(t,e){t.rate&&(e.rate=t.rate),t.pitch&&(e.pitch=t.pitch),t.volume&&(e.volume=t.volume)}function xc(t){return"object"==typeof t&&t.open}function Lc(t){return"object"==typeof t&&1===Object.keys(t).length&&Object.keys(t)[0]===o.PAUSE}function vc(t){const e=Object.keys(t);return"object"==typeof t&&(1===e.length&&"span"===e[0]||2===e.length&&("span"===e[0]&&"join"===e[1]||"span"===e[1]&&"join"===e[0]))}function Fc(t,e,n,r,s,i=!1){if(i){const i=t[t.length-1];let c;if(i&&(c=i[o.JOIN]),i&&!e.speech&&s&&Lc(i)){const t=o.PAUSE;i[t]=yc(i[t],s[t]),s=null}if(i&&e.speech&&0===Object.keys(n).length&&vc(i)){if(void 0!==c){const t=i.span.pop();e=Ln.stringAttr(t.speech+c+e.speech,t.attributes)}i.span.push(e),e=Ln.empty(),i[o.JOIN]=r}}0!==Object.keys(n).length&&t.push(n),e.speech&&t.push({span:[e],join:r}),s&&t.push(s)}function wc(t,e){if(!e)return t;const n={};for(const r of u){const s=t[r],o=e[r];if(!s&&!o||s&&o&&s===o)continue;const i=s||0;xc(n)||(n.open=[],n.close=[]),s||n.close.push(r),o||n.open.push(r),o&&s&&(n.close.push(r),n.open.push(r)),e[r]=i,n[r]=i,_c[r]?_c[r].push(i):_c[r]=[i]}if(xc(n)){let t=n.close.slice();for(;t.length>0;){let r=Ic.pop();const s=hr(r,t);if(t=hr(t,r),r=s,0!==t.length){if(0!==r.length){n.close=n.close.concat(r),n.open=n.open.concat(r);for(let t,s=0;t=r[s];s++)n[t]=e[t]}}else 0!==r.length&&Ic.push(r)}Ic.push(n.open)}return n}class Dc{constructor(){this.separator_=" "}set separator(t){this.separator_=t}get separator(){return"braille"===E.getInstance().modality?"":this.separator_}error(t){return null}merge(t){let e="";const n=t.length-1;for(let r,s=0;r=t[s];s++)if(e+=r.speech,s<n){const t=r.attributes.separator;e+=void 0!==t?t:this.separator}return e}finalize(t){return t}pauseValue(t){let e;switch(t){case"long":e=750;break;case"medium":e=500;break;case"short":e=250;break;default:e=parseInt(t,10)}return Math.floor(e*E.getInstance().getRate()/100)}}class Pc extends Dc{constructor(){super(...arguments),this.ignoreElements=[o.LAYOUT],this.scaleFunction=null}setScaleFunction(t,e,n,r,s=0){this.scaleFunction=o=>{const i=(o-t)/(e-t),c=n*(1-i)+r*i;return+(Math.round(c+"e+"+s)+"e-"+s)}}applyScaleFunction(t){return this.scaleFunction?this.scaleFunction(t):t}ignoreElement(t){return-1!==this.ignoreElements.indexOf(t)}}class kc extends Pc{markup(t){this.setScaleFunction(-2,2,-100,100,2);const e=Oc(t),n=[],r=[];for(let t,s=0;t=e[s];s++)if(t.span)n.push(this.merge(t.span));else if(Lc(t))n.push(this.pause(t));else{if(t.close.length)for(let e=0;e<t.close.length;e++){const e=r.pop();if(-1===t.close.indexOf(e))throw new S("Unknown closing markup element: "+e);n.push(this.closeTag(e))}if(t.open.length){Cc(t.open.slice(),e.slice(s+1)).forEach((e=>{n.push(this.prosodyElement(e,t[e])),r.push(e)}))}}return n.join(" ")}}let Uc="";const Bc={TABLE:function(t){let e=qc(t);e.forEach((t=>{t.cells=t.cells.slice(1).slice(0,-1),t.width=t.width.slice(1).slice(0,-1)}));const[n,r]=Yc(e);return e=Xc(e,r),Kc(e,n)},CASES:function(t){let e=qc(t);e.forEach((t=>{t.cells=t.cells.slice(0,-1),t.width=t.width.slice(0,-1)}));const[n,r]=Yc(e);return e=Xc(e,r),Kc(e,n)},CAYLEY:function(t){let e=qc(t);e.forEach((t=>{t.cells=t.cells.slice(1).slice(0,-1),t.width=t.width.slice(1).slice(0,-1),t.sep=t.sep+t.sep}));const[n,r]=Yc(e),s={lfence:"",rfence:"",cells:r.map((t=>"\u2810"+new Array(t).join("\u2812"))),width:r,height:1,sep:e[0].sep};return e.splice(1,0,s),e=Xc(e,r),Kc(e,n)},MATRIX:function(t){let e=qc(t);const[n,r]=Yc(e);return e=Xc(e,r),Kc(e,n)},CELL:jc,FENCE:jc,ROW:jc,FRACTION:function(t){const[e,n,,r,s]=Array.from(t.childNodes),o=Gc(n),i=Gc(r),c=Hc(o),a=Hc(i);let l=Math.max(c,a);const u=e+new Array(l+1).join("\u2812")+s;return l=u.length,`${Qc(o,l)}\n${u}\n${Qc(i,l)}`},NUMERATOR:ta,DENOMINATOR:ta};function Gc(t){const e=B(t),n=Bc[e];return n?n(t):t.textContent}function $c(t,e){if(!t||!e)return t+e;const n=Vc(t),r=Vc(e),s=n-r;t=s<0?Wc(t,r,Hc(t)):t,e=s>0?Wc(e,n,Hc(e)):e;const o=t.split(/\r\n|\r|\n/),i=e.split(/\r\n|\r|\n/),c=[];for(let t=0;t<o.length;t++)c.push(o[t]+i[t]);return c.join("\n")}function jc(t){let e="";for(const n of Array.from(t.childNodes))e=n.nodeType!==L.TEXT_NODE?$c(e,Gc(n)):$c(e,n.textContent);return e}function Vc(t){return t.split(/\r\n|\r|\n/).length}function Hc(t){return t.split(/\r\n|\r|\n/).reduce(((t,e)=>Math.max(e.length,t)),0)}function Wc(t,e,n){return t=function(t,e){const n=e-Vc(t);return t+(n>0?new Array(n+1).join("\n"):"")}(t,e),function(t,e){const n=t.split(/\r\n|\r|\n/),r=[];for(const t of n){const n=e-t.length;r.push(t+(n>0?new Array(n+1).join("\u2800"):""))}return r.join("\n")}(t,n)}function qc(t){const e=Array.from(t.childNodes),n=[];for(const t of e)t.nodeType===L.ELEMENT_NODE&&n.push(Zc(t));return n}function Yc(t){const e=t.reduce(((t,e)=>Math.max(e.height,t)),0),n=[];for(let e=0;e<t[0].width.length;e++)n.push(t.map((t=>t.width[e])).reduce(((t,e)=>Math.max(t,e)),0));return[e,n]}function Xc(t,e){const n=[];for(const r of t){if(0===r.height)continue;const t=[];for(let n=0;n<r.cells.length;n++)t.push(Wc(r.cells[n],r.height,e[n]));r.cells=t,n.push(r)}return n}function Kc(t,e){if(1===e)return t.map((t=>t.lfence+t.cells.join(t.sep)+t.rfence)).join("\n");const n=[];for(const e of t){const t=zc(e.sep,e.height);let r=e.cells.shift();for(;e.cells.length;)r=$c(r,t),r=$c(r,e.cells.shift());r=$c(zc(e.lfence,e.height),r),r=$c(r,zc(e.rfence,e.height)),n.push(r),n.push(e.lfence+new Array(Hc(r)-3).join(e.sep)+e.rfence)}return n.slice(0,-1).join("\n")}function zc(t,e){let n="";for(;e;)n+=t+"\n",e--;return n.slice(0,-1)}function Jc(t){return t.nodeType===L.ELEMENT_NODE&&"FENCE"===B(t)?Gc(t):""}function Zc(t){const e=Array.from(t.childNodes),n=Jc(e[0]),r=Jc(e[e.length-1]);n&&e.shift(),r&&e.pop();let s="";const o=[];for(const t of e){if(t.nodeType===L.TEXT_NODE){s=t.textContent;continue}const e=Gc(t);o.push(e)}return{lfence:n,rfence:r,sep:s,cells:o,height:o.reduce(((t,e)=>Math.max(Vc(e),t)),0),width:o.map(Hc)}}function Qc(t,e){const n=(e-Hc(t))/2,[r,s]=Math.floor(n)===n?[n,n]:[Math.floor(n),Math.ceil(n)],o=t.split(/\r\n|\r|\n/),i=[],[c,a]=[new Array(r+1).join("\u2800"),new Array(s+1).join("\u2800")];for(const t of o)i.push(c+t+a);return i.join("\n")}function ta(t){const e=t.firstChild,n=jc(t);if(e&&e.nodeType===L.ELEMENT_NODE){if("ENGLISH"===B(e))return"\u2830"+n;if("NUMBER"===B(e))return"\u283c"+n}return n}class ea extends Dc{markup(t){const e=Oc(t);let n="",r=null,s=!1;for(let t,i=0;t=e[i];i++)xc(t)||(Lc(t)?r=t:(r&&(n+=this.pause(r[o.PAUSE]),r=null),n+=(s?this.separator:"")+this.merge(t.span),s=!0));return n}pause(t){let e;return e="number"==typeof t?t<=250?"short":t<=500?"medium":"long":t,ea.PAUSE_PUNCTUATION.get(e)||""}}ea.PAUSE_PUNCTUATION=new Map([["short",","],["medium",";"],["long","."]]);class na extends kc{finalize(t){return`<?xml version="1.0"?><speak version="1.1" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="${E.getInstance().locale}"><prosody rate="`+E.getInstance().getRate()+'%">'+this.separator+t+this.separator+"</prosody></speak>"}pause(t){return'<break time="'+this.pauseValue(t[o.PAUSE])+'ms"/>'}prosodyElement(t,e){const n=(e=Math.floor(this.applyScaleFunction(e)))<0?e.toString():"+"+e.toString();return"<prosody "+t.toLowerCase()+'="'+n+(t===o.VOLUME?">":'%">')}closeTag(t){return"</prosody>"}markup(t){return na.MARKS={},super.markup(t)}merge(t){const e=[];let n="";for(let r=0;r<t.length;r++){const s=t[r];if(this.isEmptySpan(s))continue;const o=na.MARK_KIND?s.attributes.kind:"",i=E.getInstance().automark?s.attributes.id:E.getInstance().mark?s.attributes.extid:"";!i||i===n||na.MARK_ONCE&&na.MARKS[i]||(e.push(o?`<mark name="${i}" kind="${o}"/>`:`<mark name="${i}"/>`),n=i,na.MARKS[i]=!0),E.getInstance().character&&1===s.speech.length&&s.speech.match(/[a-zA-Z]/)?e.push('<say-as interpret-as="'+na.CHARACTER_ATTR+'">'+s.speech+"</say-as>"):e.push(s.speech)}return e.join(this.separator)}isEmptySpan(t){const e=t.attributes.separator;return t.speech.match(/^\s*$/)&&(!e||e.match(/^\s*$/))}}na.MARK_ONCE=!1,na.MARK_KIND=!0,na.CHARACTER_ATTR="character",na.MARKS={};const ra=new na,sa=new Map([[d.NONE,new class extends Dc{markup(t){let e="";const n=Oc(t).filter((t=>t.span));if(!n.length)return e;const r=n.length-1;for(let t,s=0;t=n[s];s++){if(t.span&&(e+=this.merge(t.span)),s>=r)continue;const n=t.join;e+=void 0===n?this.separator:n}return e}}],[d.PUNCTUATION,new ea],[d.LAYOUT,new class extends kc{finalize(t){return function(t){Uc="";const e=x(`<all>${t}</all>`);return m.getInstance().output(D(e.toString())),Uc=jc(e),Uc}(t)}pause(t){return""}prosodyElement(t,e){return t===o.LAYOUT?`<${e}>`:""}closeTag(t){return`</${t}>`}markup(t){const e=[];let n=[];for(const r of t){if(!r.layout){n.push(r);continue}e.push(this.processContent(n)),n=[];const t=r.layout;t.match(/^begin/)?e.push("<"+t.replace(/^begin/,"")+">"):t.match(/^end/)?e.push("</"+t.replace(/^end/,"")+">"):console.warn("Something went wrong with layout markup: "+t)}return e.push(this.processContent(n)),e.join("")}processContent(t){const e=[],n=Oc(t);for(let t,r=0;t=n[r];r++)t.span?e.push(this.merge(t.span)):Lc(t);return e.join("")}}],[d.ACSS,new class extends Pc{markup(t){this.setScaleFunction(-2,2,0,10,0);const e=Oc(t),n=[],r={open:[]};let s=null,o=!1;for(let t,l=0;t=e[l];l++){if(xc(t)){Tc(r,t);continue}if(Lc(t)){o&&(i=s,c=t,a=Math.max,s=i?{pause:yc(i.pause,c.pause,a)}:c);continue}const e='"'+this.merge(t.span)+'"';o=!0,s&&(n.push(this.pause(s)),s=null);const l=this.prosody_(r);n.push(l?"(text ("+l+") "+e+")":e)}var i,c,a;return"(exp "+n.join(" ")+")"}error(t){return'(error "'+bc.get(t)+'")'}prosodyElement(t,e){switch(e=this.applyScaleFunction(e),t){case o.RATE:return"(richness . "+e+")";case o.PITCH:return"(average-pitch . "+e+")";case o.VOLUME:return"(stress . "+e+")"}return"(value . "+e+")"}pause(t){return"(pause . "+this.pauseValue(t[o.PAUSE])+")"}prosody_(t){const e=t.open,n=[];for(let r,s=0;r=e[s];s++)n.push(this.prosodyElement(r,t[r]));return n.join(" ")}}],[d.SABLE,new class extends kc{finalize(t){return'<?xml version="1.0"?><!DOCTYPE SABLE PUBLIC "-//SABLE//DTD SABLE speech mark up//EN" "Sable.v0_2.dtd" []><SABLE>'+this.separator+t+this.separator+"</SABLE>"}pause(t){return'<BREAK MSEC="'+this.pauseValue(t[o.PAUSE])+'"/>'}prosodyElement(t,e){switch(e=this.applyScaleFunction(e),t){case o.PITCH:return'<PITCH RANGE="'+e+'%">';case o.RATE:return'<RATE SPEED="'+e+'%">';case o.VOLUME:return'<VOLUME LEVEL="'+e+'%">';default:return"<"+t.toUpperCase()+' VALUE="'+e+'">'}}closeTag(t){return"</"+t.toUpperCase()+">"}}],[d.VOICEXML,ra],[d.SSML,ra]]);function oa(t){const e=sa.get(E.getInstance().markup);return e?e.markup(t):""}function ia(t){const e=sa.get(E.getInstance().markup);return e?e.finalize(t):t}class ca{constructor(t){this.type=t,this.factory_=new jr}getFactory(){return this.factory_}setFactory(t){this.factory_=t}getType(){return this.type}parseList(t){const e=[];for(let n,r=0;n=t[r];r++)e.push(this.parse(n));return e}}class aa extends ca{static getAttribute_(t,e,n){if(!t.hasAttribute(e))return n;const r=t.getAttribute(e);return r.match(/^\s*$/)?null:r}constructor(){super("MathML"),this.parseMap_={SEMANTICS:this.semantics_.bind(this),MATH:this.rows_.bind(this),MROW:this.rows_.bind(this),MPADDED:this.rows_.bind(this),MSTYLE:this.rows_.bind(this),MFRAC:this.fraction_.bind(this),MSUB:this.limits_.bind(this),MSUP:this.limits_.bind(this),MSUBSUP:this.limits_.bind(this),MOVER:this.limits_.bind(this),MUNDER:this.limits_.bind(this),MUNDEROVER:this.limits_.bind(this),MROOT:this.root_.bind(this),MSQRT:this.sqrt_.bind(this),MTABLE:this.table_.bind(this),MLABELEDTR:this.tableLabeledRow_.bind(this),MTR:this.tableRow_.bind(this),MTD:this.tableCell_.bind(this),MS:this.text_.bind(this),MTEXT:this.text_.bind(this),MSPACE:this.space_.bind(this),"ANNOTATION-XML":this.text_.bind(this),MI:this.identifier_.bind(this),MN:this.number_.bind(this),MO:this.operator_.bind(this),MFENCED:this.fenced_.bind(this),MENCLOSE:this.enclosed_.bind(this),MMULTISCRIPTS:this.multiscripts_.bind(this),ANNOTATION:this.empty_.bind(this),NONE:this.empty_.bind(this),MACTION:this.action_.bind(this)};const t={type:"identifier",role:"numbersetletter",font:nn.DOUBLESTRUCK};["C","H","N","P","Q","R","Z","\u2102","\u210d","\u2115","\u2119","\u211a","\u211d","\u2124"].forEach((e=>this.getFactory().defaultMap.set(e,t)).bind(this))}parse(t){Is.getInstance().setNodeFactory(this.getFactory());const e=R(t.childNodes),n=B(t),r=this.parseMap_[n],s=(r||this.dummy_.bind(this))(t,e);return kr(s,t),-1!==["MATH","MROW","MPADDED","MSTYLE","SEMANTICS","MACTION"].indexOf(n)||(s.mathml.unshift(t),s.mathmlTree=t),s}semantics_(t,e){return e.length?this.parse(e[0]):this.getFactory().makeEmptyNode()}rows_(t,e){const n=t.getAttribute("semantics");if(n&&n.match("bspr_"))return Is.proof(t,n,this.parseList.bind(this));let r;return 1===(e=Pr(e)).length?(r=this.parse(e[0]),"empty"!==r.type||r.mathmlTree||(r.mathmlTree=t)):r=Is.getInstance().row(this.parseList(e)),r.mathml.unshift(t),r}fraction_(t,e){if(!e.length)return this.getFactory().makeEmptyNode();const n=this.parse(e[0]),r=e[1]?this.parse(e[1]):this.getFactory().makeEmptyNode();return Is.getInstance().fractionLikeNode(n,r,t.getAttribute("linethickness"),"true"===t.getAttribute("bevelled"))}limits_(t,e){return Is.getInstance().limitNode(B(t),this.parseList(e))}root_(t,e){return e[1]?this.getFactory().makeBranchNode("root",[this.parse(e[1]),this.parse(e[0])],[]):this.sqrt_(t,e)}sqrt_(t,e){const n=this.parseList(Pr(e));return this.getFactory().makeBranchNode("sqrt",[Is.getInstance().row(n)],[])}table_(t,e){const n=t.getAttribute("semantics");if(n&&n.match("bspr_"))return Is.proof(t,n,this.parseList.bind(this));const r=this.getFactory().makeBranchNode("table",this.parseList(e),[]);return r.mathmlTree=t,Is.tableToMultiline(r)}tableRow_(t,e){const n=this.getFactory().makeBranchNode("row",this.parseList(e),[]);return n.role="table",n}tableLabeledRow_(t,e){if(!e.length)return this.tableRow_(t,e);const n=this.parse(e[0]);n.role="label";const r=this.getFactory().makeBranchNode("row",this.parseList(e.slice(1)),[n]);return r.role="table",r}tableCell_(t,e){const n=this.parseList(Pr(e));let r;r=n.length?1===n.length&&Vr(n[0],"empty")?n:[Is.getInstance().row(n)]:[];const s=this.getFactory().makeBranchNode("cell",r,[]);return s.role="table",s}space_(t,e){const n=t.getAttribute("width"),r=n&&n.match(/[a-z]*$/);if(!r)return this.empty_(t,e);const s=r[0],o=parseFloat(n.slice(0,r.index)),i={cm:.4,pc:.5,em:.5,ex:1,in:.15,pt:5,mm:5}[s];if(!i||isNaN(o)||o<i)return this.empty_(t,e);const c=this.getFactory().makeUnprocessed(t);return Is.getInstance().text(c,B(t))}text_(t,e){const n=this.leaf_(t,e);return t.textContent?(n.updateContent(t.textContent,!0),Is.getInstance().text(n,B(t))):n}identifier_(t,e){const n=this.leaf_(t,e);return Is.getInstance().identifierNode(n,Is.getInstance().font(t.getAttribute("mathvariant")),t.getAttribute("class"))}number_(t,e){const n=this.leaf_(t,e);return Is.number(n),n}operator_(t,e){const n=this.leaf_(t,e);return Is.getInstance().operatorNode(n),n}fenced_(t,e){const n=this.parseList(Pr(e)),r=aa.getAttribute_(t,"separators",","),s=aa.getAttribute_(t,"open","("),o=aa.getAttribute_(t,"close",")"),i=Is.getInstance().mfenced(s,o,r,n);return Is.getInstance().tablesInRow([i])[0]}enclosed_(t,e){const n=this.parseList(Pr(e)),r=this.getFactory().makeBranchNode("enclose",[Is.getInstance().row(n)],[]);return r.role=t.getAttribute("notation")||"unknown",r}multiscripts_(t,e){if(!e.length)return this.getFactory().makeEmptyNode();const n=this.parse(e.shift());if(!e.length)return n;const r=[],s=[],o=[],i=[];let c=!1,a=0;for(let t,n=0;t=e[n];n++)"MPRESCRIPTS"!==B(t)?(c?1&a?r.push(t):s.push(t):1&a?o.push(t):i.push(t),a++):(c=!0,a=0);return Pr(r).length||Pr(s).length?Is.getInstance().tensor(n,this.parseList(s),this.parseList(r),this.parseList(i),this.parseList(o)):Is.getInstance().pseudoTensor(n,this.parseList(i),this.parseList(o))}empty_(t,e){return this.getFactory().makeEmptyNode()}action_(t,e){const n=e[t.hasAttribute("selection")?parseInt(t.getAttribute("selection"),10)-1:0],r=this.parse(n);return r.mathmlTree=n,r}dummy_(t,e){const n=this.getFactory().makeUnprocessed(t);return n.role=t.tagName,n.textContent=t.textContent,n}leaf_(t,e){if(1===e.length&&e[0].nodeType!==L.TEXT_NODE){const n=this.getFactory().makeUnprocessed(t);return n.role=e[0].tagName,kr(n,e[0]),n}return this.getFactory().makeLeafNode(t.textContent,Is.getInstance().font(t.getAttribute("mathvariant")))}}class la{constructor(t,e,n=(t=>!1)){this.name=t,this.apply=e,this.applicable=n}}class ua extends la{}class ha extends la{}const da="data-semantic-";var fa;!function(t){t.ADDED="data-semantic-added",t.ALTERNATIVE="data-semantic-alternative",t.CHILDREN="data-semantic-children",t.COLLAPSED="data-semantic-collapsed",t.CONTENT="data-semantic-content",t.EMBELLISHED="data-semantic-embellished",t.FENCEPOINTER="data-semantic-fencepointer",t.FONT="data-semantic-font",t.ID="data-semantic-id",t.ANNOTATION="data-semantic-annotation",t.ATTRIBUTES="data-semantic-attributes",t.OPERATOR="data-semantic-operator",t.OWNS="data-semantic-owns",t.PARENT="data-semantic-parent",t.POSTFIX="data-semantic-postfix",t.PREFIX="data-semantic-prefix",t.ROLE="data-semantic-role",t.SPEECH="data-semantic-speech",t.STRUCTURE="data-semantic-structure",t.TYPE="data-semantic-type"}(fa||(fa={}));const pa=[fa.ADDED,fa.ALTERNATIVE,fa.CHILDREN,fa.COLLAPSED,fa.CONTENT,fa.EMBELLISHED,fa.FENCEPOINTER,fa.FONT,fa.ID,fa.ANNOTATION,fa.ATTRIBUTES,fa.OPERATOR,fa.OWNS,fa.PARENT,fa.POSTFIX,fa.PREFIX,fa.ROLE,fa.SPEECH,fa.STRUCTURE,fa.TYPE];function ma(t){return t.map((function(t){return t.id})).join(",")}function ga(t,e){t.setAttribute(fa.TYPE,e.type);const n=e.allAttributes();for(let e,r=0;e=n[r];r++)t.setAttribute(da+e[0].toLowerCase(),e[1]);e.childNodes.length&&t.setAttribute(fa.CHILDREN,ma(e.childNodes)),e.contentNodes.length&&t.setAttribute(fa.CONTENT,ma(e.contentNodes)),e.parent&&t.setAttribute(fa.PARENT,e.parent.id.toString());const r=e.attributesXml();r&&t.setAttribute(fa.ATTRIBUTES,r),function(t,e){const n=[];"mglyph"===e.role&&n.push("image");e.attributes.href&&n.push("link");n.length&&t.setAttribute(fa.POSTFIX,n.join(" "))}(t,e)}function Sa(t){return da+t}function Na(){const t=F("mrow");return t.setAttribute(fa.ADDED,"true"),t}class Ea{static fromTree(t){return Ea.fromNode(t.root)}static fromNode(t){return new Ea(Ea.fromNode_(t))}static fromString(t){return new Ea(Ea.fromString_(t))}static simpleCollapseStructure(t){return"number"==typeof t}static contentCollapseStructure(t){return!!t&&!Ea.simpleCollapseStructure(t)&&"c"===t[0]}static interleaveIds(t,e){return ur(Ea.collapsedLeafs(t),Ea.collapsedLeafs(e))}static collapsedLeafs(...t){return t.reduce(((t,e)=>{return t.concat((n=e,Ea.simpleCollapseStructure(n)?[n]:Ea.contentCollapseStructure(n[1])?n.slice(2):n.slice(1)));var n}),[])}static fromStructure(t,e){return new Ea(Ea.tree_(t,e.root))}static combineContentChildren(t,e,n){switch(t.type){case"relseq":case"infixop":case"multirel":return ur(n,e);case"prefixop":return e.concat(n);case"postfixop":return n.concat(e);case"fenced":return n.unshift(e[0]),n.push(e[1]),n;case"appl":return[n[0],e[0],n[1]];case"root":return[n[1],n[0]];case"row":case"line":return e.length&&n.unshift(e[0]),n;default:return n}}static makeSexp_(t){return Ea.simpleCollapseStructure(t)?t.toString():Ea.contentCollapseStructure(t)?"(c "+t.slice(1).map(Ea.makeSexp_).join(" ")+")":"("+t.map(Ea.makeSexp_).join(" ")+")"}static fromString_(t){let e=t.replace(/\(/g,"[");return e=e.replace(/\)/g,"]"),e=e.replace(/ /g,","),e=e.replace(/c/g,'"c"'),JSON.parse(e)}static fromNode_(t){if(!t)return[];const e=t.contentNodes;let n;e.length&&(n=e.map(Ea.fromNode_),n.unshift("c"));const r=t.childNodes;if(!r.length)return e.length?[t.id,n]:t.id;const s=r.map(Ea.fromNode_);return e.length&&s.unshift(n),s.unshift(t.id),s}static tree_(t,e,n=0,r=1,s=1){if(!e)return[];const o=e.id,i=[o],c=O(`.//self::*[@${fa.ID}=${o}]`,t)[0];if(!e.childNodes.length)return Ea.addAria(c,n,r,s),e.id;const a=Ea.combineContentChildren(e,e.contentNodes.map((function(t){return t})),e.childNodes.map((function(t){return t})));c&&Ea.addOwns_(c,a);for(let e,r=0,s=a.length;e=a[r];r++)i.push(Ea.tree_(t,e,n+1,r+1,s));return Ea.addAria(c,n,r,s,n?"group":"tree"),i}static addAria(t,e,n,r,s=(e?"treeitem":"tree")){E.getInstance().aria&&t&&(t.setAttribute("aria-level",e.toString()),t.setAttribute("aria-posinset",n.toString()),t.setAttribute("aria-setsize",r.toString()),t.setAttribute("role",s),t.hasAttribute(fa.OWNS)&&t.setAttribute("aria-owns",t.getAttribute(fa.OWNS)))}static addOwns_(t,e){const n=t.getAttribute(fa.COLLAPSED),r=n?Ea.realLeafs_(Ea.fromString(n).array):e.map((t=>t.id));t.setAttribute(fa.OWNS,r.join(" "))}static realLeafs_(t){if(Ea.simpleCollapseStructure(t))return[t];if(Ea.contentCollapseStructure(t))return[];let e=[];for(let n=1;n<t.length;n++)e=e.concat(Ea.realLeafs_(t[n]));return e}constructor(t){this.parents=null,this.levelsMap=null,t=0===t?t:t||[],this.array=t}populate(){this.parents&&this.levelsMap||(this.parents={},this.levelsMap={},this.populate_(this.array,this.array,[]))}toString(){return Ea.makeSexp_(this.array)}populate_(t,e,n){if(Ea.simpleCollapseStructure(t))return this.levelsMap[t]=e,void(this.parents[t]=t===n[0]?n.slice(1):n);const r=Ea.contentCollapseStructure(t)?t.slice(1):t,s=[r[0]].concat(n);for(let e=0,n=r.length;e<n;e++){const n=r[e];this.populate_(n,t,s)}}isRoot(t){return t===this.levelsMap[t][0]}directChildren(t){if(!this.isRoot(t))return[];return this.levelsMap[t].slice(1).map((t=>Ea.simpleCollapseStructure(t)?t:Ea.contentCollapseStructure(t)?t[1]:t[0]))}subtreeNodes(t){if(!this.isRoot(t))return[];const e=(t,n)=>{Ea.simpleCollapseStructure(t)?n.push(t):(Ea.contentCollapseStructure(t)&&(t=t.slice(1)),t.forEach((t=>e(t,n))))},n=this.levelsMap[t],r=[];return e(n.slice(1),r),r}}function ba(t,e,n){let r=null;if(!t.length)return r;const s=n[n.length-1],o=s&&s.length,i=e&&e.length,c=Is.getInstance();if(o&&i){if("infixop"===e[0].type&&"implicit"===e[0].role)return r=t.pop(),s.push(c.postfixNode_(s.pop(),t)),r;r=t.shift();const n=c.prefixNode_(e.shift(),t);return e.unshift(n),r}return o?(s.push(c.postfixNode_(s.pop(),t)),r):(i&&e.unshift(c.prefixNode_(e.shift(),t)),r)}function Aa(t,e,n){if(!e.length)return t;const r=t.pop(),s=e.shift(),o=n.shift();if(bs(s)){m.getInstance().output("Juxta Heuristic Case 2");const i=(r?[r,s]:[s]).concat(o);return Aa(t.concat(i),e,n)}if(!r)return m.getInstance().output("Juxta Heuristic Case 3"),Aa([s].concat(o),e,n);const i=o.shift();if(!i){m.getInstance().output("Juxta Heuristic Case 9");const o=dr.makeBranchNode("infixop",[r,e.shift()],[s],s.textContent);return o.role="implicit",Nr("combine_juxtaposition",o),e.unshift(o),Aa(t,e,n)}if(Qr(r)||Qr(i))return m.getInstance().output("Juxta Heuristic Case 4"),Aa(t.concat([r,s,i]).concat(o),e,n);let c=null;return bs(r)&&bs(i)?(m.getInstance().output("Juxta Heuristic Case 5"),r.contentNodes.push(s),r.contentNodes=r.contentNodes.concat(i.contentNodes),r.childNodes.push(i),r.childNodes=r.childNodes.concat(i.childNodes),i.childNodes.forEach((t=>t.parent=r)),s.parent=r,r.addMathmlNodes(s.mathml),r.addMathmlNodes(i.mathml),c=r):bs(r)?(m.getInstance().output("Juxta Heuristic Case 6"),r.contentNodes.push(s),r.childNodes.push(i),i.parent=r,s.parent=r,r.addMathmlNodes(s.mathml),r.addMathmlNodes(i.mathml),c=r):bs(i)?(m.getInstance().output("Juxta Heuristic Case 7"),i.contentNodes.unshift(s),i.childNodes.unshift(r),r.parent=i,s.parent=i,i.addMathmlNodes(s.mathml),i.addMathmlNodes(r.mathml),c=i):(m.getInstance().output("Juxta Heuristic Case 8"),c=dr.makeBranchNode("infixop",[r,i],[s],s.textContent),c.role="implicit"),t.push(c),Aa(t.concat(o),e,n)}function ya(t){return t.childNodes[0]&&t.childNodes[0].childNodes[0]&&"MPADDED"===B(t.childNodes[0])&&"MPADDED"===B(t.childNodes[0].childNodes[0])&&"MPHANTOM"===B(t.childNodes[0].childNodes[t.childNodes[0].childNodes.length-1])}Sr(new ua("combine_juxtaposition",(function(t){for(let e,n=t.childNodes.length-1;e=t.childNodes[n];n--)bs(e)&&!e.nobreaking&&(t.childNodes.splice(n,1,...e.childNodes),t.contentNodes.splice(n,0,...e.contentNodes),e.childNodes.concat(e.contentNodes).forEach((function(e){e.parent=t})),t.addMathmlNodes(e.mathml));return t}))),Sr(new ua("propagateSimpleFunction",(t=>("infixop"!==t.type&&"fraction"!==t.type||!t.childNodes.every(ds)||(t.role="composed function"),t)),(t=>"clearspeak"===E.getInstance().domain))),Sr(new ua("simpleNamedFunction",(t=>("unit"!==t.role&&-1!==["f","g","h","F","G","H"].indexOf(t.textContent)&&(t.role="simple function"),t)),(t=>"clearspeak"===E.getInstance().domain))),Sr(new ua("propagateComposedFunction",(t=>("fenced"===t.type&&"composed function"===t.childNodes[0].role&&(t.role="composed function"),t)),(t=>"clearspeak"===E.getInstance().domain))),Sr(new ua("multioperator",(t=>{if("unknown"!==t.role||t.textContent.length<=1)return;const e=[...t.textContent].map((t=>cn.Meaning.get(t))).reduce((function(t,e){return t&&e.role&&"unknown"!==e.role&&e.role!==t?"unknown"===t?e.role:null:t}),"unknown");e&&(t.role=e)}))),Sr(new ha("convert_juxtaposition",(t=>{let e=Gr(t,(function(t){return t.textContent===on.invisibleTimes&&"operator"===t.type}));e=e.rel.length?function(t){const e=[],n=[];let r=t.comp.shift(),s=null,o=[];for(;t.comp.length;)if(o=[],r.length)s&&e.push(s),n.push(r),s=t.rel.shift(),r=t.comp.shift();else{for(s&&o.push(s);!r.length&&t.comp.length;)r=t.comp.shift(),o.push(t.rel.shift());s=ba(o,r,n)}o.length||r.length?(e.push(s),n.push(r)):(o.push(s),ba(o,r,n));return{rel:e,comp:n}}(e):e,t=e.comp[0];for(let n,r,s=1;n=e.comp[s],r=e.rel[s-1];s++)t.push(r),t=t.concat(n);return e=Gr(t,(function(t){return t.textContent===on.invisibleTimes&&("operator"===t.type||"infixop"===t.type)})),e.rel.length?Aa(e.comp.shift(),e.rel,e.comp):t}))),Sr(new ua("simple2prefix",(t=>(t.textContent.length>1&&!t.textContent[0].match(/[A-Z]/)&&(t.role="prefix function"),t)),(t=>"braille"===E.getInstance().modality&&"identifier"===t.type))),Sr(new ua("detect_cycle",(t=>{t.type="matrix",t.role="cycle";const e=t.childNodes[0];return e.type="row",e.role="cycle",e.textContent="",e.contentNodes=[],t}),(t=>"fenced"===t.type&&"infixop"===t.childNodes[0].type&&"implicit"===t.childNodes[0].role&&t.childNodes[0].childNodes.every((function(t){return"number"===t.type}))&&t.childNodes[0].contentNodes.every((function(t){return"space"===t.role}))))),Sr(new ha("intvar_from_implicit",(function(t){const e=t[0].childNodes;t.splice(0,1,...e)}),(t=>t[0]&&Es(t[0])))),Sr(new ua("intvar_from_fraction",(function(t){const e=t.childNodes[1],n=e.childNodes[0];if(zr(n))return void(n.role="integral");if(!Es(n))return;const r=n.childNodes.length,s=n.childNodes[r-2],o=n.childNodes[r-1];if(zr(o))return void(o.role="integral");if(Kr(s,o)){const t=Is.getInstance().prefixNode_(o,[s]);t.role="integral",2===r?e.childNodes[0]=t:(n.childNodes.pop(),n.contentNodes.pop(),n.childNodes[r-2]=t,t.parent=n)}}),(t=>{if("integral"!==t.type)return!1;const[,e,n]=t.childNodes;return"empty"===n.type&&"fraction"===e.type}))),Sr(new ua("rewrite_subcases",(function(t){t.addAnnotation("Emph","top");let e=[];if(t.hasAnnotation("Emph","left")){const n=Ca(t.childNodes[0].childNodes[0].childNodes[0],!0);n.forEach((t=>t.addAnnotation("Emph","left"))),e=e.concat(n);for(let e,n=0;e=t.childNodes[n];n++)e.childNodes.shift()}if(e.push(t),t.hasAnnotation("Emph","right")){const n=Ca(t.childNodes[0].childNodes[t.childNodes[0].childNodes.length-1].childNodes[0]);n.forEach((t=>t.addAnnotation("Emph","left"))),e=e.concat(n),t.childNodes[0].childNodes.pop()}Is.tableToMultiline(t);const n=Is.getInstance().row(e),r=t.annotation.Emph;return t.annotation.Emph=["table"],r.forEach((t=>n.addAnnotation("Emph",t))),n}),(t=>{let e=!0,n=!0;if(ya(t.childNodes[0].childNodes[0].mathmlTree)){for(let n,r=1;n=t.childNodes[r];r++)if(n.childNodes[0].childNodes.length){e=!1;break}}else e=!1;e&&t.addAnnotation("Emph","left");if(ya(t.childNodes[0].childNodes[t.childNodes[0].childNodes.length-1].mathmlTree)){const e=t.childNodes[0].childNodes.length;for(let r,s=1;r=t.childNodes[s];s++)if(r.childNodes.length>=e){n=!1;break}}else n=!1;return n&&t.addAnnotation("Emph","right"),e||n})));const Ta=["punctuated","relseq","multirel","infixop","prefixop","postfixop"];function Ca(t,e){if(!t.childNodes.length)return Ia(t),[t];let n=null;if("punctuated"===t.type&&(e?"endpunct"===t.role:"startpunct"===t.role)){const r=t.childNodes;Ia(r[e?r.length-1:0])&&(t=r[e?0:r.length-1],n=r[e?r.length-1:0])}if(-1!==Ta.indexOf(t.type)){const r=t.childNodes;Ia(r[e?r.length-1:0]);const s=Ea.combineContentChildren(t,t.contentNodes,t.childNodes);return n&&(e?s.push(n):s.unshift(n)),s}return n?e?[t,n]:[n,t]:[t]}const _a={metric:"metric",vbar:"neutral",openfence:"open",closefence:"close"};function Ia(t){if("punctuation"!==t.type)return!1;const e=_a[t.role];return!!e&&(t.role=e,t.type="fence",t.addAnnotation("Emph","fence"),!0)}class Oa{static empty(){const t=x("<math/>"),e=new Oa(t);return e.mathml=t,e}static fromNode(t,e){const n=Oa.empty();return n.root=t,e&&(n.mathml=e),n}static fromRoot(t,e){let n=t;for(;n.parent;)n=n.parent;const r=Oa.fromNode(n);return e&&(r.mathml=e),r}static fromXml(t){const e=Oa.empty();return t.childNodes[0]&&(e.root=$r.fromXml(t.childNodes[0])),e}constructor(t){this.mathml=t,this.parser=new aa,this.root=this.parser.parse(t),this.collator=this.parser.getFactory().leafMap.collateMeaning();const e=this.collator.newDefault();e&&(this.parser=new aa,this.parser.getFactory().defaultMap=e,this.root=this.parser.parse(t)),Ma.visit(this.root,{}),function(t){for(const e of Gn.values())e.active&&e.annotate(t);for(const e of $n.values())e.active&&e.visit(t,Object.assign({},e.def))}(this.root)}xml(t){const e=x("<stree></stree>"),n=this.root.xml(e.ownerDocument,t);return e.appendChild(n),e}toString(t){return $(this.xml(t))}formatXml(t){return D(this.toString(t))}displayTree(){this.root.displayTree()}replaceNode(t,e){const n=t.parent;n?n.replaceChild(t,e):this.root=e}toJson(){const t={};return t.stree=this.root.toJson(),t}}const Ma=new Bn("general","unit",((t,e)=>(Ns(t)&&(t.role="unit"),!1)));function Ra(t){return xa(t).xml()}function xa(t){return new Oa(t)}const La=[],va={collapsed:!0,implicit:!0,wiki:!0};function Fa(t){const e=function(t){for(let e,n=0;e=La[n];n++)if(e.test(t))return e.constr(t);return null}(t);let n;if(e)return n=e.getMathml(),Va(n);if(1===t.mathml.length){if(m.getInstance().output("Walktree Case 0"),!t.childNodes.length)return m.getInstance().output("Walktree Case 0.1"),n=t.mathml[0],ga(n,t),Va(n);const e=t.childNodes[0];if(1===t.childNodes.length&&"empty"===e.type)return m.getInstance().output("Walktree Case 0.2"),n=t.mathml[0],ga(n,t),n.appendChild(Fa(e)),Va(n);t.childNodes.forEach((t=>{t.mathml.length||(t.mathml=[Ja(t)])}))}const r=t.contentNodes.map(Ka);Za(t,r);const s=t.childNodes.map(Fa),o=Ea.combineContentChildren(t,r,s);if(n=t.mathmlTree,null===n)m.getInstance().output("Walktree Case 1"),n=wa(o,t);else{const t=Ga(o);m.getInstance().output("Walktree Case 2"),t?(m.getInstance().output("Walktree Case 2.1"),n=Ya(t)):(m.getInstance().output("Walktree Case 2.2"),n=Qa(n))}return n=za(n),function(t,e,n){if(!e.length)return;const r="implicit"===n.role&&mr.combine_juxtaposition?function(t,e,n){const r=[];let s=R(t.childNodes),o=!1;for(;s.length;){const t=s.shift();if(t.hasAttribute(fa.TYPE)){r.push(t);continue}const n=Da(t,e);0!==n.length&&(1!==n.length?(o?t.setAttribute("AuxiliaryImplicit",!0):o=!0,s=n.concat(s)):r.push(t))}const i=[],c=n.childNodes.map((function(t){return t.mathmlTree}));for(;c.length;){const t=c.pop();if(t){if(-1!==r.indexOf(t))break;-1!==e.indexOf(t)&&i.unshift(t)}}return r.concat(i)}(t,e,n):R(t.childNodes);if(!r.length)return void e.forEach((function(e){t.appendChild(e)}));let s=0;for(;e.length;){const n=e[0];if(r[s]===n||Ua(r[s],n)){e.shift(),s++;continue}if(r[s]&&-1===e.indexOf(r[s])){s++;continue}if(ka(n,t)){e.shift();continue}const o=r[s];if(o)Pa(t,o,n),e.shift();else{if(n.parentNode){t=Ya(n),e.shift();continue}const r=e[1];if(r&&r.parentNode){(t=Ya(r)).insertBefore(n,r),e.shift(),e.shift();continue}t.insertBefore(n,null),e.shift()}}}(n,o,t),ga(n,t),Va(n)}function wa(t,e){const n=function(t){const e=Ga(t);if(!e)return{type:Ba.INVALID,node:null};const n=Ga(t.slice().reverse());if(e===n)return{type:Ba.VALID,node:e};const r=$a(e),s=function(t,e){let n=0;for(;t[n]&&-1===e.indexOf(t[n]);)n++;return t.slice(0,n+1)}(r,t),o=$a(n,(function(t){return-1!==s.indexOf(t)})),i=o[0],c=s.indexOf(i);if(-1===c)return{type:Ba.INVALID,node:null};return{type:s.length!==r.length?Ba.PRUNED:ja(s[c+1],o[1])?Ba.VALID:Ba.INVALID,node:i}}(t);let r=n.node;const s=n.type;if(s!==Ba.VALID||!wr(r))if(m.getInstance().output("Walktree Case 1.1"),r=Na(),s===Ba.PRUNED)m.getInstance().output("Walktree Case 1.1.0"),r=function(t,e,n){let r=Ha(e);if(vr(r)){m.getInstance().output("Walktree Case 1.1.0.0"),function(t,e){for(const n of pa)t.hasAttribute(n)&&(e.setAttribute(n,t.getAttribute(n)),t.removeAttribute(n))}(r,t),R(r.childNodes).forEach((function(e){t.appendChild(e)}));const e=t;t=r,r=e}const s=n.indexOf(e);return n[s]=r,v(r,t),t.appendChild(r),n.forEach((function(e){t.appendChild(e)})),t}(r,n.node,t);else if(t[0]){m.getInstance().output("Walktree Case 1.1.1");const e=Ga(t),n=function(t,e){const n=R(t.childNodes);let r=1/0,s=-1/0;return e.forEach((function(t){const e=n.indexOf(t);-1!==e&&(r=Math.min(r,e),s=Math.max(s,e))})),n.slice(r,s+1)}(Ya(e),t);v(e,r),n.forEach((function(t){r.appendChild(t)}))}return e.mathmlTree||(e.mathmlTree=r),r}function Da(t,e){const n=[];let r=R(t.childNodes);for(;r.length;){const t=r.shift();t.nodeType===L.ELEMENT_NODE&&(t.hasAttribute(fa.TYPE)||-1!==e.indexOf(t)?n.push(t):r=R(t.childNodes).concat(r))}return n}function Pa(t,e,n){let r=e,s=Ya(r);for(;s&&s.firstChild===r&&!r.hasAttribute("AuxiliaryImplicit")&&s!==t;)r=s,s=Ya(r);s&&(s.insertBefore(n,r),r.removeAttribute("AuxiliaryImplicit"))}function ka(t,e){if(!t)return!1;do{if((t=Ya(t))===e)return!0}while(t);return!1}function Ua(t,e){const n=on.functionApplication;if(t&&e&&t.textContent&&e.textContent&&t.textContent===n&&e.textContent===n&&"true"===e.getAttribute(fa.ADDED)){for(let n,r=0;n=t.attributes[r];r++)e.hasAttribute(n.nodeName)||e.setAttribute(n.nodeName,n.nodeValue);return v(t,e),!0}return!1}var Ba;function Ga(t){let e=0,n=null;for(;!n&&e<t.length;)t[e].parentNode&&(n=t[e]),e++;return n}function $a(t,e){const n=e||(t=>!1),r=[t];for(;!n(t)&&!vr(t)&&t.parentNode;)t=Ya(t),r.unshift(t);return r}function ja(t,e){return!(!t||!e||t.previousSibling||e.nextSibling)}function Va(t){for(;!vr(t)&&Wa(t);)t=Ya(t);return t}function Ha(t){const e=R(t.childNodes);if(!e)return t;const n=e.filter((function(t){return t.nodeType===L.ELEMENT_NODE&&!Fr(t)}));return 1===n.length&&wr(n[0])&&!n[0].hasAttribute(fa.TYPE)?Ha(n[0]):t}function Wa(t){const e=Ya(t);return!(!e||!wr(e))&&R(e.childNodes).every((function(e){return e===t||qa(e)}))}function qa(t){if(t.nodeType!==L.ELEMENT_NODE)return!0;if(!t||Fr(t))return!0;const e=R(t.childNodes);return!(!wr(t)&&e.length||function(t){return!!t&&-1!==xr.indexOf(B(t))}(t)||t.hasAttribute(fa.TYPE)||Dr(t))&&R(t.childNodes).every(qa)}function Ya(t){return t.parentNode}function Xa(t,e){const n=new Ea(e);t.setAttribute(fa.COLLAPSED,n.toString())}function Ka(t){if(t.mathml.length)return Fa(t);const e=va.implicit?Ja(t):Na();return t.mathml=[e],e}function za(t){if("MFENCED"!==B(t))return t;const e=Na();for(let n,r=0;n=t.attributes[r];r++)-1===["open","close","separators"].indexOf(n.name)&&e.setAttribute(n.name,n.value);return R(t.childNodes).forEach((function(t){e.appendChild(t)})),v(t,e),e}function Ja(t){const e=F("mo"),n=(r=t.textContent,p.Z.document.createTextNode(r));var r;return e.appendChild(n),ga(e,t),e.setAttribute(fa.ADDED,"true"),e}function Za(t,e){const n=t.type+(t.textContent?","+t.textContent:"");e.forEach((function(t){Qa(t).setAttribute(fa.OPERATOR,n)}))}function Qa(t){const e=R(t.childNodes);if(!e)return t;const n=e.filter((function(t){return!qa(t)})),r=[];for(let t,e=0;t=n[e];e++)if(wr(t)){const e=Qa(t);e&&e!==t&&r.push(e)}else r.push(t);return 1===r.length?r[0]:t}function tl(t,e,n=!1){const r=D(t.toString()).toString().replace(new RegExp(da,"g"),"");return n?e+":\n```html\n"+r+"\n```\n":r}function el(t,e){const n=!!e,r=e||[],s=t.parent,o=t.contentNodes.map((function(t){return t.id}));o.unshift("c");const i=[t.id,o];for(let e,o=0;e=t.childNodes[o];o++){const t=Fa(e);r.push(t);const o=Qa(t);s&&!n&&o.setAttribute(fa.PARENT,s.id.toString()),i.push(e.id)}return i}!function(t){t.VALID="valid",t.INVALID="invalid",t.PRUNED="pruned"}(Ba||(Ba={}));class nl{constructor(t){this.semantic=t}}class rl extends nl{static test(t){return!t.mathmlTree&&"line"===t.type&&"binomial"===t.role}constructor(t){super(t),this.mml=t.mathmlTree}getMathml(){if(!this.semantic.childNodes.length)return this.mml;const t=this.semantic.childNodes[0];if(this.mml=Fa(t),this.mml.hasAttribute(fa.TYPE)){const t=Na();v(this.mml,t),t.appendChild(this.mml),this.mml=t}return ga(this.mml,this.semantic),this.mml}}class sl extends nl{static test(t){if(!t.mathmlTree||!t.childNodes.length)return!1;const e=B(t.mathmlTree),n=t.childNodes[0].role;return"MSUBSUP"===e&&"subsup"===n||"MUNDEROVER"===e&&"underover"===n}constructor(t){super(t),this.mml=t.mathmlTree}getMathml(){const t=this.semantic.childNodes[0],e=t.childNodes[0],n=this.semantic.childNodes[1],r=t.childNodes[1],s=Fa(n),o=Fa(e),i=Fa(r);return ga(this.mml,this.semantic),this.mml.setAttribute(fa.CHILDREN,ma([e,r,n])),[o,i,s].forEach((t=>Qa(t).setAttribute(fa.PARENT,this.mml.getAttribute(fa.ID)))),this.mml.setAttribute(fa.TYPE,t.role),Xa(this.mml,[this.semantic.id,[t.id,e.id,r.id],n.id]),this.mml}}class ol extends nl{static multiscriptIndex(t){return"punctuated"===t.type&&"dummy"===t.contentNodes[0].role?el(t):(Fa(t),t.id)}static createNone_(t){const e=F("none");return t&&ga(e,t),e.setAttribute(fa.ADDED,"true"),e}constructor(t){super(t),this.mml=t.mathmlTree}completeMultiscript(t,e){const n=R(this.mml.childNodes).slice(1);let r=0;const s=t=>{for(let e,s=0;e=t[s];s++){const t=n[r];if(t&&e===parseInt(Qa(t).getAttribute(fa.ID)))Qa(t).setAttribute(fa.PARENT,this.semantic.id.toString()),r++;else{const n=this.semantic.querySelectorAll((t=>t.id===e));this.mml.insertBefore(ol.createNone_(n[0]),t||null)}}};s(t),n[r]&&"MPRESCRIPTS"!==B(n[r])?this.mml.insertBefore(n[r],F("mprescripts")):r++,s(e)}}class il extends ol{static test(t){if(!t.mathmlTree)return!1;return"MMULTISCRIPTS"===B(t.mathmlTree)&&("superscript"===t.type||"subscript"===t.type)}constructor(t){super(t)}getMathml(){let t,e,n;if(ga(this.mml,this.semantic),this.semantic.childNodes[0]&&"subsup"===this.semantic.childNodes[0].role){const r=this.semantic.childNodes[0];t=r.childNodes[0],e=ol.multiscriptIndex(this.semantic.childNodes[1]),n=ol.multiscriptIndex(r.childNodes[1]);const s=[this.semantic.id,[r.id,t.id,n],e];Xa(this.mml,s),this.mml.setAttribute(fa.TYPE,r.role),this.completeMultiscript(Ea.interleaveIds(n,e),[])}else{t=this.semantic.childNodes[0],e=ol.multiscriptIndex(this.semantic.childNodes[1]);const n=[this.semantic.id,t.id,e];Xa(this.mml,n)}const r=Ea.collapsedLeafs(n||[],e);return Qa(Fa(t)).setAttribute(fa.PARENT,this.semantic.id.toString()),r.unshift(t.id),this.mml.setAttribute(fa.CHILDREN,r.join(",")),this.mml}}class cl extends ol{static test(t){return!!t.mathmlTree&&"tensor"===t.type}constructor(t){super(t)}getMathml(){Fa(this.semantic.childNodes[0]);const t=ol.multiscriptIndex(this.semantic.childNodes[1]),e=ol.multiscriptIndex(this.semantic.childNodes[2]),n=ol.multiscriptIndex(this.semantic.childNodes[3]),r=ol.multiscriptIndex(this.semantic.childNodes[4]);ga(this.mml,this.semantic);const s=[this.semantic.id,this.semantic.childNodes[0].id,t,e,n,r];Xa(this.mml,s);const o=Ea.collapsedLeafs(t,e,n,r);return o.unshift(this.semantic.childNodes[0].id),this.mml.setAttribute(fa.CHILDREN,o.join(",")),this.completeMultiscript(Ea.interleaveIds(n,r),Ea.interleaveIds(t,e)),this.mml}}class al extends nl{static test(t){return!(!t.mathmlTree||!t.fencePointer||t.mathmlTree.getAttribute("data-semantic-type"))}static makeEmptyNode_(t){const e=Na(),n=new $r(t);return n.type="empty",n.mathmlTree=e,n}static fencedMap_(t,e){e[t.id]=t.mathmlTree,t.embellished&&al.fencedMap_(t.childNodes[0],e)}constructor(t){super(t),this.fenced=null,this.fencedMml=null,this.fencedMmlNodes=[],this.ofence=null,this.ofenceMml=null,this.ofenceMap={},this.cfence=null,this.cfenceMml=null,this.cfenceMap={},this.parentCleanup=[]}getMathml(){this.getFenced_(),this.fencedMml=Fa(this.fenced),this.getFencesMml_(),"empty"!==this.fenced.type||this.fencedMml.parentNode||(this.fencedMml.setAttribute(fa.ADDED,"true"),this.cfenceMml.parentNode.insertBefore(this.fencedMml,this.cfenceMml)),this.getFencedMml_();return this.rewrite_()}fencedElement(t){return"fenced"===t.type||"matrix"===t.type||"vector"===t.type}getFenced_(){let t=this.semantic;for(;!this.fencedElement(t);)t=t.childNodes[0];this.fenced=t.childNodes[0],this.ofence=t.contentNodes[0],this.cfence=t.contentNodes[1],al.fencedMap_(this.ofence,this.ofenceMap),al.fencedMap_(this.cfence,this.cfenceMap)}getFencedMml_(){let t=this.ofenceMml.nextSibling;for(t=t===this.fencedMml?t:this.fencedMml;t&&t!==this.cfenceMml;)this.fencedMmlNodes.push(t),t=t.nextSibling}getFencesMml_(){let t=this.semantic;const e=Object.keys(this.ofenceMap),n=Object.keys(this.cfenceMap);for(;!(this.ofenceMml&&this.cfenceMml||t===this.fenced);)-1===e.indexOf(t.fencePointer)||this.ofenceMml||(this.ofenceMml=t.mathmlTree),-1===n.indexOf(t.fencePointer)||this.cfenceMml||(this.cfenceMml=t.mathmlTree),t=t.childNodes[0];this.ofenceMml||(this.ofenceMml=this.ofence.mathmlTree),this.cfenceMml||(this.cfenceMml=this.cfence.mathmlTree),this.ofenceMml&&(this.ofenceMml=Va(this.ofenceMml)),this.cfenceMml&&(this.cfenceMml=Va(this.cfenceMml))}rewrite_(){let t=this.semantic,e=null;const n=this.introduceNewLayer_();for(ga(n,this.fenced.parent);!this.fencedElement(t);){const r=t.mathmlTree,s=this.specialCase_(t,r);if(s)t=s;else{ga(r,t);const e=[];for(let n,r=1;n=t.childNodes[r];r++)e.push(Fa(n));t=t.childNodes[0]}const o=F("dummy"),i=r.childNodes[0];v(r,o),v(n,r),v(r.childNodes[0],n),v(o,i),e||(e=r)}return Fa(this.ofence),Fa(this.cfence),this.cleanupParents_(),e||n}specialCase_(t,e){const n=B(e);let r,s=null;if("MSUBSUP"===n?(s=t.childNodes[0],r=sl):"MMULTISCRIPTS"===n&&("superscript"===t.type||"subscript"===t.type?r=il:"tensor"===t.type&&(r=cl),s=r&&t.childNodes[0]&&"subsup"===t.childNodes[0].role?t.childNodes[0]:t),!s)return null;const o=s.childNodes[0],i=al.makeEmptyNode_(o.id);return s.childNodes[0]=i,e=new r(t).getMathml(),s.childNodes[0]=o,this.parentCleanup.push(e),s.childNodes[0]}introduceNewLayer_(){const t=this.fullFence(this.ofenceMml),e=this.fullFence(this.cfenceMml);let n=Na();if(v(this.fencedMml,n),this.fencedMmlNodes.forEach((t=>n.appendChild(t))),n.insertBefore(t,this.fencedMml),n.appendChild(e),!n.parentNode){const t=Na();for(;n.childNodes.length>0;)t.appendChild(n.childNodes[0]);n.appendChild(t),n=t}return n}fullFence(t){const e=this.fencedMml.parentNode;let n=t;for(;n.parentNode&&n.parentNode!==e;)n=n.parentNode;return n}cleanupParents_(){this.parentCleanup.forEach((function(t){const e=t.childNodes[1].getAttribute(fa.PARENT);t.childNodes[0].setAttribute(fa.PARENT,e)}))}}class ll extends nl{static test(t){return!!t.mathmlTree&&t.hasAnnotation("Emph","top")}constructor(t){super(t),this.mrows=[],this.mml=t.mathmlTree}getMathml(){if(this.recurseToTable(this.semantic),this.mrows.length){const t=Na();this.mml.parentNode.insertBefore(t,this.mml);for(const e of this.mrows)t.appendChild(e);t.appendChild(this.mml)}return this.mml}recurseToTable(t){var e,n;if(t.hasAnnotation("Emph","top")||t.hasAnnotation("Emph","fence")||!t.hasAnnotation("Emph","left")&&!t.hasAnnotation("Emph","right")){if(!t.mathmlTree||"MTABLE"===B(t.mathmlTree)&&(null===(e=t.annotation.Emph)||void 0===e?void 0:e.length)&&"table"!==t.annotation.Emph[0]){const e=Na();ga(e,t),this.mrows.unshift(e)}else{if("MTABLE"===B(t.mathmlTree)&&(null===(n=t.annotation.Emph)||void 0===n?void 0:n.length)&&"table"===t.annotation.Emph[0])return void this.finalizeTable(t);ga(t.mathmlTree,t)}if(t.childNodes.forEach(this.recurseToTable.bind(this)),t.textContent||"punctuated"===t.type){const e=t.contentNodes.map((t=>{const e=Ka(t);return e.hasAttribute("data-semantic-added")?this.mrows.unshift(e):this.recurseToTable(t),e}));Za(t,e)}else t.contentNodes.forEach(this.recurseToTable.bind(this))}else Fa(t)}finalizeTable(t){ga(t.mathmlTree,t),t.contentNodes.forEach((t=>{Fa(t)})),t.childNodes.forEach((t=>{Fa(t)}))}}class ul extends nl{static test(t){if(!t.mathmlTree||!t.childNodes.length)return!1;const e=B(t.mathmlTree),n=t.type;return("limupper"===n||"limlower"===n)&&("MSUBSUP"===e||"MUNDEROVER"===e)||"limboth"===n&&("MSUB"===e||"MUNDER"===e||"MSUP"===e||"MOVER"===e)}static walkTree_(t){t&&Fa(t)}constructor(t){super(t),this.mml=t.mathmlTree}getMathml(){const t=this.semantic.childNodes;return"limboth"!==this.semantic.type&&this.mml.childNodes.length>=3&&(this.mml=wa([this.mml],this.semantic)),ga(this.mml,this.semantic),t[0].mathmlTree||(t[0].mathmlTree=this.semantic.mathmlTree),t.forEach(ul.walkTree_),this.mml}}class hl extends nl{static test(t){return!!t.mathmlTree&&"line"===t.type}constructor(t){super(t),this.mml=t.mathmlTree}getMathml(){return this.semantic.contentNodes.length&&Fa(this.semantic.contentNodes[0]),this.semantic.childNodes.length&&Fa(this.semantic.childNodes[0]),ga(this.mml,this.semantic),this.mml}}class dl extends nl{static test(t){return!!t.mathmlTree&&("inference"===t.type||"premises"===t.type)}constructor(t){super(t),this.mml=t.mathmlTree}getMathml(){return this.semantic.childNodes.length?(this.semantic.contentNodes.forEach((function(t){Fa(t),ga(t.mathmlTree,t)})),this.semantic.childNodes.forEach((function(t){Fa(t)})),ga(this.mml,this.semantic),this.mml.getAttribute("data-semantic-id")===this.mml.getAttribute("data-semantic-parent")&&this.mml.removeAttribute("data-semantic-parent"),this.mml):this.mml}}class fl extends nl{static test(t){return"matrix"===t.type||"vector"===t.type||"cases"===t.type}constructor(t){super(t),this.inner=[],this.mml=t.mathmlTree}getMathml(){const t=Ka(this.semantic.contentNodes[0]),e=this.semantic.contentNodes[1]?Ka(this.semantic.contentNodes[1]):null;if(this.inner=this.semantic.childNodes.map(Fa),this.mml)if("MFENCED"===B(this.mml)){const n=this.mml.childNodes;this.mml.insertBefore(t,n[0]||null),e&&this.mml.appendChild(e),this.mml=za(this.mml)}else{const n=[t,this.mml];e&&n.push(e),this.mml=wa(n,this.semantic)}else this.mml=wa([t].concat(this.inner,[e]),this.semantic);return ga(this.mml,this.semantic),this.mml}}class pl extends nl{static test(t){return"punctuated"===t.type&&("text"===t.role||t.contentNodes.every((t=>"dummy"===t.role)))}constructor(t){super(t),this.mml=t.mathmlTree}getMathml(){const t=[],e=el(this.semantic,t);return this.mml=wa(t,this.semantic),ga(this.mml,this.semantic),this.mml.removeAttribute(fa.CONTENT),Xa(this.mml,e),this.mml}}function ml(t){const e=G(t);return function(t,e){const n=G(t);return Fa(e.root),E.getInstance().structure&&t.setAttribute(fa.STRUCTURE,Ea.fromStructure(t,e).toString()),m.getInstance().generateOutput((()=>[tl(n,"Original MathML",va.wiki),tl(e,"Semantic Tree",va.wiki),tl(t,"Semantically enriched MathML",va.wiki)])),t}(e,xa(e))}function gl(t){return ml(x(t))}La.push({test:ul.test,constr:t=>new ul(t)},{test:al.test,constr:t=>new al(t)},{test:sl.test,constr:t=>new sl(t)},{test:cl.test,constr:t=>new cl(t)},{test:il.test,constr:t=>new il(t)},{test:hl.test,constr:t=>new hl(t)},{test:rl.test,constr:t=>new rl(t)},{test:dl.test,constr:t=>new dl(t)},{test:ll.test,constr:t=>new ll(t)},{test:fl.test,constr:t=>new fl(t)},{test:pl.test,constr:t=>new pl(t)});let Sl=0;class Nl{constructor(){this.counter=Sl++,this.ATTR="sre-highlight-"+this.counter.toString(),this.color=null,this.mactionName="",this.currentHighlights=[]}highlight(t){this.currentHighlights.push(t.map((t=>{const e=this.highlightNode(t);return this.setHighlighted(t),e})))}highlightAll(t){const e=this.getMactionNodes(t);for(let t,n=0;t=e[n];n++)this.highlight([t])}unhighlight(){const t=this.currentHighlights.pop();t&&t.forEach((t=>{this.isHighlighted(t.node)&&(this.unhighlightNode(t),this.unsetHighlighted(t.node))}))}unhighlightAll(){for(;this.currentHighlights.length>0;)this.unhighlight()}setColor(t){this.color=t}colorString(){return this.color.rgba()}addEvents(t,e){const n=this.getMactionNodes(t);for(let t,r=0;t=n[r];r++)for(const[n,r]of Object.entries(e))t.addEventListener(n,r)}getMactionNodes(t){return Array.from(t.getElementsByClassName(this.mactionName))}isMactionNode(t){const e=t.className||t.getAttribute("class");return!!e&&!!e.match(new RegExp(this.mactionName))}isHighlighted(t){return t.hasAttribute(this.ATTR)}setHighlighted(t){t.setAttribute(this.ATTR,"true")}unsetHighlighted(t){t.removeAttribute(this.ATTR)}colorizeAll(t){M(t);O(`.//*[@${fa.ID}]`,t).forEach((t=>this.colorize(t)))}uncolorizeAll(t){O(`.//*[@${fa.ID}]`,t).forEach((t=>this.uncolorize(t)))}colorize(t){const e=Sa("foreground");t.hasAttribute(e)&&(t.setAttribute(e+"-old",t.style.color),t.style.color=t.getAttribute(e))}uncolorize(t){const e=Sa("foreground")+"-old";t.hasAttribute(e)&&(t.style.color=t.getAttribute(e))}}class El extends Nl{constructor(){super(),this.mactionName="mjx-maction"}highlightNode(t){const e={node:t,background:t.style.backgroundColor,foreground:t.style.color};if(!this.isHighlighted(t)){const e=this.colorString();t.style.backgroundColor=e.background,t.style.color=e.foreground}return e}unhighlightNode(t){t.node.style.backgroundColor=t.background,t.node.style.color=t.foreground}}const bl={red:{red:255,green:0,blue:0},green:{red:0,green:255,blue:0},blue:{red:0,green:0,blue:255},yellow:{red:255,green:255,blue:0},cyan:{red:0,green:255,blue:255},magenta:{red:255,green:0,blue:255},white:{red:255,green:255,blue:255},black:{red:0,green:0,blue:0}};function Al(t,e){const n=t||{color:e};let r=Object.prototype.hasOwnProperty.call(n,"color")?bl[n.color]:n;return r||(r=bl[e]),r.alpha=Object.prototype.hasOwnProperty.call(n,"alpha")?n.alpha:1,function(t){const e=t=>(t=Math.max(t,0),t=Math.min(255,t),Math.round(t));return t.red=e(t.red),t.green=e(t.green),t.blue=e(t.blue),t.alpha=Math.max(t.alpha,0),t.alpha=Math.min(1,t.alpha),t}(r)}class yl{static toHex(t){const e=t.toString(16);return 1===e.length?"0"+e:e}constructor(t,e){this.foreground=Al(e,yl.DEFAULT_FOREGROUND_),this.background=Al(t,yl.DEFAULT_BACKGROUND_)}rgba(){const t=function(t){return"rgba("+t.red+","+t.green+","+t.blue+","+t.alpha+")"};return{background:t(this.background),foreground:t(this.foreground)}}rgb(){const t=function(t){return"rgb("+t.red+","+t.green+","+t.blue+")"};return{background:t(this.background),alphaback:this.background.alpha.toString(),foreground:t(this.foreground),alphafore:this.foreground.alpha.toString()}}hex(){const t=function(t){return"#"+yl.toHex(t.red)+yl.toHex(t.green)+yl.toHex(t.blue)};return{background:t(this.background),alphaback:this.background.alpha.toString(),foreground:t(this.foreground),alphafore:this.foreground.alpha.toString()}}}yl.DEFAULT_BACKGROUND_="blue",yl.DEFAULT_FOREGROUND_="black";class Tl{constructor(){this.hue=10,this.sat=100,this.light=50,this.incr=50}generate(){return e=function(t,e,n){e=e>1?e/100:e,n=n>1?n/100:n;const r=(1-Math.abs(2*n-1))*e,s=r*(1-Math.abs(t/60%2-1)),o=n-r/2;let i=0,c=0,a=0;return 0<=t&&t<60?[i,c,a]=[r,s,0]:60<=t&&t<120?[i,c,a]=[s,r,0]:120<=t&&t<180?[i,c,a]=[0,r,s]:180<=t&&t<240?[i,c,a]=[0,s,r]:240<=t&&t<300?[i,c,a]=[s,0,r]:300<=t&&t<360&&([i,c,a]=[r,0,s]),{red:i+o,green:c+o,blue:a+o}}(this.hue,this.sat,this.light),"rgb("+(t={red:Math.round(255*e.red),green:Math.round(255*e.green),blue:Math.round(255*e.blue)}).red+","+t.green+","+t.blue+")";var t,e}increment(){this.hue=(this.hue+this.incr)%360}}class Cl extends Nl{constructor(){super(),this.mactionName="mjx-svg-maction"}highlightNode(t){let e;if(this.isHighlighted(t))return e={node:t.previousSibling||t,background:t.style.backgroundColor,foreground:t.style.color},e;if("svg"===t.tagName){const e={node:t,background:t.style.backgroundColor,foreground:t.style.color};return t.style.backgroundColor=this.colorString().background,t.style.color=this.colorString().foreground,e}const n=w("http://www.w3.org/2000/svg","rect");let r;if("use"===t.nodeName){const e=w("http://www.w3.org/2000/svg","g");t.parentNode.insertBefore(e,t),e.appendChild(t),r=e.getBBox(),e.parentNode.replaceChild(t,e)}else r=t.getBBox();n.setAttribute("x",(r.x-40).toString()),n.setAttribute("y",(r.y-40).toString()),n.setAttribute("width",(r.width+80).toString()),n.setAttribute("height",(r.height+80).toString());const s=t.getAttribute("transform");return s&&n.setAttribute("transform",s),n.setAttribute("fill",this.colorString().background),n.setAttribute(this.ATTR,"true"),t.parentNode.insertBefore(n,t),e={node:n,foreground:t.getAttribute("fill")},t.setAttribute("fill",this.colorString().foreground),e}setHighlighted(t){"svg"===t.tagName&&super.setHighlighted(t)}unhighlightNode(t){if("background"in t)return t.node.style.backgroundColor=t.background,void(t.node.style.color=t.foreground);t.foreground?t.node.nextSibling.setAttribute("fill",t.foreground):t.node.nextSibling.removeAttribute("fill"),t.node.parentNode.removeChild(t.node)}isMactionNode(t){let e=t.className||t.getAttribute("class");return!!e&&(e=void 0!==e.baseVal?e.baseVal:e,!!e&&!!e.match(new RegExp(this.mactionName)))}}function _l(t,e,n){const r=new yl(t,e),s="NativeMML"===n.renderer&&"Safari"===n.browser?"MML-CSS":"SVG"===n.renderer&&"v3"===n.browser?"SVG-V3":n.renderer,o=new(Ol[s]||Ol.NativeMML);return o.setColor(r),o}function Il(t,e,n){const r=new yl(t,e);n.setColor(r)}const Ol={SVG:Cl,"SVG-V3":class extends Cl{constructor(){super(),this.mactionName="maction"}highlightNode(t){let e;if(this.isHighlighted(t))return e={node:t,background:this.colorString().background,foreground:this.colorString().foreground},e;if("svg"===t.tagName||"MJX-CONTAINER"===t.tagName)return e={node:t,background:t.style.backgroundColor,foreground:t.style.color},t.style.backgroundColor=this.colorString().background,t.style.color=this.colorString().foreground,e;const n=w("http://www.w3.org/2000/svg","rect");n.setAttribute("sre-highlighter-added","true");const r=t.getBBox();n.setAttribute("x",(r.x-40).toString()),n.setAttribute("y",(r.y-40).toString()),n.setAttribute("width",(r.width+80).toString()),n.setAttribute("height",(r.height+80).toString());const s=t.getAttribute("transform");if(s&&n.setAttribute("transform",s),n.setAttribute("fill",this.colorString().background),t.setAttribute(this.ATTR,"true"),t.parentNode.insertBefore(n,t),e={node:t,foreground:t.getAttribute("fill")},"rect"===t.nodeName){const e=new yl({alpha:0,color:"black"});t.setAttribute("fill",e.rgba().foreground)}else t.setAttribute("fill",this.colorString().foreground);return e}unhighlightNode(t){const e=t.node.previousSibling;if(e&&e.hasAttribute("sre-highlighter-added"))return t.foreground?t.node.setAttribute("fill",t.foreground):t.node.removeAttribute("fill"),void t.node.parentNode.removeChild(e);t.node.style.backgroundColor=t.background,t.node.style.color=t.foreground}isMactionNode(t){return t.getAttribute("data-mml-node")===this.mactionName}getMactionNodes(t){return Array.from(O(`.//*[@data-mml-node="${this.mactionName}"]`,t))}},NativeMML:class extends Nl{constructor(){super(),this.mactionName="maction"}highlightNode(t){let e=t.getAttribute("style");return e+=";background-color: "+this.colorString().background,e+=";color: "+this.colorString().foreground,t.setAttribute("style",e),{node:t}}unhighlightNode(t){let e=t.node.getAttribute("style");e=e.replace(";background-color: "+this.colorString().background,""),e=e.replace(";color: "+this.colorString().foreground,""),t.node.setAttribute("style",e)}colorString(){return this.color.rgba()}getMactionNodes(t){return Array.from(t.getElementsByTagName(this.mactionName))}isMactionNode(t){return t.tagName===this.mactionName}},"HTML-CSS":class extends Nl{constructor(){super(),this.mactionName="maction"}highlightNode(t){const e={node:t,foreground:t.style.color,position:t.style.position},n=this.color.rgb();t.style.color=n.foreground,t.style.position="relative";const r=t.bbox;if(r&&r.w){const s=.05,o=0,i=F("span"),c=parseFloat(t.style.paddingLeft||"0");i.style.backgroundColor=n.background,i.style.opacity=n.alphaback.toString(),i.style.display="inline-block",i.style.height=r.h+r.d+2*s+"em",i.style.verticalAlign=-r.d+"em",i.style.marginTop=i.style.marginBottom=-s+"em",i.style.width=r.w+2*o+"em",i.style.marginLeft=c-o+"em",i.style.marginRight=-r.w-o-c+"em",t.parentNode.insertBefore(i,t),e.box=i}return e}unhighlightNode(t){const e=t.node;e.style.color=t.foreground,e.style.position=t.position,t.box&&t.box.parentNode.removeChild(t.box)}},"MML-CSS":class extends El{constructor(){super(),this.mactionName="maction"}getMactionNodes(t){return Array.from(t.getElementsByTagName(this.mactionName))}isMactionNode(t){return t.tagName===this.mactionName}},CommonHTML:El,CHTML:class extends El{constructor(){super()}isMactionNode(t){return t.tagName.toUpperCase()===this.mactionName.toUpperCase()}getMactionNodes(t){return Array.from(t.getElementsByTagName(this.mactionName))}}};function Ml(t){return t?t.split(/,/):[]}function Rl(t,e){return t.getAttribute(e)}function xl(t){if(t.hasAttribute(fa.TYPE)&&!t.hasAttribute(fa.PARENT))return t;const e=function(t,e){return t.querySelectorAll?R(t.querySelectorAll(`[${e}]`)):O(`.//*[@${e}]`,t)}(t,fa.TYPE);for(let t,n=0;t=e[n];n++)if(!t.hasAttribute(fa.PARENT))return t;return t}function Ll(t,e){return t.getAttribute(fa.ID)===e?t:k(t,fa.ID,e)[0]}function vl(t,e){return t.getAttribute(fa.ID)===e?[t]:k(t,fa.ID,e)}class Fl{static textContent(t,e,n){if(!n&&e.textContent)return void(t.textContent=e.textContent);const r=Ml(Rl(e,fa.OPERATOR));r.length>1&&(t.textContent=r[1])}static isPunctuated(t){return!Ea.simpleCollapseStructure(t)&&t[1]&&Ea.contentCollapseStructure(t[1])}constructor(t){this.mathml=t,this.factory=new jr,this.nodeDict={},this.mmlRoot=xl(t),this.streeRoot=this.assembleTree(this.mmlRoot),this.stree=Oa.fromNode(this.streeRoot,this.mathml),this.xml=this.stree.xml(),Is.getInstance().setNodeFactory(this.factory)}getTree(){return this.stree}assembleTree(t){const e=this.makeNode(t),n=Ml(Rl(t,fa.CHILDREN)),r=Ml(Rl(t,fa.CONTENT));if(0===r.length&&0===n.length)return Fl.textContent(e,t),e;if(r.length>0){const t=Ll(this.mathml,r[0]);t&&Fl.textContent(e,t,!0)}e.contentNodes=r.map((t=>this.setParent(t,e))),e.childNodes=n.map((t=>this.setParent(t,e)));const s=Rl(t,fa.COLLAPSED);return s?this.postProcess(e,s):e}makeNode(t){const e=Rl(t,fa.TYPE),n=Rl(t,fa.ROLE),r=Rl(t,fa.FONT),s=Rl(t,fa.ANNOTATION)||"",o=Rl(t,fa.ATTRIBUTES)||"",i=Rl(t,fa.ID),c=Rl(t,fa.EMBELLISHED),a=Rl(t,fa.FENCEPOINTER),l=this.createNode(parseInt(i,10));return l.type=e,l.role=n,l.font=r||nn.UNKNOWN,l.parseAnnotation(s),l.parseAttributes(o),a&&(l.fencePointer=a),c&&(l.embellished=c),l}makePunctuation(t){const e=this.createNode(t);return e.updateContent(on.invisibleComma),e.role="dummy",e}makePunctuated(t,e,n){const r=this.createNode(e[0]);r.type="punctuated",r.embellished=t.embellished,r.fencePointer=t.fencePointer,r.role=n;const s=e.splice(1,1)[0].slice(1);r.contentNodes=s.map(this.makePunctuation.bind(this)),this.collapsedChildren_(e)}makeEmpty(t,e,n){const r=this.createNode(e);r.type="empty",r.embellished=t.embellished,r.fencePointer=t.fencePointer,r.role=n}makeIndex(t,e,n){if(Fl.isPunctuated(e))return this.makePunctuated(t,e,n),void(e=e[0]);Ea.simpleCollapseStructure(e)&&!this.nodeDict[e.toString()]&&this.makeEmpty(t,e,n)}postProcess(t,e){const n=Ea.fromString(e).array;if("subsup"===t.type){const e=this.createNode(n[1][0]);return e.type="subscript",e.role="subsup",t.type="superscript",e.embellished=t.embellished,e.fencePointer=t.fencePointer,this.makeIndex(t,n[1][2],"rightsub"),this.makeIndex(t,n[2],"rightsuper"),this.collapsedChildren_(n),t}if("subscript"===t.type)return this.makeIndex(t,n[2],"rightsub"),this.collapsedChildren_(n),t;if("superscript"===t.type)return this.makeIndex(t,n[2],"rightsuper"),this.collapsedChildren_(n),t;if("tensor"===t.type)return this.makeIndex(t,n[2],"leftsub"),this.makeIndex(t,n[3],"leftsuper"),this.makeIndex(t,n[4],"rightsub"),this.makeIndex(t,n[5],"rightsuper"),this.collapsedChildren_(n),t;if("punctuated"===t.type){if(Fl.isPunctuated(n)){const e=n.splice(1,1)[0].slice(1);t.contentNodes=e.map(this.makePunctuation.bind(this))}return t}if("underover"===t.type){const e=this.createNode(n[1][0]);return"overaccent"===t.childNodes[1].role?(e.type="overscore",t.type="underscore"):(e.type="underscore",t.type="overscore"),e.role="underover",e.embellished=t.embellished,e.fencePointer=t.fencePointer,this.collapsedChildren_(n),t}return t}createNode(t){const e=this.factory.makeNode(t);return this.nodeDict[t.toString()]=e,e}collapsedChildren_(t){const e=t=>{const n=this.nodeDict[t[0]];n.childNodes=[];for(let r=1,s=t.length;r<s;r++){const s=t[r];n.childNodes.push(Ea.simpleCollapseStructure(s)?this.nodeDict[s]:e(s))}return n};e(t)}setParent(t,e){const n=Ll(this.mathml,t),r=this.assembleTree(n);return r.parent=e,r}}function wl(t){return Zi.getInstance().evaluateNode(t)}function Dl(t){return oa(wl(t))}function Pl(t){const e=function(t){return wl(Oa.fromNode(t).xml())}(t);return oa(e)}function kl(t,e,n){const r=k(n,"id",e.id.toString())[0],s=r?oa(wl(r)):Pl(e);t.setAttribute(fa.SPEECH,s)}function Ul(t,e,n){const r=Pl(e);t.setAttribute(n,r)}function Bl(t,e){const n=Gl(e);n&&t.setAttribute(fa.PREFIX,n)}function Gl(t){const e=function(t){const e=Oa.fromRoot(t),n=O('.//*[@id="'+t.id+'"]',e.xml());let r=n[0];n.length>1&&(r=function(t,e){const n=e[0];if(!t.parent)return n;const r=[];for(;t;)r.push(t.id),t=t.parent;const s=function(t,e){for(;e.length&&e.shift().toString()===t.getAttribute("id")&&t.parentNode&&t.parentNode.parentNode;)t=t.parentNode.parentNode;return!e.length};for(let t,n=0;t=e[n];n++)if(s(t,r.slice()))return t;return n}(t,n)||r);return r?Zi.getInstance().runInSetting({modality:"prefix",domain:"default",style:"default",strict:!0,speech:!0},(function(){return Zi.getInstance().evaluateNode(r)})):[]}(t);return oa(e)}function $l(t){const e=function(t){return t?Zi.getInstance().runInSetting({modality:"summary",strict:!1,speech:!0},(function(){return Zi.getInstance().evaluateNode(t)})):[]}(t);return oa(e)}class jl{constructor(){this.modality=Sa("speech"),this.rebuilt_=null,this.options_={}}getRebuilt(){return this.rebuilt_}setRebuilt(t){this.rebuilt_=t}setOptions(t){this.options_=t||{},this.modality=Sa(this.options_.modality||"speech")}getOptions(){return this.options_}start(){}end(){}generateSpeech(t,e){return this.rebuilt_||(this.rebuilt_=new Fl(e)),Ec(this.options_),Dl(this.getRebuilt().xml)}}class Vl extends jl{getSpeech(t,e){const n=this.generateSpeech(t,e);return t.setAttribute(this.modality,n),n}}class Hl extends jl{constructor(){super(...arguments),this.modality=Sa("foreground"),this.contrast=new Tl}static visitStree_(t,e,n){if(t.childNodes.length){if(t.contentNodes.length&&("punctuated"===t.type&&t.contentNodes.forEach((t=>n[t.id]=!0)),"implicit"!==t.role&&e.push(t.contentNodes.map((t=>t.id)))),t.childNodes.length){if("implicit"===t.role){const r=[];let s=[];for(const e of t.childNodes){const t=[];Hl.visitStree_(e,t,n),t.length<=2&&r.push(t.shift()),s=s.concat(t)}return e.push(r),void s.forEach((t=>e.push(t)))}t.childNodes.forEach((t=>Hl.visitStree_(t,e,n)))}}else n[t.id]||e.push(t.id)}getSpeech(t,e){return Rl(t,this.modality)}generateSpeech(t,e){return this.getRebuilt()||this.setRebuilt(new Fl(x(e))),this.colorLeaves_(t),Rl(t,this.modality)}colorLeaves_(t){const e=[];Hl.visitStree_(this.getRebuilt().streeRoot,e,{});for(const n of e){const e=this.contrast.generate();let r=!1;r=Array.isArray(n)?n.map((n=>this.colorLeave_(t,n,e))).reduce(((t,e)=>t||e),!1):this.colorLeave_(t,n.toString(),e),r&&this.contrast.increment()}}colorLeave_(t,e,n){const r=Ll(t,e);return!!r&&(r.setAttribute(this.modality,n),!0)}}class Wl extends jl{getSpeech(t,e){return Rl(t,this.modality)}}class ql extends jl{getSpeech(t,e){return""}}class Yl extends jl{getSpeech(t,e,n=null){const r=this.generateSpeech(t,e),s=this.getRebuilt().nodeDict;for(const[r,o]of Object.entries(s)){const s=Ll(e,r),i=Ll(t,r)||n&&Ll(n,r);s&&i&&(this.modality&&this.modality!==fa.SPEECH?Ul(i,o,this.modality):kl(i,o,this.getRebuilt().xml),this.modality===fa.SPEECH&&Bl(i,o))}return r}}class Xl extends Yl{getSpeech(t,e){return super.getSpeech(t,e),Rl(t,this.modality)}}class Kl extends jl{getSpeech(t,e){return function(t,e){const n=U(t,"maction");for(let t,r=0;t=n[r];r++){const n=t.childNodes[1].getAttribute(fa.ID);k(e,"id",n)[0].setAttribute("alternative",n)}}(e,this.getRebuilt().xml),this.generateSpeech(t,e)}}function zl(t){return(Jl[t]||Jl.Direct)()}const Jl={Adhoc:()=>new Vl,Color:()=>new Hl,Direct:()=>new Wl,Dummy:()=>new ql,Node:()=>new Xl,Summary:()=>new Kl,Tree:()=>new Yl};class Zl extends c{static comparator(){return new tu(E.getInstance().dynamicCstr,i.createProp([c.DEFAULT_VALUES[r.LOCALE]],[c.DEFAULT_VALUES[r.MODALITY]],[c.DEFAULT_VALUES[r.DOMAIN]],[c.DEFAULT_VALUES[r.STYLE]]))}static fromPreference(t){const e=t.split(":"),n={},r=Ql.getProperties(),s=Object.keys(r);for(let t,o=0;t=e[o];o++){const e=t.split("_");if(-1===s.indexOf(e[0]))continue;const o=e[1];o&&o!==Zl.AUTO&&-1!==r[e[0]].indexOf(o)&&(n[e[0]]=e[1])}return n}static toPreference(t){const e=Object.keys(t),n=[];for(let r=0;r<e.length;r++)n.push(e[r]+"_"+t[e[r]]);return n.length?n.join(":"):c.DEFAULT_VALUE}static getLocalePreferences(t){const e=t||function(t={}){for(const e of An.values())for(const[,n]of e.rules.entries())for(const{cstr:e}of n)t=xn(e.getValues(),t);return t}(Zi.getInstance().enumerate());return Zl.getLocalePreferences_(e)}static currentPreference(){return f.clearspeak}static relevantPreferences(t){const e=nu[t.type];return e&&(e[t.role]||e[""])||"ImpliedTimes"}static findPreference(t,e){if("default"===t)return Zl.AUTO;return Zl.fromPreference(t)[e]||Zl.AUTO}static addPreference(t,e,n){if("default"===t)return e+"_"+n;const r=Zl.fromPreference(t);return r[e]=n,Zl.toPreference(r)}static getLocalePreferences_(t){const e={};for(const n of Object.keys(t)){if(!t[n].speech||!t[n].speech.clearspeak)continue;const r=Object.keys(t[n].speech.clearspeak);if(r.length<3)continue;const s=e[n]={};for(const t in Ql.getProperties()){const e=Ql.getProperties()[t],n=[t+"_Auto"];if(e)for(const s of e)-1!==r.indexOf(t+"_"+s)&&n.push(t+"_"+s);s[t]=n}}return e}constructor(t,e){super(t),this.preference=e}equal(t){if(!super.equal(t))return!1;const e=Object.keys(this.preference),n=t.preference;if(e.length!==Object.keys(n).length)return!1;for(let t,r=0;t=e[r];r++)if(this.preference[t]!==n[t])return!1;return!0}}Zl.AUTO="Auto";const Ql=new i({AbsoluteValue:["Auto","AbsEnd","Cardinality","Determinant"],Bar:["Auto","Conjugate"],Caps:["Auto","SayCaps"],CombinationPermutation:["Auto","ChoosePermute"],Currency:["Auto","Position","Prefix"],Ellipses:["Auto","AndSoOn"],Enclosed:["Auto","EndEnclose"],Exponent:["Auto","AfterPower","Ordinal","OrdinalPower","Exponent"],Fraction:["Auto","EndFrac","FracOver","General","GeneralEndFrac","Ordinal","Over","OverEndFrac","Per"],Functions:["Auto","None","Reciprocal"],ImpliedTimes:["Auto","MoreImpliedTimes","None"],Log:["Auto","LnAsNaturalLog"],Matrix:["Auto","Combinatoric","EndMatrix","EndVector","SilentColNum","SpeakColNum","Vector"],MultiLineLabel:["Auto","Case","Constraint","Equation","Line","None","Row","Step"],MultiLineOverview:["Auto","None"],MultiLinePausesBetweenColumns:["Auto","Long","Short"],MultsymbolDot:["Auto","Dot"],MultsymbolX:["Auto","By","Cross"],Paren:["Auto","CoordPoint","Interval","Silent","Speak","SpeakNestingLevel"],Prime:["Auto","Angle","Length"],Roots:["Auto","PosNegSqRoot","PosNegSqRootEnd","RootEnd"],SetMemberSymbol:["Auto","Belongs","Element","Member","In"],Sets:["Auto","SilentBracket","woAll"],TriangleSymbol:["Auto","Delta"],Trig:["Auto","ArcTrig","TrigInverse","Reciprocal"],VerticalLine:["Auto","Divides","Given","SuchThat"]});class tu extends l{constructor(t,e){super(t,e),this.preference=t instanceof Zl?t.preference:{}}match(t){if(!(t instanceof Zl))return super.match(t);if("default"===t.getComponents()[r.STYLE])return!0;const e=Object.keys(t.preference);for(let n,r=0;n=e[r];r++)if(this.preference[n]!==t.preference[n])return!1;return!0}compare(t,e){const n=super.compare(t,e);if(0!==n)return n;const r=t instanceof Zl,s=e instanceof Zl;if(!r&&s)return 1;if(r&&!s)return-1;if(!r&&!s)return 0;const o=Object.keys(t.preference).length,i=Object.keys(e.preference).length;return o>i?-1:o<i?1:0}}const eu=[["AbsoluteValue","fenced","neutral","metric"],["Bar","overscore","overaccent"],["Caps","identifier","latinletter"],["CombinationPermutation","appl","unknown"],["Ellipses","punctuation","ellipsis"],["Exponent","superscript",""],["Fraction","fraction",""],["Functions","appl","simple function"],["ImpliedTimes","operator","implicit"],["Log","appl","prefix function"],["Matrix","matrix",""],["Matrix","vector",""],["MultiLineLabel","multiline","label"],["MultiLineOverview","multiline","table"],["MultiLinePausesBetweenColumns","multiline","table"],["MultiLineLabel","table","label"],["MultiLineOverview","table","table"],["MultiLinePausesBetweenColumns","table","table"],["MultiLineLabel","cases","label"],["MultiLineOverview","cases","table"],["MultiLinePausesBetweenColumns","cases","table"],["MultsymbolDot","operator","multiplication"],["MultsymbolX","operator","multiplication"],["Paren","fenced","leftright"],["Prime","superscript","prime"],["Roots","root",""],["Roots","sqrt",""],["SetMemberSymbol","relation","element"],["Sets","fenced","set extended"],["TriangleSymbol","identifier","greekletter"],["Trig","appl","prefix function"],["VerticalLine","punctuated","vbar"]],nu=function(){const t={};for(let e,n=0;e=eu[n];n++){const n=e[0];let r=t[e[1]];r||(r={},t[e[1]]=r),r[e[2]]=n}return t}();E.getInstance().comparators.clearspeak=Zl.comparator,E.getInstance().parsers.clearspeak=new class extends a{constructor(){super([r.LOCALE,r.MODALITY,r.DOMAIN,r.STYLE])}parse(t){const e=super.parse(t);let n=e.getValue(r.STYLE);const s=e.getValue(r.LOCALE),o=e.getValue(r.MODALITY);let i={};return n!==c.DEFAULT_VALUE&&(i=this.fromPreference(n),n=this.toPreference(i)),new Zl({locale:s,modality:o,domain:"clearspeak",style:n},i)}fromPreference(t){return Zl.fromPreference(t)}toPreference(t){return Zl.toPreference(t)}};class ru{static factory(t,e,n,r){const s=t=>Ll(r,t),o=n.nodeDict,i=s(t),c=e.map(s),a=e.map((function(t){return o[t]})),l=new ru(a,o[t]);return l.domNodes=c,l.domPrimary_=i,l.allNodes=ru.generateAllVisibleNodes_(e,c,o,r),l}static generateAllVisibleNodes_(t,e,n,r){let s=[];for(let o=0,i=t.length;o<i;o++){if(e[o]){const n=ru.getAllVisibleNodes([t[o]],r);n.length?s=s.concat(n):s.push(e[o]);continue}const i=n[t[o]];if(!i)continue;const c=i.childNodes.map((t=>t.id.toString())),a=ru.getAllVisibleNodes(c,r);s=s.concat(ru.generateAllVisibleNodes_(c,a,n,r))}return s}static getAllVisibleNodes(t,e){let n=[];for(const r of t)n=n.concat(vl(e,r));return n}constructor(t,e){this.nodes=t,this.primary=e,this.domNodes=[],this.domPrimary_=null,this.allNodes=[]}getSemanticPrimary(){return this.primary}getSemanticNodes(){return this.nodes}getNodes(){return this.allNodes}getDomNodes(){return this.domNodes}getDomPrimary(){return this.domPrimary_}toString(){return"Primary:"+this.domPrimary_+" Nodes:"+this.domNodes}clone(){const t=new ru(this.nodes,this.primary);return t.domNodes=this.domNodes,t.domPrimary_=this.domPrimary_,t.allNodes=this.allNodes,t}}var su;!function(t){t.UP="up",t.DOWN="down",t.LEFT="left",t.RIGHT="right",t.REPEAT="repeat",t.DEPTH="depth",t.ENTER="enter",t.EXPAND="expand",t.HOME="home",t.SUMMARY="summary",t.DETAIL="detail",t.ROW="row",t.CELL="cell"}(su||(su={}));class ou{static resetState(t){delete ou.STATE[t]}static setState(t,e){ou.STATE[t]=e}static getState(t){return ou.STATE[t]}}ou.STATE={};class iu{constructor(t,e,n,r){this.node=t,this.generator=e,this.highlighter=n,this.modifier=!1,this.keyMapping=new Map([[Sc.UP,this.up.bind(this)],[Sc.DOWN,this.down.bind(this)],[Sc.RIGHT,this.right.bind(this)],[Sc.LEFT,this.left.bind(this)],[Sc.TAB,this.repeat.bind(this)],[Sc.DASH,this.expand.bind(this)],[Sc.SPACE,this.depth.bind(this)],[Sc.HOME,this.home.bind(this)],[Sc.X,this.summary.bind(this)],[Sc.Z,this.detail.bind(this)],[Sc.V,this.virtualize.bind(this)],[Sc.P,this.previous.bind(this)],[Sc.U,this.undo.bind(this)],[Sc.LESS,this.previousRules.bind(this)],[Sc.GREATER,this.nextRules.bind(this)]]),this.cursors=[],this.xml_=null,this.rebuilt_=null,this.focus_=null,this.active_=!1,this.node.id?this.id=this.node.id:this.node.hasAttribute(iu.SRE_ID_ATTR)?this.id=this.node.getAttribute(iu.SRE_ID_ATTR):(this.node.setAttribute(iu.SRE_ID_ATTR,iu.ID_COUNTER.toString()),this.id=iu.ID_COUNTER++),this.rootNode=xl(t),this.rootId=this.rootNode.getAttribute(fa.ID),this.xmlString_=r,this.moved=su.ENTER}getXml(){return this.xml_||(this.xml_=x(this.xmlString_)),this.xml_}getRebuilt(){return this.rebuilt_||this.rebuildStree(),this.rebuilt_}isActive(){return this.active_}activate(){this.isActive()||(this.generator.start(),this.toggleActive_())}deactivate(){this.isActive()&&(ou.setState(this.id,this.primaryId()),this.generator.end(),this.toggleActive_())}getFocus(t=!1){return null===this.rootId&&this.getRebuilt(),this.focus_||(this.focus_=this.singletonFocus(this.rootId)),t&&this.updateFocus(),this.focus_}setFocus(t){this.focus_=t}getDepth(){return this.levels.depth()-1}isSpeech(){return this.generator.modality===fa.SPEECH}focusDomNodes(){return this.getFocus().getDomNodes()}focusSemanticNodes(){return this.getFocus().getSemanticNodes()}speech(){const t=this.focusDomNodes();if(!t.length)return"";const e=this.specialMove();if(null!==e)return e;switch(this.moved){case su.DEPTH:return this.depth_();case su.SUMMARY:return this.summary_();case su.DETAIL:return this.detail_();default:{const e=[],n=this.focusSemanticNodes();for(let r=0,s=t.length;r<s;r++){const s=t[r],o=n[r];e.push(s?this.generator.getSpeech(s,this.getXml(),this.node):Pl(o))}return this.mergePrefix_(e)}}}move(t){const e=this.keyMapping.get(t);if(!e)return null;const n=e();return!(!n||n===this.getFocus())&&(this.setFocus(n),this.moved===su.HOME&&(this.levels=this.initLevels()),!0)}up(){return this.moved=su.UP,this.getFocus()}down(){return this.moved=su.DOWN,this.getFocus()}left(){return this.moved=su.LEFT,this.getFocus()}right(){return this.moved=su.RIGHT,this.getFocus()}repeat(){return this.moved=su.REPEAT,this.getFocus().clone()}depth(){return this.moved=this.isSpeech()?su.DEPTH:su.REPEAT,this.getFocus().clone()}home(){this.moved=su.HOME;return this.singletonFocus(this.rootId)}getBySemanticId(t){return Ll(this.node,t)}primaryId(){return this.getFocus().getSemanticPrimary().id.toString()}expand(){const t=this.getFocus().getDomPrimary(),e=this.actionable_(t);return e?(this.moved=su.EXPAND,e.dispatchEvent(new Event("click")),this.getFocus().clone()):this.getFocus()}expandable(t){return!!this.actionable_(t)&&0===t.childNodes.length}collapsible(t){return!!this.actionable_(t)&&t.childNodes.length>0}restoreState(){if(!this.highlighter)return;const t=ou.getState(this.id);if(!t)return;let e=this.getRebuilt().nodeDict[t];const n=[];for(;e;)n.push(e.id),e=e.parent;for(n.pop();n.length>0;){this.down();const t=n.pop(),e=this.findFocusOnLevel(t);if(!e)break;this.setFocus(e)}this.moved=su.ENTER}updateFocus(){this.setFocus(ru.factory(this.getFocus().getSemanticPrimary().id.toString(),this.getFocus().getSemanticNodes().map((t=>t.id.toString())),this.getRebuilt(),this.node))}rebuildStree(){this.rebuilt_=new Fl(this.getXml()),this.rootId=this.rebuilt_.stree.root.id.toString(),this.generator.setRebuilt(this.rebuilt_),this.skeleton=Ea.fromTree(this.rebuilt_.stree),this.skeleton.populate(),this.focus_=this.singletonFocus(this.rootId),this.levels=this.initLevels(),function(t,e,n){const r=U(e,"maction");for(let e,s=0;e=r[s];s++){const r=k(t,"id",e.getAttribute("id"))[0];if(!r)continue;const s=e.childNodes[1],o=s.getAttribute(fa.ID);let i=Ll(t,o);if(i&&"dummy"!==i.getAttribute(fa.TYPE))continue;if(i=r.childNodes[0],i.getAttribute("sre-highlighter-added"))continue;const c=s.getAttribute(fa.PARENT);c&&i.setAttribute(fa.PARENT,c),i.setAttribute(fa.TYPE,"dummy"),i.setAttribute(fa.ID,o),k(n,"id",o)[0].setAttribute("alternative",o)}}(this.node,this.getXml(),this.rebuilt_.xml)}previousLevel(){const t=this.getFocus().getDomPrimary();return t?Rl(t,fa.PARENT):this.getFocus().getSemanticPrimary().parent.id.toString()}nextLevel(){const t=this.getFocus().getDomPrimary();let e,n;if(t){e=Ml(Rl(t,fa.CHILDREN)),n=Ml(Rl(t,fa.CONTENT));const r=Rl(t,fa.TYPE),s=Rl(t,fa.ROLE);return this.combineContentChildren(r,s,n,e)}const r=t=>t.id.toString(),s=this.getRebuilt().nodeDict[this.primaryId()];return e=s.childNodes.map(r),n=s.contentNodes.map(r),0===e.length?[]:this.combineContentChildren(s.type,s.role,n,e)}singletonFocus(t){this.getRebuilt();const e=this.retrieveVisuals(t);return this.focusFromId(t,e)}retrieveVisuals(t){if(!this.skeleton)return[t];const e=parseInt(t,10),n=this.skeleton.subtreeNodes(e);if(!n.length)return[t];n.unshift(e);const r={},s=[];M(this.getXml());for(const t of n)r[t]||(s.push(t.toString()),r[t]=!0,this.subtreeIds(t,r));return s}subtreeIds(t,e){const n=O(`//*[@data-semantic-id="${t}"]`,this.getXml());O("*//@data-semantic-id",n[0]).forEach((t=>e[parseInt(t.textContent,10)]=!0))}focusFromId(t,e){return ru.factory(t,e,this.getRebuilt(),this.node)}summary(){return this.moved=this.isSpeech()?su.SUMMARY:su.REPEAT,this.getFocus().clone()}detail(){return this.moved=this.isSpeech()?su.DETAIL:su.REPEAT,this.getFocus().clone()}specialMove(){return null}virtualize(t){return this.cursors.push({focus:this.getFocus(),levels:this.levels,undo:t||!this.cursors.length}),this.levels=this.levels.clone(),this.getFocus().clone()}previous(){const t=this.cursors.pop();return t?(this.levels=t.levels,t.focus):this.getFocus()}undo(){let t;do{t=this.cursors.pop()}while(t&&!t.undo);return t?(this.levels=t.levels,t.focus):this.getFocus()}update(t){this.generator.setOptions(t),Ec(t).then((()=>zl("Tree").getSpeech(this.node,this.getXml())))}nextRules(){const t=this.generator.getOptions();return"speech"!==t.modality?this.getFocus():(f[t.domain]=t.style,t.domain="mathspeak"===t.domain?"clearspeak":"mathspeak",t.style=f[t.domain],this.update(t),this.moved=su.REPEAT,this.getFocus().clone())}nextStyle(t,e){if("mathspeak"===t){const t=["default","brief","sbrief"],n=t.indexOf(e);return-1===n?e:n>=t.length-1?t[0]:t[n+1]}if("clearspeak"===t){const t=Zl.getLocalePreferences().en;if(!t)return"default";const n=Zl.relevantPreferences(this.getFocus().getSemanticPrimary()),r=Zl.findPreference(e,n),s=t[n].map((function(t){return t.split("_")[1]})),o=s.indexOf(r);if(-1===o)return e;const i=o>=s.length-1?s[0]:s[o+1];return Zl.addPreference(e,n,i)}return e}previousRules(){const t=this.generator.getOptions();return"speech"!==t.modality?this.getFocus():(t.style=this.nextStyle(t.domain,t.style),this.update(t),this.moved=su.REPEAT,this.getFocus().clone())}refocus(){let t,e=this.getFocus();for(;!e.getNodes().length;){t=this.levels.peek();const n=this.up();if(!n)break;this.setFocus(n),e=this.getFocus(!0)}this.levels.push(t),this.setFocus(e)}toggleActive_(){this.active_=!this.active_}mergePrefix_(t,e=[]){const n=this.isSpeech()?this.prefix_():"";n&&t.unshift(n);const r=this.isSpeech()?this.postfix_():"";return r&&t.push(r),ia(function(t){const e=t.map((t=>"string"==typeof t?Ln.stringEmpty(t):t)),n=sa.get(E.getInstance().markup);return n?n.merge(e):t.join()}(e.concat(t)))}prefix_(){const t=this.getFocus().getDomNodes(),e=this.getFocus().getSemanticNodes();return t[0]?Rl(t[0],fa.PREFIX):Gl(e[0])}postfix_(){const t=this.getFocus().getDomNodes();return t[0]?Rl(t[0],fa.POSTFIX):""}depth_(){const t=nt.getInstance().getParameter("depth");nt.getInstance().setParameter("depth",!0);const e=this.getFocus().getDomPrimary(),n=this.expandable(e)?K.MESSAGES.navigate.EXPANDABLE:this.collapsible(e)?K.MESSAGES.navigate.COLLAPSIBLE:"",r=K.MESSAGES.navigate.LEVEL+" "+this.getDepth(),s=Gl(this.getFocus().getSemanticNodes()[0]),o=[new vn({text:r,personality:{}}),new vn({text:s,personality:{}}),new vn({text:n,personality:{}})];return nt.getInstance().setParameter("depth",t),ia(oa(o))}actionable_(t){const e=null==t?void 0:t.parentNode;return e&&this.highlighter.isMactionNode(e)?e:null}summary_(){const t=this.getFocus().getSemanticPrimary().id.toString(),e=$l(this.getRebuilt().xml.getAttribute("id")===t?this.getRebuilt().xml:k(this.getRebuilt().xml,"id",t)[0]);return this.mergePrefix_([e])}detail_(){const t=this.getFocus().getSemanticPrimary().id.toString(),e=this.getRebuilt().xml.getAttribute("id")===t?this.getRebuilt().xml:k(this.getRebuilt().xml,"id",t)[0],n=e.getAttribute("alternative");e.removeAttribute("alternative");const r=Dl(e),s=this.mergePrefix_([r]);return e.setAttribute("alternative",n),s}}iu.ID_COUNTER=0,iu.SRE_ID_ATTR="sre-explorer-id";class cu extends iu{up(){return null}down(){return null}left(){return null}right(){return null}repeat(){return null}depth(){return null}home(){return null}getDepth(){return 0}initLevels(){return null}combineContentChildren(t,e,n,r){return[]}findFocusOnLevel(t){return null}}class au{constructor(){this.level_=[]}push(t){this.level_.push(t)}pop(){return this.level_.pop()}peek(){return this.level_[this.level_.length-1]||null}indexOf(t){const e=this.peek();return e?e.indexOf(t):null}find(t){const e=this.peek();if(!e)return null;for(let n=0,r=e.length;n<r;n++)if(t(e[n]))return e[n];return null}get(t){const e=this.peek();return!e||t<0||t>=e.length?null:e[t]}depth(){return this.level_.length}clone(){const t=new au;return t.level_=this.level_.slice(0),t}toString(){let t="";for(let e,n=0;e=this.level_[n];n++)t+="\n"+e.map((function(t){return t.toString()}));return t}}class lu extends iu{constructor(t,e,n,r){super(t,e,n,r),this.node=t,this.generator=e,this.highlighter=n,this.levels=null,this.restoreState()}initLevels(){const t=new au;return t.push([this.getFocus()]),t}up(){super.up();const t=this.previousLevel();if(!t)return null;this.levels.pop();return this.levels.find((function(e){return e.getSemanticNodes().some((function(e){return e.id.toString()===t}))}))}down(){super.down();const t=this.nextLevel();return 0===t.length?null:(this.levels.push(t),t[0])}combineContentChildren(t,e,n,r){switch(t){case"relseq":case"infixop":case"multirel":return this.makePairList(r,n);case"prefixop":return[this.focusFromId(r[0],n.concat(r))];case"postfixop":return[this.focusFromId(r[0],r.concat(n))];case"matrix":case"vector":case"fenced":return[this.focusFromId(r[0],[n[0],r[0],n[1]])];case"cases":return[this.focusFromId(r[0],[n[0],r[0]])];case"punctuated":return"text"===e?r.map(this.singletonFocus.bind(this)):r.length===n.length?n.map(this.singletonFocus.bind(this)):this.combinePunctuations(r,n,[],[]);case"appl":return[this.focusFromId(r[0],[r[0],n[0]]),this.singletonFocus(r[1])];case"root":return[this.singletonFocus(r[1]),this.singletonFocus(r[0])];default:return r.map(this.singletonFocus.bind(this))}}combinePunctuations(t,e,n,r){if(0===t.length)return r;const s=t.shift(),o=e.shift();return s===o?(n.push(o),this.combinePunctuations(t,e,n,r)):(e.unshift(o),n.push(s),t.length===e.length?(r.push(this.focusFromId(s,n.concat(e))),r):(r.push(this.focusFromId(s,n)),this.combinePunctuations(t,e,[],r)))}makePairList(t,e){if(0===t.length)return[];if(1===t.length)return[this.singletonFocus(t[0])];const n=[this.singletonFocus(t.shift())];for(let r=0,s=t.length;r<s;r++)n.push(this.focusFromId(t[r],[e[r],t[r]]));return n}left(){super.left();const t=this.levels.indexOf(this.getFocus());if(null===t)return null;const e=this.levels.get(t-1);return e||null}right(){super.right();const t=this.levels.indexOf(this.getFocus());if(null===t)return null;const e=this.levels.get(t+1);return e||null}findFocusOnLevel(t){return this.levels.find((e=>e.getSemanticPrimary().id===t))}}class uu extends iu{constructor(t,e,n,r){super(t,e,n,r),this.node=t,this.generator=e,this.highlighter=n,this.levels=null,this.restoreState()}initLevels(){const t=new au;return t.push([this.primaryId()]),t}up(){super.up();const t=this.previousLevel();return t?(this.levels.pop(),this.singletonFocus(t)):null}down(){super.down();const t=this.nextLevel();if(0===t.length)return null;const e=this.singletonFocus(t[0]);return e&&this.levels.push(t),e}combineContentChildren(t,e,n,r){switch(t){case"relseq":case"infixop":case"multirel":return ur(r,n);case"prefixop":return n.concat(r);case"postfixop":return r.concat(n);case"matrix":case"vector":case"fenced":return r.unshift(n[0]),r.push(n[1]),r;case"cases":return r.unshift(n[0]),r;case"punctuated":return"text"===e?ur(r,n):r;case"appl":return[r[0],n[0],r[1]];case"root":return[r[1],r[0]];default:return r}}left(){super.left();const t=this.levels.indexOf(this.primaryId());if(null===t)return null;const e=this.levels.get(t-1);return e?this.singletonFocus(e):null}right(){super.right();const t=this.levels.indexOf(this.primaryId());if(null===t)return null;const e=this.levels.get(t+1);return e?this.singletonFocus(e):null}findFocusOnLevel(t){return this.singletonFocus(t.toString())}focusDomNodes(){return[this.getFocus().getDomPrimary()]}focusSemanticNodes(){return[this.getFocus().getSemanticPrimary()]}}class hu extends uu{constructor(t,e,n,r){super(t,e,n,r),this.node=t,this.generator=e,this.highlighter=n,this.firstJump=null,this.key_=null,this.row_=0,this.currentTable_=null,this.keyMapping.set(Sc.ZERO,this.jumpCell.bind(this)),this.keyMapping.set(Sc.ONE,this.jumpCell.bind(this)),this.keyMapping.set(Sc.TWO,this.jumpCell.bind(this)),this.keyMapping.set(Sc.THREE,this.jumpCell.bind(this)),this.keyMapping.set(Sc.FOUR,this.jumpCell.bind(this)),this.keyMapping.set(Sc.FIVE,this.jumpCell.bind(this)),this.keyMapping.set(Sc.SIX,this.jumpCell.bind(this)),this.keyMapping.set(Sc.SEVEN,this.jumpCell.bind(this)),this.keyMapping.set(Sc.EIGHT,this.jumpCell.bind(this)),this.keyMapping.set(Sc.NINE,this.jumpCell.bind(this))}move(t){this.key_=t;const e=super.move(t);return this.modifier=!1,e}up(){return this.moved=su.UP,this.eligibleCell_()?this.verticalMove_(!1):super.up()}down(){return this.moved=su.DOWN,this.eligibleCell_()?this.verticalMove_(!0):super.down()}jumpCell(){if(!this.isInTable_()||null===this.key_)return this.getFocus();if(this.moved===su.ROW){this.moved=su.CELL;const t=this.key_-Sc.ZERO;return this.isLegalJump_(this.row_,t)?this.jumpCell_(this.row_,t):this.getFocus()}const t=this.key_-Sc.ZERO;return t>this.currentTable_.childNodes.length?this.getFocus():(this.row_=t,this.moved=su.ROW,this.getFocus().clone())}undo(){const t=super.undo();return t===this.firstJump&&(this.firstJump=null),t}eligibleCell_(){const t=this.getFocus().getSemanticPrimary();return this.modifier&&"cell"===t.type&&-1!==hu.ELIGIBLE_CELL_ROLES.indexOf(t.role)}verticalMove_(t){const e=this.previousLevel();if(!e)return null;const n=this.getFocus(),r=this.levels.indexOf(this.primaryId()),s=this.levels.pop(),o=this.levels.indexOf(e),i=this.levels.get(t?o+1:o-1);if(!i)return this.levels.push(s),null;this.setFocus(this.singletonFocus(i));const c=this.nextLevel();return c[r]?(this.levels.push(c),this.singletonFocus(c[r])):(this.setFocus(n),this.levels.push(s),null)}jumpCell_(t,e){this.firstJump?this.virtualize(!1):(this.firstJump=this.getFocus(),this.virtualize(!0));const n=this.currentTable_.id.toString();let r;do{r=this.levels.pop()}while(-1===r.indexOf(n));this.levels.push(r),this.setFocus(this.singletonFocus(n)),this.levels.push(this.nextLevel());const s=this.currentTable_.childNodes[t-1];return this.setFocus(this.singletonFocus(s.id.toString())),this.levels.push(this.nextLevel()),this.singletonFocus(s.childNodes[e-1].id.toString())}isLegalJump_(t,e){const n=k(this.getRebuilt().xml,"id",this.currentTable_.id.toString())[0];if(!n||n.hasAttribute("alternative"))return!1;const r=this.currentTable_.childNodes[t-1];if(!r)return!1;const s=k(n,"id",r.id.toString())[0];return!(!s||s.hasAttribute("alternative"))&&!(!r||!r.childNodes[e-1])}isInTable_(){let t=this.getFocus().getSemanticPrimary();for(;t;){if(-1!==hu.ELIGIBLE_TABLE_TYPES.indexOf(t.type))return this.currentTable_=t,!0;t=t.parent}return!1}}function du(t,e,n,r,s){return(fu[t.toLowerCase()]||fu.dummy)(e,n,r,s)}hu.ELIGIBLE_CELL_ROLES=["determinant","rowvector","binomial","squarematrix","multiline","matrix","vector","cases","table"],hu.ELIGIBLE_TABLE_TYPES=["multiline","matrix","vector","cases","table"];const fu={dummy:(t,e,n,r)=>new cu(t,e,n,r),semantic:(t,e,n,r)=>new lu(t,e,n,r),syntax:(t,e,n,r)=>new uu(t,e,n,r),table:(t,e,n,r)=>new hu(t,e,n,r)};class pu{static stringify_(t){return t?t.toString():t}constructor(t,e){this.name=t,this.process=e.processor,this.postprocess=e.postprocessor||((t,e)=>t),this.processor=this.postprocess?function(t){return this.postprocess(this.process(t),t)}:this.process,this.print=e.print||pu.stringify_,this.pprint=e.pprint||this.print}}pu.LocalState={walker:null,speechGenerator:null,highlighter:null};class mu extends pu{static getKey_(t){return"string"==typeof t?Sc[t.toUpperCase()]:t}constructor(t,e){super(t,e),this.key=e.key||mu.getKey_}}const gu=new Map;function Su(t){gu.set(t.name,t)}function Nu(t){const e=gu.get(t);if(!e)throw new S("Unknown processor "+t);return e}function Eu(t,e){const n=Nu(t);try{return n.processor(e)}catch(t){throw new S("Processing error for expression "+e)}}function bu(t,e){const n=Nu(t);try{const t=n.processor(e);return E.getInstance().pprint?n.pprint(t):n.print(t)}catch(t){throw console.log(t),new S("Processing error for expression "+e)}}Su(new pu("semantic",{processor:function(t){return Ra(x(t))},postprocessor:function(t,e){const n=E.getInstance().speech;if(n===h.NONE)return t;const r=G(t);let s=Dl(r);if(n===h.SHALLOW)return t.setAttribute("speech",ia(s)),t;const o=O(".//*[@id]",t),i=O(".//*[@id]",r);for(let t,e,n=0;t=o[n],e=i[n];n++)s=Dl(e),t.setAttribute("speech",ia(s));return t},pprint:function(t){return D(t.toString())}})),Su(new pu("speech",{processor:function(t){return ia(oa(wl(Ra(x(t)))))},pprint:function(t){const e=t.toString();return sa.get(E.getInstance().markup)instanceof kc?D(e):e}})),Su(new pu("json",{processor:function(t){return xa(x(t)).toJson()},postprocessor:function(t,e){const n=E.getInstance().speech;if(n===h.NONE)return t;const r=Ra(x(e)),s=Dl(r);if(n===h.SHALLOW)return t.stree.speech=ia(s),t;const o=t=>{const e=Dl(O(`.//*[@id=${t.id}]`,r)[0]);t.speech=ia(e),t.children&&t.children.forEach(o)};return o(t.stree),t},print:function(t){return JSON.stringify(t)},pprint:function(t){return JSON.stringify(t,null,2)}})),Su(new pu("description",{processor:function(t){return wl(Ra(x(t)))},print:function(t){return JSON.stringify(t)},pprint:function(t){return JSON.stringify(t,null,2)}})),Su(new pu("enriched",{processor:function(t){return gl(t)},postprocessor:function(t,e){const n=xl(t);let r;switch(E.getInstance().speech){case h.NONE:break;case h.SHALLOW:r=zl("Adhoc"),r.getSpeech(n,t);break;case h.DEEP:r=zl("Tree"),r.getSpeech(t,t)}return t},pprint:function(t){return D(t.toString())}})),Su(new pu("walker",{processor:function(t){const e=zl("Node");pu.LocalState.speechGenerator=e,e.setOptions({modality:E.getInstance().modality,locale:E.getInstance().locale,domain:E.getInstance().domain,style:E.getInstance().style}),pu.LocalState.highlighter=_l({color:"black"},{color:"white"},{renderer:"NativeMML"});const n=Eu("enriched",t),r=function(t,e){const n=Nu(t);return E.getInstance().pprint?n.pprint(e):n.print(e)}("enriched",n);return pu.LocalState.walker=du(E.getInstance().walker,n,e,pu.LocalState.highlighter,r),pu.LocalState.walker},print:function(t){return pu.LocalState.walker.speech()}})),Su(new mu("move",{processor:function(t){if(!pu.LocalState.walker)return null;return!1===pu.LocalState.walker.move(t)?function(t){const e=sa.get(E.getInstance().markup);return e?e.error(t):""}(t):pu.LocalState.walker.speech()}})),Su(new pu("number",{processor:function(t){const e=parseInt(t,10);return isNaN(e)?"":K.NUMBERS.numberToWords(e)}})),Su(new pu("ordinal",{processor:function(t){const e=parseInt(t,10);return isNaN(e)?"":K.NUMBERS.wordOrdinal(e)}})),Su(new pu("numericOrdinal",{processor:function(t){const e=parseInt(t,10);return isNaN(e)?"":K.NUMBERS.numericOrdinal(e)}})),Su(new pu("vulgar",{processor:function(t){const[e,n]=t.split("/").map((t=>parseInt(t,10)));return isNaN(e)||isNaN(n)?"":Eu("speech",`<mfrac><mn>${e}</mn><mn>${n}</mn></mfrac>`)}})),Su(new pu("latex",{processor:function(t){return"braille"===E.getInstance().modality&&"euro"===E.getInstance().locale||console.info("LaTeX input currently only works for Euro Braille output. Please use the latex-to-speech package from npm for general LaTeX input to SRE."),Eu("speech",`<math latex="${t}"></math>`)}}));var Au=function(t,e,n,r){return new(n||(n=Promise))((function(s,o){function i(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((r=r.apply(t,e||[])).next())}))};g.L.VERSION;function yu(t){return Au(this,void 0,void 0,(function*(){return Ec(t)}))}function Tu(){const t=["mode"].concat(E.STRING_FEATURES,E.BINARY_FEATURES),e=E.getInstance(),n={};return t.forEach((function(t){n[t]=e[t]})),n.json=p.Z.jsonPath,n.xpath=p.Z.WGXpath,n.rules=e.ruleSets.slice(),n}function Cu(){return Au(this,void 0,void 0,(function*(){return yu({}).then((()=>b.getall()))}))}const _u=hc;function Iu(t){return Mu("speech",t)}function Ou(t){return Mu("enriched",t)}function Mu(t,e){return Eu(t,e)}const Ru={};function xu(t,e,n){switch(E.getInstance().mode){case s.ASYNC:return function(t,e,n){return Au(this,void 0,void 0,(function*(){const r=yield p.Z.fs.promises.readFile(e,{encoding:"utf8"}),s=bu(t,r);if(n)try{p.Z.fs.promises.writeFile(n,s)}catch(t){throw new S("Can not write to file: "+n)}return s}))}(t,e,n);case s.SYNC:return function(t,e,n){const r=function(t){let e;try{e=p.Z.fs.readFileSync(t,{encoding:"utf8"})}catch(e){throw new S("Can not open file: "+t)}return e}(e),s=bu(t,r);if(n)try{p.Z.fs.writeFileSync(n,s)}catch(t){throw new S("Can not write to file: "+n)}return s}(t,e,n);default:throw new S(`Can process files in ${E.getInstance().mode} mode`)}}Ru.toSpeech=function(t,e){return xu("speech",t,e)},Ru.toSemantic=function(t,e){return xu("semantic",t,e)},Ru.toJson=function(t,e){return xu("json",t,e)},Ru.toDescription=function(t,e){return xu("description",t,e)},Ru.toEnriched=function(t,e){return xu("enriched",t,e)};p.Z.documentSupported?yu({mode:s.HTTP}).then((()=>yu({}))):yu({mode:s.SYNC}).then((()=>yu({mode:s.ASYNC})));const Lu=new Map;var vu,Fu=function(t,e,n,r){return new(n||(n=Promise))((function(s,o){function i(t){try{a(r.next(t))}catch(t){o(t)}}function c(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,c)}a((r=r.apply(t,e||[])).next())}))};!function(t){t.locales=g.L.LOCALES,t.sreReady=Cu,t.setupEngine=yu,t.engineSetup=Tu,t.toEnriched=Ou,t.toSpeech=Iu,t.clearspeakPreferences=Zl,t.getHighlighter=_l,t.updateHighlighter=Il,t.getSpeechGenerator=zl,t.getWalker=du,t.preloadLocales=function(t){return Fu(this,void 0,void 0,(function*(){const e=Lu.get(t);return e?new Promise(((t,n)=>t(JSON.stringify(e)))):_u()(t)}))}}(vu||(vu={}));const wu=vu.sreReady;E.getInstance().delay=!0;const Du=vu;MathJax.loader&&MathJax.loader.checkVersion("a11y/sre","4.0.0-beta.4","a11y"),n({_:{a11y:{sre:t}}});const Pu=MathJax._.components.package,ku=(Pu.PackageError,Pu.Package);if(MathJax.startup){let t=ku.resolvePath("[sre]",!1);if("undefined"!=typeof window)window.SREfeature={json:t};else{try{t=MathJax.config.loader.require.resolve(t+"/base.json").replace(/\/base\.json$/,"")}catch(t){}global.SREfeature={json:t}}}MathJax.startup&&(("undefined"!=typeof window?window:global).SREfeature.custom=t=>vu.preloadLocales(t))})()})();